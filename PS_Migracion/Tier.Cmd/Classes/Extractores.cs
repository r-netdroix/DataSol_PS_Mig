using MongoDB.Bson;
using MongoDB.Driver;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Tier.Cmd.Classes
{
    class Extractores
    {
        internal static void Extractor_PS_ALERTA(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_ALERTAS_NOTIFICACIONES");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_ALERTAS_NOTIFICACIONES = null;

            int Conteo_PROM = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_ALERTAS_NOTIFICACIONES_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_ALERTAS_NOTIFICACIONES = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Vol_PS = db.GetCollection<BsonDocument>("PS_ALERTAS_NOTIFICACIONES");
                FilterDefinitionBuilder<BsonDocument> builderPS_Alertas = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_Alertas = builderPS_Alertas.Empty;

                if (tipo == "")
                {
                    filterPS_Alertas = builderPS_Alertas.Or(builderPS_Alertas.Eq("Actualizacion_Extractor", "1"), !builderPS_Alertas.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    //filterPS_Alertas = builderPS_Alertas.And(
                    //       builderPS_Alertas.Eq("Fecha_extraccion", tipo),
                    //       builderPS_Alertas.Or(
                    //           builderPS_Alertas.Eq("Actualizacion_Extractor", "1"),
                    //           !builderPS_Alertas.Exists("Actualizacion_Extractor")
                    //           )
                    //       );
                    filterPS_Alertas = builderPS_Alertas.And(builderPS_Alertas.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_Alertas.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_Alertas = Vol_PS.Find(filterPS_Alertas).ToList();

                if (consulta_PS_Alertas != null && consulta_PS_Alertas.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_ALERTAS_NOTIFICACIONES encontrados " + consulta_PS_Alertas.Count.ToString());
                        foreach (BsonDocument itemPS_Alerta in consulta_PS_Alertas)
                        {
                            id_mongo = itemPS_Alerta.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_Alerta.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_Alerta.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_Alerta.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_Alerta.Contains("_id") ? !string.IsNullOrEmpty(itemPS_Alerta.GetValue("_id")?.ToString()) ? (itemPS_Alerta.GetValue("_id").ToString().Length > 30 ? itemPS_Alerta.GetValue("_id").ToString().Substring(0, 29) : itemPS_Alerta.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("fecha_creacion") && !itemPS_Alerta.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("fecha_creacion").ToString()) ? (itemPS_Alerta.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_Alerta.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_Alerta.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("usuario_modificacion") && !itemPS_Alerta.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("usuario_modificacion").ToString()) ? (itemPS_Alerta.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_Alerta.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_Alerta.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("fecha_actualizacion") && !itemPS_Alerta.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("fecha_actualizacion").ToString()) ? (itemPS_Alerta.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_Alerta.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_Alerta.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("fecha_modificacion") && !itemPS_Alerta.GetValue("fecha_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("fecha_modificacion").ToString()) ? (itemPS_Alerta.GetValue("fecha_modificacion").ToString().Length > 30 ? itemPS_Alerta.GetValue("fecha_modificacion").ToString().Substring(0, 30) : itemPS_Alerta.GetValue("fecha_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("id_usuario") ? !string.IsNullOrEmpty(itemPS_Alerta.GetValue("id_usuario")?.ToString()) ? (itemPS_Alerta.GetValue("id_usuario").ToString().Length > 30 ? itemPS_Alerta.GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_Alerta.GetValue("id_usuario").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("descripcion") && !itemPS_Alerta.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_Alerta.GetValue("descripcion").ToString()) ? (itemPS_Alerta.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_Alerta.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_Alerta.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("texto_alerta") && !itemPS_Alerta.GetValue("texto_alerta").IsBsonNull ? !string.IsNullOrEmpty(itemPS_Alerta.GetValue("texto_alerta").ToString()) ? (itemPS_Alerta.GetValue("texto_alerta").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_Alerta.GetValue("texto_alerta").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_Alerta.GetValue("texto_alerta").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("visto") && !itemPS_Alerta.GetValue("visto").IsBsonNull ? itemPS_Alerta.GetValue("visto").ToString().Length > 8 ? itemPS_Alerta.GetValue("visto").ToString().Substring(0, 8) : itemPS_Alerta.GetValue("visto").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("fecha_visto") && !itemPS_Alerta.GetValue("fecha_visto").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("fecha_visto").ToString()) ? (itemPS_Alerta.GetValue("fecha_visto").ToString().Length > 30 ? itemPS_Alerta.GetValue("fecha_visto").ToString().Substring(0, 30) : itemPS_Alerta.GetValue("fecha_visto").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("idSolicitud") && !itemPS_Alerta.GetValue("idSolicitud").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("idSolicitud").ToString()) ? (itemPS_Alerta.GetValue("idSolicitud").ToString().Length > 10 ? itemPS_Alerta.GetValue("idSolicitud").ToString().Substring(0, 10) : itemPS_Alerta.GetValue("idSolicitud").ToString()) : "") + //VARCHAR(40) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("tipo_solicitud") && !itemPS_Alerta.GetValue("tipo_solicitud").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("tipo_solicitud").ToString()) ? (itemPS_Alerta.GetValue("tipo_solicitud").ToString().Length > 10 ? itemPS_Alerta.GetValue("tipo_solicitud").ToString().Substring(0, 10) : itemPS_Alerta.GetValue("tipo_solicitud").ToString()) : "") + //VARCHAR(40) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_Alerta.Contains("idTareaSolicitud") && !itemPS_Alerta.GetValue("idTareaSolicitud").IsBsonNull && !string.IsNullOrEmpty(itemPS_Alerta.GetValue("idTareaSolicitud").ToString()) ? (itemPS_Alerta.GetValue("idTareaSolicitud").ToString().Length > 30 ? itemPS_Alerta.GetValue("idTareaSolicitud").ToString().Substring(0, 29) : itemPS_Alerta.GetValue("idTareaSolicitud").ToString()) : "");  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                           
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_ALERTAS_NOTIFICACIONES Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_ALERTAS_NOTIFICACIONES.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Vol_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_Alerta.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PROM++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_Alerta.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Vol_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_Alerta.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PROM++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_ALERTAS_NOTIFICACIONES ACTUALIZADA: " + itemPS_Alerta.GetValue("_id").ToString() + "Numero de PS_ALERTAS_NOTIFICACIONES actializadas: " + Conteo_PROM);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_ALERTAS_NOTIFICACIONES en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_ALERTAS_NOTIFICACIONES para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PROM > 0)
                        {
                            Archivo_PS_ALERTAS_NOTIFICACIONES.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_ALERTAS_NOTIFICACIONES_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_ALERTAS_NOTIFICACIONES entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_ALERTAS_NOTIFICACIONES.Close();
            }

        }

        internal static void Extractor_PS_APROBACION(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_APROBACION");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROBACION = null;

            int Conteo_PS_APROBACION = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_APROBACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROBACION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROBACION = db.GetCollection<BsonDocument>("PS_APROBACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROBACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROBACION = builderPS_APROBACION.Empty;

                if (tipo == "")
                {
                    filterPS_APROBACION = builderPS_APROBACION.Or(builderPS_APROBACION.Eq("Actualizacion_Extractor", "1"), !builderPS_APROBACION.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    //filterPS_Alertas = builderPS_Alertas.And(
                    //       builderPS_Alertas.Eq("Fecha_extraccion", tipo),
                    //       builderPS_Alertas.Or(
                    //           builderPS_Alertas.Eq("Actualizacion_Extractor", "1"),
                    //           !builderPS_Alertas.Exists("Actualizacion_Extractor")
                    //           )
                    //       );
                    filterPS_APROBACION = builderPS_APROBACION.And(builderPS_APROBACION.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_APROBACION.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_APROBACION = Col_PS_APROBACION.Find(filterPS_APROBACION).ToList();

                if (consulta_PS_APROBACION != null && consulta_PS_APROBACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROBACION encontrados " + consulta_PS_APROBACION.Count.ToString());
                        foreach (BsonDocument itemPS_APROBACION in consulta_PS_APROBACION)
                        {
                            id_mongo = itemPS_APROBACION.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_APROBACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_APROBACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_APROBACION.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_APROBACION.Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("_id")?.ToString()) ? (itemPS_APROBACION.GetValue("_id").ToString().Length > 30 ? itemPS_APROBACION.GetValue("_id").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("fecha_creacion") && !itemPS_APROBACION.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("fecha_creacion").ToString()) ? (itemPS_APROBACION.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_APROBACION.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_APROBACION.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("usuario_creacion") && !itemPS_APROBACION.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("usuario_creacion").ToString()) ? (itemPS_APROBACION.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_APROBACION.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_APROBACION.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("fecha_actualizacion") && !itemPS_APROBACION.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("fecha_actualizacion").ToString()) ? (itemPS_APROBACION.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_APROBACION.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_APROBACION.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("usuario_modificacion") && !itemPS_APROBACION.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("usuario_modificacion").ToString()) ? (itemPS_APROBACION.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_APROBACION.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_APROBACION.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("id_movimiento") && !itemPS_APROBACION.GetValue("id_movimiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("id_movimiento").ToString()) ? (itemPS_APROBACION.GetValue("id_movimiento").ToString().Length > 30 ? itemPS_APROBACION.GetValue("id_movimiento").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("id_movimiento").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("estado_inicial") && !itemPS_APROBACION.GetValue("estado_inicial").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("estado_inicial").ToString()) ? (itemPS_APROBACION.GetValue("estado_inicial").ToString().Length > 30 ? itemPS_APROBACION.GetValue("estado_inicial").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("estado_inicial").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("id_estado") && !itemPS_APROBACION.GetValue("id_estado").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("id_estado").ToString()) ? (itemPS_APROBACION.GetValue("id_estado").ToString().Length > 30 ? itemPS_APROBACION.GetValue("id_estado").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("id_estado").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("estado") && !itemPS_APROBACION.GetValue("estado").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("estado").ToString()) ? (itemPS_APROBACION.GetValue("estado").ToString().Length > 30 ? itemPS_APROBACION.GetValue("estado").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("estado").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("id_aprovisionamiento") && !itemPS_APROBACION.GetValue("id_aprovisionamiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("id_aprovisionamiento").ToString()) ? (itemPS_APROBACION.GetValue("id_aprovisionamiento").ToString().Length > 30 ? itemPS_APROBACION.GetValue("id_aprovisionamiento").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("id_aprovisionamiento").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("numero_orden") && !itemPS_APROBACION.GetValue("numero_orden").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("numero_orden").ToString()) ? (itemPS_APROBACION.GetValue("numero_orden").ToString().Length > 30 ? itemPS_APROBACION.GetValue("numero_orden").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("numero_orden").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("id_tipo_aprobacion") && !itemPS_APROBACION.GetValue("id_tipo_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("id_tipo_aprobacion").ToString()) ? (itemPS_APROBACION.GetValue("id_tipo_aprobacion").ToString().Length > 30 ? itemPS_APROBACION.GetValue("id_tipo_aprobacion").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("id_tipo_aprobacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("tipo_aprobacion") && !itemPS_APROBACION.GetValue("tipo_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("tipo_aprobacion").ToString()) ? (itemPS_APROBACION.GetValue("tipo_aprobacion").ToString().Length > 30 ? itemPS_APROBACION.GetValue("tipo_aprobacion").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("tipo_aprobacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_APROBACION.Contains("fecha_solicitud") && !itemPS_APROBACION.GetValue("fecha_solicitud").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("fecha_solicitud").ToString()) ? (itemPS_APROBACION.GetValue("fecha_solicitud").ToString().Length > 30 ? itemPS_APROBACION.GetValue("fecha_solicitud").ToString().Substring(0, 30) : itemPS_APROBACION.GetValue("fecha_solicitud").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("usuario_solicitud") && !itemPS_APROBACION.GetValue("usuario_solicitud").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("usuario_solicitud").ToString()) ? (itemPS_APROBACION.GetValue("usuario_solicitud").ToString().Length > 50 ? itemPS_APROBACION.GetValue("usuario_solicitud").ToString().Substring(0, 50) : itemPS_APROBACION.GetValue("usuario_solicitud").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("observacion") && !itemPS_APROBACION.GetValue("observacion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("observacion").ToString()) ? (itemPS_APROBACION.GetValue("observacion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_APROBACION.GetValue("observacion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_APROBACION.GetValue("observacion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("id_usuario") ? !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("id_usuario")?.ToString()) ? (itemPS_APROBACION.GetValue("id_usuario").ToString().Length > 30 ? itemPS_APROBACION.GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("id_usuario").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_APROBACION.Contains("texto_alerta") && !itemPS_APROBACION.GetValue("texto_alerta").IsBsonNull ? !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("texto_alerta").ToString()) ? (itemPS_APROBACION.GetValue("texto_alerta").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_APROBACION.GetValue("texto_alerta").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_APROBACION.GetValue("texto_alerta").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("color") && !itemPS_APROBACION.GetValue("color").IsBsonNull ? itemPS_APROBACION.GetValue("color").ToString().Length > 8 ? itemPS_APROBACION.GetValue("color").ToString().Substring(0, 8) : itemPS_APROBACION.GetValue("color").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_APROBACION.Contains("codigo_verificacion") && !itemPS_APROBACION.GetValue("codigo_verificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_APROBACION.GetValue("codigo_verificacion").ToString()) ? (itemPS_APROBACION.GetValue("codigo_verificacion").ToString().Length > 30 ? itemPS_APROBACION.GetValue("codigo_verificacion").ToString().Substring(0, 29) : itemPS_APROBACION.GetValue("codigo_verificacion").ToString()) : "");  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                           
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROBACION Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_APROBACION.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_APROBACION.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROBACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_APROBACION++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_APROBACION.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_APROBACION.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROBACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_APROBACION++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_APROBACION ACTUALIZADA: " + itemPS_APROBACION.GetValue("_id").ToString() + "Numero de PS_APROBACION actializadas: " + Conteo_PS_APROBACION);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROBACION en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROBACION para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_APROBACION > 0)
                        {
                            Archivo_PS_APROBACION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROBACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROBACION entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROBACION.Close();
            }

        }

        internal static void Extractor_PS_APROBACION_Usuario(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROBACION_Usuario");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROBACION = null;

            int Conteo_PS_APROBACION_Usuario = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_APROBACION_Usuario_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROBACION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROBACION = db.GetCollection<BsonDocument>("PS_APROBACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROBACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROBACION = builderPS_APROBACION.Empty;

                if (tipo == "")
                {
                    filterPS_APROBACION = builderPS_APROBACION.Or(builderPS_APROBACION.Eq("usuario_aprobacion.Actualizacion_Extractor", "1"), !builderPS_APROBACION.Exists("usuario_aprobacion.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_APROBACION = builderPS_APROBACION.And(builderPS_APROBACION.Gte("usuario_aprobacion.Fecha_extraccion", fechaconsulta.Date), builderPS_APROBACION.Lt("usuario_aprobacion.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_APROBACION = Col_PS_APROBACION.Find(filterPS_APROBACION).ToList();

                if (consulta_PS_APROBACION != null && consulta_PS_APROBACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROBACION_Usuario encontrados " + consulta_PS_APROBACION.Count.ToString());
                        foreach (BsonDocument itemPS_APROBACION in consulta_PS_APROBACION)
                        {
                            id_mongo = itemPS_APROBACION.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_APROBACION_Usuario = itemPS_APROBACION.GetElement("usuario_aprobacion").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROBACION_Usuario != null && consulta_PS_APROBACION_Usuario.Count() > 0)
                            {
                                foreach (BsonValue itemAprobacionUsuario in consulta_PS_APROBACION_Usuario)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemAprobacionUsuario.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemAprobacionUsuario.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemAprobacionUsuario.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_APROBACION.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROBACION.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROBACION.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROBACION.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROBACION.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionUsuario.ToBsonDocument().Contains("usuario_aprobacion") && !itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString()) ? (itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString().Length > 50 ? itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString().Substring(0, 50) : itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionUsuario.ToBsonDocument().Contains("fecha_aprobacion") && !itemAprobacionUsuario.ToBsonDocument().GetValue("fecha_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionUsuario.ToBsonDocument().GetValue("fecha_aprobacion").ToString()) ? (itemAprobacionUsuario.ToBsonDocument().GetValue("fecha_aprobacion").ToString().Length > 30 ? itemAprobacionUsuario.ToBsonDocument().GetValue("fecha_aprobacion").ToString().Substring(0, 30) : itemAprobacionUsuario.ToBsonDocument().GetValue("fecha_aprobacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionUsuario.ToBsonDocument().Contains("rol_aprobacion") && !itemAprobacionUsuario.ToBsonDocument().GetValue("rol_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionUsuario.ToBsonDocument().GetValue("rol_aprobacion").ToString()) ? (itemAprobacionUsuario.ToBsonDocument().GetValue("rol_aprobacion").ToString().Length > 30 ? itemAprobacionUsuario.ToBsonDocument().GetValue("rol_aprobacion").ToString().Substring(0, 29) : itemAprobacionUsuario.ToBsonDocument().GetValue("rol_aprobacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemAprobacionUsuario.ToBsonDocument().Contains("es_aprobado") && !itemAprobacionUsuario.ToBsonDocument().GetValue("es_aprobado").IsBsonNull ? itemAprobacionUsuario.ToBsonDocument().GetValue("es_aprobado").ToString().Length > 8 ? itemAprobacionUsuario.ToBsonDocument().GetValue("es_aprobado").ToString().Substring(0, 8) : itemAprobacionUsuario.ToBsonDocument().GetValue("es_aprobado").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionUsuario.ToBsonDocument().Contains("firma") && !itemAprobacionUsuario.ToBsonDocument().GetValue("firma").IsBsonNull ? !string.IsNullOrEmpty(itemAprobacionUsuario.ToBsonDocument().GetValue("firma").ToString()) ? (itemAprobacionUsuario.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 660000 ? itemAprobacionUsuario.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemAprobacionUsuario.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : ""); // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,

                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROBACION_Usuario Id: " + id_mongo + "," + itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_APROBACION.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_APROBACION.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROBACION.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_aprobacion.usuario_aprobacion",
                                                                   itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_aprobacion.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_aprobacion.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_APROBACION_Usuario++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemAprobacionUsuario.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_APROBACION.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                    Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROBACION.GetValue("_id").ToString())),
                                                                    Builders<BsonDocument>.Filter.Eq("usuario_aprobacion.usuario_aprobacion",
                                                                    itemAprobacionUsuario.ToBsonDocument().GetValue("usuario_aprobacion").ToString())),
                                                                    Builders<BsonDocument>.Update.Set("usuario_aprobacion.Actualizacion_Extractor", "0")
                                                                                                 .Set("usuario_aprobacion.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_APROBACION_Usuario++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_APROBACION_Usuario ACTUALIZADA: " + itemPS_APROBACION.GetValue("_id").ToString() + "Numero de PS_APROBACION_Usuario actializadas: " + Conteo_PS_APROBACION_Usuario);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROBACION_Usuario en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROBACION_Usuario para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_APROBACION_Usuario > 0)
                        {
                            Archivo_PS_APROBACION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROBACION_Usuario_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROBACION_Usuario entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROBACION.Close();
            }

        }

        internal static void Extractor_PS_APROBACION_Inventario(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROBACION_Inventario");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROBACION = null;

            int Conteo_PS_APROBACION_Inventario = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_APROBACION_Inventario_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROBACION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROBACION = db.GetCollection<BsonDocument>("PS_APROBACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROBACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROBACION = builderPS_APROBACION.Empty;

                if (tipo == "")
                {
                    filterPS_APROBACION = builderPS_APROBACION.Or(builderPS_APROBACION.Eq("items_inventario.Actualizacion_Extractor", "1"), !builderPS_APROBACION.Exists("items_inventario.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_APROBACION = builderPS_APROBACION.And(builderPS_APROBACION.Gte("items_inventario.Fecha_extraccion", fechaconsulta.Date), builderPS_APROBACION.Lt("items_inventario.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_APROBACION = Col_PS_APROBACION.Find(filterPS_APROBACION).ToList();

                if (consulta_PS_APROBACION != null && consulta_PS_APROBACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROBACION_Inventario encontrados " + consulta_PS_APROBACION.Count.ToString());
                        foreach (BsonDocument itemPS_APROBACION in consulta_PS_APROBACION)
                        {
                            id_mongo = itemPS_APROBACION.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_APROBACION_Usuario = itemPS_APROBACION.GetElement("items_inventario").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROBACION_Usuario != null && consulta_PS_APROBACION_Usuario.Count() > 0)
                            {
                                foreach (BsonValue itemAprobacionInventario in consulta_PS_APROBACION_Usuario)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemAprobacionInventario.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemAprobacionInventario.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemAprobacionInventario.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_APROBACION.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROBACION.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROBACION.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROBACION.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROBACION.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionInventario.ToBsonDocument().Contains("id_inventario") && !itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString()) ? (itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString().Length > 30 ? itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString().Substring(0, 29) : itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionInventario.ToBsonDocument().Contains("producto_inventario") && !itemAprobacionInventario.ToBsonDocument().GetValue("producto_inventario").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionInventario.ToBsonDocument().GetValue("producto_inventario").ToString()) ? (itemAprobacionInventario.ToBsonDocument().GetValue("producto_inventario").ToString().Length > 50 ? itemAprobacionInventario.ToBsonDocument().GetValue("producto_inventario").ToString().Substring(0, 50) : itemAprobacionInventario.ToBsonDocument().GetValue("producto_inventario").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionInventario.ToBsonDocument().Contains("fecha_aprobacion") && !itemAprobacionInventario.ToBsonDocument().GetValue("fecha_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionInventario.ToBsonDocument().GetValue("fecha_aprobacion").ToString()) ? (itemAprobacionInventario.ToBsonDocument().GetValue("fecha_aprobacion").ToString().Length > 30 ? itemAprobacionInventario.ToBsonDocument().GetValue("fecha_aprobacion").ToString().Substring(0, 30) : itemAprobacionInventario.ToBsonDocument().GetValue("fecha_aprobacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionInventario.ToBsonDocument().Contains("rol_aprobacion") && !itemAprobacionInventario.ToBsonDocument().GetValue("rol_aprobacion").IsBsonNull && !string.IsNullOrEmpty(itemAprobacionInventario.ToBsonDocument().GetValue("rol_aprobacion").ToString()) ? (itemAprobacionInventario.ToBsonDocument().GetValue("rol_aprobacion").ToString().Length > 30 ? itemAprobacionInventario.ToBsonDocument().GetValue("rol_aprobacion").ToString().Substring(0, 29) : itemAprobacionInventario.ToBsonDocument().GetValue("rol_aprobacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemAprobacionInventario.ToBsonDocument().Contains("es_aprobado") && !itemAprobacionInventario.ToBsonDocument().GetValue("es_aprobado").IsBsonNull ? itemAprobacionInventario.ToBsonDocument().GetValue("es_aprobado").ToString().Length > 8 ? itemAprobacionInventario.ToBsonDocument().GetValue("es_aprobado").ToString().Substring(0, 8) : itemAprobacionInventario.ToBsonDocument().GetValue("es_aprobado").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemAprobacionInventario.ToBsonDocument().Contains("firma") && !itemAprobacionInventario.ToBsonDocument().GetValue("firma").IsBsonNull ? !string.IsNullOrEmpty(itemAprobacionInventario.ToBsonDocument().GetValue("firma").ToString()) ? (itemAprobacionInventario.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 660000 ? itemAprobacionInventario.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemAprobacionInventario.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : ""); // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,

                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROBACION_Inventario Id: " + id_mongo + "," + itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_APROBACION.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_APROBACION.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROBACION.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("items_inventario.id_inventario",
                                                                   itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("items_inventario.Actualizacion_Extractor", "0")
                                                                                                .Set("items_inventario.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_APROBACION_Inventario++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemAprobacionInventario.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_APROBACION.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                  Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROBACION.GetValue("_id").ToString())),
                                                                  Builders<BsonDocument>.Filter.Eq("items_inventario.id_inventario",
                                                                  itemAprobacionInventario.ToBsonDocument().GetValue("id_inventario").ToString())),
                                                                  Builders<BsonDocument>.Update.Set("items_inventario.Actualizacion_Extractor", "0")
                                                                                               .Set("items_inventario.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_APROBACION_Inventario++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_APROBACION_Inventario ACTUALIZADA: " + itemPS_APROBACION.GetValue("_id").ToString() + "Numero de PS_APROBACION_Inventario actializadas: " + Conteo_PS_APROBACION_Inventario);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROBACION_Inventario en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROBACION_Inventario para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_APROBACION_Inventario > 0)
                        {
                            Archivo_PS_APROBACION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROBACION_Inventario_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROBACION_Inventario entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROBACION.Close();
            }

        }

        internal static void Extractor_PS_APROVISIONAMIENTO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROVISIONAMIENTO = null;

            int Conteo_PS_APROVISIONAMIENTO = 0;
            string sTextoDescarga_aprov = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;
            int comunicaciones = 0;
            int historico = 0;
            int servicios_cliente = 0;
            int conteo_adjuntos = 0;
            int conteo_tiempos_solicitud = 0;
            int conteo_solicitud_materiales = 0;
            int conteo_total_Usu_Aprov = 0;
            int Total_conteo_total_Usu_Aprov = 0;
            int cont__Grupos_Lider = 0;
            int Total_cont__Grupos_Lider = 0;
            int datos_adicionales_aprov = 0;

            string archivo = path + "PS_02_00_APROVISIONA_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROVISIONAMIENTO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROBACION = builderPS_APROVISIONAMIENTO.Empty;

                if (tipo == "")
                {
                    filterPS_APROBACION = builderPS_APROVISIONAMIENTO.Or(builderPS_APROVISIONAMIENTO.Eq("Actualizacion_Extractor", "1"), !builderPS_APROVISIONAMIENTO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_APROBACION = builderPS_APROVISIONAMIENTO.And(builderPS_APROVISIONAMIENTO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_APROVISIONAMIENTO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_APROVISIONAMIENTO = Col_PS_APROVISIONAMIENTO.Find(filterPS_APROBACION).ToList();

                if (consulta_PS_APROVISIONAMIENTO != null && consulta_PS_APROVISIONAMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO encontrados " + consulta_PS_APROVISIONAMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga_aprov = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga_aprov = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "_id", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fecha_creacion", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "usuario_creacion", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fecha_actualizacion", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "usuario_modificacion", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "tipo_solicitud", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "id_aprovisionamiento", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "viabilidad_origen", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "opcion_viabilidad", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "comentarios", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "numero_contrato", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fecha_inicio_contrato", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fecha_fin_contrato", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "renovacion_automatica", 30));
                                        //sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "datos_adicionales_aprovisionamiento", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "id_usuario_asignado", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "usuario_asignado", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "id_grupo_asignado", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "grupo_asignado", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "id_fase", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fase_actual", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "id_estado", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "estado", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "tiempo_ans", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "id_tipo_proceso", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "tipo_proceso", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fecha_inicio_facturacion", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "solicitud_entrega_materiales", 30));
                                        sTextoDescarga_aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "fecha_finalizacion", 30));
                                        sTextoDescarga_aprov = sTextoDescarga_aprov.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        if (itemPS_APROVISIONAMIENTO.Contains("comunicaciones") && !itemPS_APROVISIONAMIENTO.GetElement("comunicaciones").Value.IsBsonNull)
                                        {
                                            comunicaciones += Extractor_PS_APROVISIONAMIENTO_Comunicaciones(id_mongo);
                                        }                                        
                                        if (itemPS_APROVISIONAMIENTO.Contains("adjuntos") && !itemPS_APROVISIONAMIENTO.GetElement("adjuntos").Value.IsBsonNull)
                                        {
                                            conteo_adjuntos += Extractor_PS_APROVISIONAMIENTO_Adjuntos(id_mongo);
                                        }
                                        if (itemPS_APROVISIONAMIENTO.Contains("historico_estados") && !itemPS_APROVISIONAMIENTO.GetElement("historico_estados").Value.IsBsonNull)
                                        {
                                            historico += Extractor_PS_APROVISIONAMIENTO_historico_estados(id_mongo);
                                        }
                                        if (itemPS_APROVISIONAMIENTO.Contains("tiempos_solicitud") && !itemPS_APROVISIONAMIENTO.GetElement("tiempos_solicitud").Value.IsBsonNull)
                                        {
                                            conteo_tiempos_solicitud += Extractor_PS_APROVISIONAMIENTO_Tiempos_Solicitud(id_mongo);
                                        }
                                        if (itemPS_APROVISIONAMIENTO.Contains("servicios_cliente") && !itemPS_APROVISIONAMIENTO.GetElement("servicios_cliente").Value.IsBsonNull)
                                        {
                                            servicios_cliente += Extractor_PS_APROVISIONAMIENTO_servicios_cliente(id_mongo);
                                        }
                                        if (itemPS_APROVISIONAMIENTO.Contains("solicitud_entrega_materiales") && !itemPS_APROVISIONAMIENTO.GetElement("solicitud_entrega_materiales").Value.IsBsonNull)
                                        {
                                            conteo_solicitud_materiales += Extractor_PS_APROVISIONAMIENTO_Solicitud_Materiales(id_mongo, out conteo_total_Usu_Aprov, out cont__Grupos_Lider);
                                        }
                                        Total_conteo_total_Usu_Aprov += conteo_total_Usu_Aprov;
                                        Total_cont__Grupos_Lider += cont__Grupos_Lider;
                                        
                                        if (itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("datos_adicionales_aprovisionamiento") && !itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("datos_adicionales_aprovisionamiento").IsBsonNull && itemPS_APROVISIONAMIENTO.ToBsonDocument().GetElement("datos_adicionales_aprovisionamiento").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            List<BsonValue> consulta_Datos_Adicionales_Aprov = itemPS_APROVISIONAMIENTO.ToBsonDocument().GetElement("datos_adicionales_aprovisionamiento").Value.AsBsonArray.AsQueryable().ToList();
                                            datos_adicionales_aprov += Extractor_PS_APROVISIONAMIENTO_datos_adicionales(id_mongo, consulta_Datos_Adicionales_Aprov);
                                        }
                                        if (itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("respuesta") && !itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("respuesta").IsBsonNull && itemPS_APROVISIONAMIENTO.ToBsonDocument().GetElement("respuesta").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            List<BsonValue> consulta_Respuesta_Aprov = itemPS_APROVISIONAMIENTO.ToBsonDocument().GetElement("respuesta").Value.AsBsonArray.AsQueryable().ToList();
                                            datos_adicionales_aprov += Extractor_PS_APROVISIONAMIENTO_respuesta(id_mongo, consulta_Respuesta_Aprov);
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga_aprov != "")
                                        {
                                            Archivo_PS_APROVISIONAMIENTO.WriteLine(sTextoDescarga_aprov);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_APROVISIONAMIENTO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROVISIONAMIENTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_APROVISIONAMIENTO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_APROVISIONAMIENTO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_APROVISIONAMIENTO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROVISIONAMIENTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_APROVISIONAMIENTO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_APROVISIONAMIENTO ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO actializadas: " + Conteo_PS_APROVISIONAMIENTO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_APROVISIONAMIENTO > 0)
                        {
                            Archivo_PS_APROVISIONAMIENTO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                if (comunicaciones > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Comunicaciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (conteo_adjuntos > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Comunicaciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (historico > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_historico_estados_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (conteo_tiempos_solicitud > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Comunicaciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (servicios_cliente > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_servicios_cliente_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (conteo_solicitud_materiales > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_servicios_cliente_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (Total_conteo_total_Usu_Aprov > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_servicios_cliente_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (Total_cont__Grupos_Lider > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_servicios_cliente_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROVISIONAMIENTO.Close();
            }

        }

        internal static int Extractor_PS_APROVISIONAMIENTO_Comunicaciones(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_Comunicaciones");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROVISIONAMIENTO_Comunicaciones = null;

            int Conteo_PS_APROVISIONAMIENTO_Comunicaciones = 0;
            string sTextoDescarga_aprovisionamiento_comunicaciones = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_02_01_APROV_COMUN_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROVISIONAMIENTO_Comunicaciones = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROVISIONAMIENTO = builderPS_APROVISIONAMIENTO.Empty;
                filterPS_APROVISIONAMIENTO = builderPS_APROVISIONAMIENTO.And(
                builderPS_APROVISIONAMIENTO.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_APROVISIONAMIENTO.SizeGte("comunicaciones", 1));


                List<BsonDocument> consulta_PS_APROVISIONAMIENTO = Col_PS_APROVISIONAMIENTO.Find(filterPS_APROVISIONAMIENTO).ToList();

                if (consulta_PS_APROVISIONAMIENTO != null && consulta_PS_APROVISIONAMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_Comunicaciones encontrados " + consulta_PS_APROVISIONAMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga_aprovisionamiento_comunicaciones = "";
                            List<BsonValue> consulta_PS_APROVISIONAMIENTO_Comunicaciones = itemPS_APROVISIONAMIENTO.GetElement("comunicaciones").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROVISIONAMIENTO_Comunicaciones != null && consulta_PS_APROVISIONAMIENTO_Comunicaciones.Count() > 0)
                            {
                                foreach (BsonValue itemPS_APROVISIONAMIENTO_Comunicaciones in consulta_PS_APROVISIONAMIENTO_Comunicaciones)
                                {
                                    try
                                    {
                                        try
                                        {
                                            //sTextoDescarga_aprovisionamiento_comunicaciones += string.Format("|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "_id", 30));
                                            //sTextoDescarga_aprovisionamiento_comunicaciones += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO_Comunicaciones.ToBsonDocument(), "comunicaciones", 30));

                                            sTextoDescarga_aprovisionamiento_comunicaciones =
                                            (itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            "~|" + (itemPS_APROVISIONAMIENTO_Comunicaciones.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga_aprovisionamiento_comunicaciones = sTextoDescarga_aprovisionamiento_comunicaciones.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_Comunicaciones Id: " + id_mongo + "," + itemPS_APROVISIONAMIENTO_Comunicaciones.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga_aprovisionamiento_comunicaciones != "")
                                            {
                                                Archivo_PS_APROVISIONAMIENTO_Comunicaciones.WriteLine(sTextoDescarga_aprovisionamiento_comunicaciones);
                                                Console.WriteLine(sTextoDescarga_aprovisionamiento_comunicaciones);
                                                Conteo_PS_APROVISIONAMIENTO_Comunicaciones++;
                                            }
                                            //Console.WriteLine("PS_APROVISIONAMIENTO_Comunicaciones ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_Comunicaciones actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO_Comunicaciones en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_Comunicaciones para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_APROVISIONAMIENTO_Comunicaciones ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_Comunicaciones actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                            }

                        }

                        if (Conteo_PS_APROVISIONAMIENTO_Comunicaciones > 0)
                        {
                            Archivo_PS_APROVISIONAMIENTO_Comunicaciones.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_Comunicaciones entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_APROVISIONAMIENTO_Comunicaciones;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROVISIONAMIENTO_Comunicaciones.Close();

            }
            return Conteo_PS_APROVISIONAMIENTO_Comunicaciones;
        } //Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_PS_APROVISIONAMIENTO_Adjuntos(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_Adjuntos");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROBACION = null;

            int Conteo_PS_APROVISIONAMIENTO_Adjuntos = 0;
            string sTextoDescarga_aprov_adjuntos = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_02_02_APROV_ADJUN_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROBACION = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO_ADJUNTOS = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO_ADJUNTOS = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROVISIONAMIENTO_ADJUNTOS = builderPS_APROVISIONAMIENTO_ADJUNTOS.Empty;

                filterPS_APROVISIONAMIENTO_ADJUNTOS = builderPS_APROVISIONAMIENTO_ADJUNTOS.And(
                builderPS_APROVISIONAMIENTO_ADJUNTOS.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_APROVISIONAMIENTO_ADJUNTOS.SizeGte("adjuntos", 1));


                List<BsonDocument> consulta_PS_APROVISIONAMIENTO = Col_PS_APROVISIONAMIENTO_ADJUNTOS.Find(filterPS_APROVISIONAMIENTO_ADJUNTOS).ToList();

                if (consulta_PS_APROVISIONAMIENTO != null && consulta_PS_APROVISIONAMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_Adjuntos encontrados " + consulta_PS_APROVISIONAMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga_aprov_adjuntos = "";
                            List<BsonValue> consulta_PS_APROVISIONAMIENTO_Adjuntos = itemPS_APROVISIONAMIENTO.GetElement("adjuntos").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROVISIONAMIENTO_Adjuntos != null && consulta_PS_APROVISIONAMIENTO_Adjuntos.Count() > 0)
                            {
                                foreach (BsonValue itemAPROVISIONAMIENTOAdjuntos in consulta_PS_APROVISIONAMIENTO_Adjuntos)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga_aprov_adjuntos = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "_id", 30));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "_id", 30));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "ruta", 500));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "fecha_creacion", 30));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "usuario_creacion", 30));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "id_tarea_relacionada", 30));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "tarea_relacionada", 100));
                                            sTextoDescarga_aprov_adjuntos += string.Format("~|{0}", ValidarDatoEnBsonValue(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument(), "es_publico", 8));



                                            //sTextoDescarga =
                                            //(itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            //"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("_id") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").IsBsonNull && !string.IsNullOrEmpty(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").ToString()) ? (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                            //"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("ruta") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("ruta").IsBsonNull && !string.IsNullOrEmpty(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("ruta").ToString()) ? (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("ruta").ToString().Length > 30 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("ruta").ToString().Substring(0, 29) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("ruta").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                            ////"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("ruta") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("fecha_creacion").ToString()) ? (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("fecha_creacion").ToString().Length > 30 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("fecha_creacion").ToString().Substring(0, 30) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            //"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("usuario_modificacion") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("usuario_modificacion").ToString()) ? (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("usuario_modificacion").ToString().Length > 50 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            //"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("id_tarea_relacionada") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("id_tarea_relacionada").IsBsonNull && !string.IsNullOrEmpty(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("id_tarea_relacionada").ToString()) ? (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("id_tarea_relacionada").ToString().Length > 30 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("id_tarea_relacionada").ToString().Substring(0, 29) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("id_tarea_relacionada").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                            //"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("tarea_relacionada") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("tarea_relacionada").IsBsonNull && !string.IsNullOrEmpty(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("tarea_relacionada").ToString()) ? (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("tarea_relacionada").ToString().Length > 30 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("tarea_relacionada").ToString().Substring(0, 29) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("tarea_relacionada").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                            //"~|" + (itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().Contains("es_publico") && !itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("es_publico").IsBsonNull ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("es_publico").ToString().Length > 8 ? itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("es_publico").ToString().Substring(0, 8) : itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("es_publico").ToString() : "");

                                            sTextoDescarga_aprov_adjuntos = sTextoDescarga_aprov_adjuntos.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                            if (sTextoDescarga_aprov_adjuntos != "")
                                            {
                                                Archivo_PS_APROBACION.WriteLine(sTextoDescarga_aprov_adjuntos);
                                                Conteo_PS_APROVISIONAMIENTO_Adjuntos++;
                                            }

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_Adjuntos Id: " + id_mongo + "," + itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        //try
                                        //{
                                        //    if (sTextoDescarga != "")
                                        //    {
                                        //        Archivo_PS_APROBACION.WriteLine(sTextoDescarga);
                                        //        if (pruebas == false)
                                        //        {
                                        //            if (tipo == "")
                                        //            {
                                        //                Col_PS_APROVISIONAMIENTO_ADJUNTOS.UpdateOne(Builders<BsonDocument>.Filter.And(
                                        //                       Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROVISIONAMIENTO.GetValue("_id").ToString())),
                                        //                       Builders<BsonDocument>.Filter.Eq("adjuntos._id", MongoDB.Bson.ObjectId.Parse(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").ToString()))),
                                        //                       Builders<BsonDocument>.Update.Set("adjuntos.Actualizacion_Extractor", "0")
                                        //                                                    .Set("adjuntos.Fecha_extraccion", fechatemp.ToLocalTime()));
                                        //                Conteo_PS_APROVISIONAMIENTO_Adjuntos++;
                                        //            }
                                        //            else if (tipo != "")
                                        //            {
                                        //                if ((itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                        //                {
                                        //                    Col_PS_APROVISIONAMIENTO_ADJUNTOS.UpdateOne(Builders<BsonDocument>.Filter.And(
                                        //                      Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROVISIONAMIENTO.GetValue("_id").ToString())),
                                        //                      Builders<BsonDocument>.Filter.Eq("adjuntos._id", MongoDB.Bson.ObjectId.Parse(itemAPROVISIONAMIENTOAdjuntos.ToBsonDocument().GetValue("_id").ToString()))),
                                        //                      Builders<BsonDocument>.Update.Set("adjuntos.Actualizacion_Extractor", "0")
                                        //                                                   .Set("adjuntos.Fecha_extraccion", fechatemp.ToLocalTime()));
                                        //                    Conteo_PS_APROVISIONAMIENTO_Adjuntos++;
                                        //                }

                                        //            }

                                        //        }
                                        //    }
                                        //    Console.WriteLine("PS_APROBACION_Usuario ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_Adjuntos actializadas: " + Conteo_PS_APROVISIONAMIENTO_Adjuntos);
                                        //}
                                        //catch (Exception ex)
                                        //{
                                        //    string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        //    prcManejoErrores objError = new prcManejoErrores();
                                        //    objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO_Adjuntos en mongo Id: " + id_mongo);
                                        //    continue;
                                        //}
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_Adjuntos para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_APROVISIONAMIENTO_Adjuntos > 0)
                        {
                            Archivo_PS_APROBACION.Close();

                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Adjuntos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }
                            return Conteo_PS_APROVISIONAMIENTO_Adjuntos;
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_Adjuntos entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROBACION.Close();
            }
            return Conteo_PS_APROVISIONAMIENTO_Adjuntos;
        } //Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_PS_APROVISIONAMIENTO_historico_estados(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_historico_estados");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROVISIONAMIENTO_historico_estados = null;

            int Conteo_PS_APROVISIONAMIENTO_historico_estados = 0;
            string sTextoDescarga_Histo_estados = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_02_03_APROV_HISTE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROVISIONAMIENTO_historico_estados = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROVISIONAMIENTO = builderPS_APROVISIONAMIENTO.Empty;
                filterPS_APROVISIONAMIENTO = builderPS_APROVISIONAMIENTO.And(
                builderPS_APROVISIONAMIENTO.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_APROVISIONAMIENTO.SizeGte("historico_estados", 1));


                List<BsonDocument> consulta_PS_APROVISIONAMIENTO = Col_PS_APROVISIONAMIENTO.Find(filterPS_APROVISIONAMIENTO).ToList();

                if (consulta_PS_APROVISIONAMIENTO != null && consulta_PS_APROVISIONAMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_historico_estados encontrados " + consulta_PS_APROVISIONAMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga_Histo_estados = "";
                            List<BsonValue> consulta_PS_APROVISIONAMIENTO_historico_estados = itemPS_APROVISIONAMIENTO.GetElement("historico_estados").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROVISIONAMIENTO_historico_estados != null && consulta_PS_APROVISIONAMIENTO_historico_estados.Count() > 0)
                            {
                                foreach (BsonValue itemPS_APROVISIONAMIENTO_historico_estados in consulta_PS_APROVISIONAMIENTO_historico_estados)
                                {
                                    try
                                    {
                                        try
                                        {
                                            //sTextoDescarga_Histo_estados += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "_id", 30));
                                            //sTextoDescarga_Histo_estados += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO_historico_estados.ToBsonDocument(), "historico_estados", 30));

                                            sTextoDescarga_Histo_estados =
                                            (itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            "~|" + (itemPS_APROVISIONAMIENTO_historico_estados.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga_Histo_estados = sTextoDescarga_Histo_estados.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_historico_estados Id: " + id_mongo + "," + itemPS_APROVISIONAMIENTO_historico_estados.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga_Histo_estados != "")
                                            {
                                                Archivo_PS_APROVISIONAMIENTO_historico_estados.WriteLine(sTextoDescarga_Histo_estados);
                                                Console.WriteLine(sTextoDescarga_Histo_estados);
                                                Conteo_PS_APROVISIONAMIENTO_historico_estados++;
                                            }
                                            //Console.WriteLine("PS_APROVISIONAMIENTO_historico_estados ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_historico_estados actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO_historico_estados en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_historico_estados para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_APROVISIONAMIENTO_historico_estados ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_historico_estados actializadas: " + Conteo_PS_APROVISIONAMIENTO_historico_estados);
                            }

                        }

                        if (Conteo_PS_APROVISIONAMIENTO_historico_estados > 0)
                        {
                            Archivo_PS_APROVISIONAMIENTO_historico_estados.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_historico_estados entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_APROVISIONAMIENTO_historico_estados;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROVISIONAMIENTO_historico_estados.Close();

            }
            return Conteo_PS_APROVISIONAMIENTO_historico_estados;
        } //Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_PS_APROVISIONAMIENTO_Tiempos_Solicitud(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_Tiempos_Solicitud");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROBACION = null;

            int Conteo_PS_APROVISIONAMIENTO_Adjuntos = 0;
            string sTextoDescarga_T_SOLICITUD = "";

            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_02_04_APROV_TIEMS_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROBACION = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO_TS = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO_TS = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROVISIONAMIENTO_TS = builderPS_APROVISIONAMIENTO_TS.Empty;
                filterPS_APROVISIONAMIENTO_TS = builderPS_APROVISIONAMIENTO_TS.And(
                builderPS_APROVISIONAMIENTO_TS.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_APROVISIONAMIENTO_TS.SizeGte("tiempos_solicitud", 1));

                List<BsonDocument> consulta_PS_APROVISIONAMIENTO = Col_PS_APROVISIONAMIENTO_TS.Find(filterPS_APROVISIONAMIENTO_TS).ToList();

                if (consulta_PS_APROVISIONAMIENTO != null && consulta_PS_APROVISIONAMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_Tiempos_Solicitud encontrados " + consulta_PS_APROVISIONAMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga_T_SOLICITUD = "";
                            List<BsonValue> consulta_PS_APROVISIONAMIENTO_Tiempos_Solicitud = itemPS_APROVISIONAMIENTO.GetElement("tiempos_solicitud").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROVISIONAMIENTO_Tiempos_Solicitud != null && consulta_PS_APROVISIONAMIENTO_Tiempos_Solicitud.Count() > 0)
                            {
                                foreach (BsonValue itemTiempos_solicitud in consulta_PS_APROVISIONAMIENTO_Tiempos_Solicitud)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemTiempos_solicitud.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemTiempos_solicitud.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemTiempos_solicitud.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga_T_SOLICITUD = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO, "_id", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "_id", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "fecha_creacion", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "usuario_creacion", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "fecha_actualizacion", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "usuario_modificacion", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "nombre", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "descripcion", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "es_activo", 8));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "color", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "fechainicio", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "Fechafin", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "tiempoTranscurrido", 30));
                                                sTextoDescarga_T_SOLICITUD += string.Format("~|{0}", ValidarDatoEnBsonValue(itemTiempos_solicitud.ToBsonDocument(), "en_ejecucion", 8));


                                                //sTextoDescarga_T_SOLICITUD =
                                                //(itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("_id") && !itemTiempos_solicitud.ToBsonDocument().GetValue("_id").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("_id").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemTiempos_solicitud.ToBsonDocument().GetValue("_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("fecha_creacion") && !itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_creacion").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_creacion").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_creacion").ToString().Substring(0, 30) : itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("usuario_creacion") && !itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_creacion").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_creacion").ToString().Length > 50 ? itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_creacion").ToString().Substring(0, 50) : itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("fecha_actualizacion") && !itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_actualizacion").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_actualizacion").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemTiempos_solicitud.ToBsonDocument().GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("usuario_modificacion") && !itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_modificacion").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_modificacion").ToString().Length > 50 ? itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("nombre") && !itemTiempos_solicitud.ToBsonDocument().GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("nombre").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("nombre").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("nombre").ToString().Substring(0, 29) : itemTiempos_solicitud.ToBsonDocument().GetValue("nombre").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("descripcion") && !itemTiempos_solicitud.ToBsonDocument().GetValue("descripcion").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("descripcion").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("descripcion").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("descripcion").ToString().Substring(0, 29) : itemTiempos_solicitud.ToBsonDocument().GetValue("descripcion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("color") && !itemTiempos_solicitud.ToBsonDocument().GetValue("color").IsBsonNull ? itemTiempos_solicitud.ToBsonDocument().GetValue("color").ToString().Length > 8 ? itemTiempos_solicitud.ToBsonDocument().GetValue("color").ToString().Substring(0, 8) : itemTiempos_solicitud.ToBsonDocument().GetValue("color").ToString() : "") +
                                                ////"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("color") && !itemTiempos_solicitud.ToBsonDocument().GetValue("color").IsBsonNull ? itemTiempos_solicitud.ToBsonDocument().GetValue("color").ToString().Length > 8 ? itemTiempos_solicitud.ToBsonDocument().GetValue("color").ToString().Substring(0, 8) : itemTiempos_solicitud.ToBsonDocument().GetValue("color").ToString() : "") +
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("fechainicio") && !itemTiempos_solicitud.ToBsonDocument().GetValue("fechainicio").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("fechainicio").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("fechainicio").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("fechainicio").ToString().Substring(0, 30) : itemTiempos_solicitud.ToBsonDocument().GetValue("fechainicio").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("Fechafin") && !itemTiempos_solicitud.ToBsonDocument().GetValue("Fechafin").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("Fechafin").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("Fechafin").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("Fechafin").ToString().Substring(0, 30) : itemTiempos_solicitud.ToBsonDocument().GetValue("Fechafin").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("tiempoTranscurrido") && !itemTiempos_solicitud.ToBsonDocument().GetValue("tiempoTranscurrido").IsBsonNull && !string.IsNullOrEmpty(itemTiempos_solicitud.ToBsonDocument().GetValue("tiempoTranscurrido").ToString()) ? (itemTiempos_solicitud.ToBsonDocument().GetValue("tiempoTranscurrido").ToString().Length > 30 ? itemTiempos_solicitud.ToBsonDocument().GetValue("tiempoTranscurrido").ToString().Substring(0, 29) : itemTiempos_solicitud.ToBsonDocument().GetValue("tiempoTranscurrido").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                //"~|" + (itemTiempos_solicitud.ToBsonDocument().Contains("en_ejecucion") && !itemTiempos_solicitud.ToBsonDocument().GetValue("en_ejecucion").IsBsonNull ? itemTiempos_solicitud.ToBsonDocument().GetValue("en_ejecucion").ToString().Length > 8 ? itemTiempos_solicitud.ToBsonDocument().GetValue("en_ejecucion").ToString().Substring(0, 8) : itemTiempos_solicitud.ToBsonDocument().GetValue("en_ejecucion").ToString() : "");

                                                sTextoDescarga_T_SOLICITUD = sTextoDescarga_T_SOLICITUD.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_Tiempos_Solicitud Id: " + id_mongo + "," + itemTiempos_solicitud.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga_T_SOLICITUD != "")
                                                {
                                                    Archivo_PS_APROBACION.WriteLine(sTextoDescarga_T_SOLICITUD);
                                                    Conteo_PS_APROVISIONAMIENTO_Adjuntos++;
                                                    //if (pruebas == false)
                                                    //{
                                                    //    if (tipo == "")
                                                    //    {
                                                    //        Col_PS_APROVISIONAMIENTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                    //               Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROVISIONAMIENTO.GetValue("_id").ToString())),
                                                    //               Builders<BsonDocument>.Filter.Eq("tiempos_solicitud._id", MongoDB.Bson.ObjectId.Parse(itemTiempos_solicitud.ToBsonDocument().GetValue("_id").ToString()))),
                                                    //               Builders<BsonDocument>.Update.Set("tiempos_solicitud.Actualizacion_Extractor", "0")
                                                    //                                            .Set("tiempos_solicitud.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    //        Conteo_PS_APROVISIONAMIENTO_Adjuntos++;
                                                    //    }
                                                    //    else if (tipo != "")
                                                    //    {
                                                    //        if ((itemTiempos_solicitud.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    //        {
                                                    //            Col_PS_APROVISIONAMIENTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                    //              Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_APROVISIONAMIENTO.GetValue("_id").ToString())),
                                                    //              Builders<BsonDocument>.Filter.Eq("tiempos_solicitud._id", MongoDB.Bson.ObjectId.Parse(itemTiempos_solicitud.ToBsonDocument().GetValue("_id").ToString()))),
                                                    //              Builders<BsonDocument>.Update.Set("tiempos_solicitud.Actualizacion_Extractor", "0")
                                                    //                                           .Set("tiempos_solicitud.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    //            Conteo_PS_APROVISIONAMIENTO_Adjuntos++;
                                                    //        }

                                                    //    }

                                                    //}
                                                }
                                                Console.WriteLine("PS_APROVISIONAMIENTO_Tiempos_Solicitud ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_Tiempos_Solicitud actializadas: " + Conteo_PS_APROVISIONAMIENTO_Adjuntos);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO_Tiempos_Solicitud en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_Tiempos_Solicitud para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_APROVISIONAMIENTO_Adjuntos > 0)
                        {
                            Archivo_PS_APROBACION.Close();

                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Adjuntos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }
                            return Conteo_PS_APROVISIONAMIENTO_Adjuntos;
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_Tiempos_Solicitud entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROBACION.Close();
            }
            return Conteo_PS_APROVISIONAMIENTO_Adjuntos;
        } //Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_PS_APROVISIONAMIENTO_servicios_cliente(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_servicios_cliente");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_APROVISIONAMIENTO_historico_estados = null;

            int Conteo_PS_APROVISIONAMIENTO_servicios_cliente = 0;
            string sTextoDescarga = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_02_05_APROV_SERVC_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROVISIONAMIENTO_historico_estados = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROVISIONAMIENTO = builderPS_APROVISIONAMIENTO.Empty;
                filterPS_APROVISIONAMIENTO = builderPS_APROVISIONAMIENTO.And(
                builderPS_APROVISIONAMIENTO.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_APROVISIONAMIENTO.SizeGte("servicios_cliente", 1));


                List<BsonDocument> consulta_PS_APROVISIONAMIENTO = Col_PS_APROVISIONAMIENTO.Find(filterPS_APROVISIONAMIENTO).ToList();

                if (consulta_PS_APROVISIONAMIENTO != null && consulta_PS_APROVISIONAMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_servicios_cliente encontrados " + consulta_PS_APROVISIONAMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_APROVISIONAMIENTO_servicios_cliente = itemPS_APROVISIONAMIENTO.GetElement("servicios_cliente").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_APROVISIONAMIENTO_servicios_cliente != null && consulta_PS_APROVISIONAMIENTO_servicios_cliente.Count() > 0)
                            {
                                foreach (BsonValue itemPS_APROVISIONAMIENTO_servicios_cliente in consulta_PS_APROVISIONAMIENTO_servicios_cliente)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga =
                                            (itemPS_APROVISIONAMIENTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            "~|" + (itemPS_APROVISIONAMIENTO_servicios_cliente.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_servicios_cliente Id: " + id_mongo + "," + itemPS_APROVISIONAMIENTO_servicios_cliente.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga != "")
                                            {
                                                Archivo_PS_APROVISIONAMIENTO_historico_estados.WriteLine(sTextoDescarga);
                                                Console.WriteLine(sTextoDescarga);
                                                Conteo_PS_APROVISIONAMIENTO_servicios_cliente++;
                                            }
                                            //Console.WriteLine("PS_APROVISIONAMIENTO_servicios_cliente ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_servicios_cliente actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO_servicios_cliente en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_servicios_cliente para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_APROVISIONAMIENTO_servicios_cliente ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_APROVISIONAMIENTO_servicios_cliente actializadas: " + Conteo_PS_APROVISIONAMIENTO_servicios_cliente);
                            }

                        }

                        if (Conteo_PS_APROVISIONAMIENTO_servicios_cliente > 0)
                        {
                            Archivo_PS_APROVISIONAMIENTO_historico_estados.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_servicios_cliente entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_APROVISIONAMIENTO_servicios_cliente;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROVISIONAMIENTO_historico_estados.Close();

            }
            return Conteo_PS_APROVISIONAMIENTO_servicios_cliente;
        } //Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_PS_APROVISIONAMIENTO_Solicitud_Materiales(string id_mongo, out int Conteo_PS_APROVISIONAMIENTO_usua_aprov, out int contador_gupos_lider)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_solicitud_entrega_materiales");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_Aprovi_Sol_Mat = null;

            int Conteo_PS_APROVISIONAMIENTO_Sol_Mat = 0;
            Conteo_PS_APROVISIONAMIENTO_usua_aprov = 0;
            contador_gupos_lider = 0;
            contador_gupos_lider = 0;
            string sTextoDescarga_Sol_Mat = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_02_06_00_SOL_MATE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_Aprovi_Sol_Mat = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_APROVISIONAMIENTO_Sol_Mat = db.GetCollection<BsonDocument>("PS_APROVISIONAMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_APROVISIONAMIENTO_Sol_Mat = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_APROVISIONAMIENTO_Sol_Mat = builderPS_APROVISIONAMIENTO_Sol_Mat.Empty;

                filterPS_APROVISIONAMIENTO_Sol_Mat = builderPS_APROVISIONAMIENTO_Sol_Mat.And(
                builderPS_APROVISIONAMIENTO_Sol_Mat.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                !builderPS_APROVISIONAMIENTO_Sol_Mat.Eq("solicitud_entrega_materiales.id_empresa", ""));
                List<BsonDocument> consulta_PS_APROVISIONAMIENTO_Sol_Mat = Col_PS_APROVISIONAMIENTO_Sol_Mat.Find(filterPS_APROVISIONAMIENTO_Sol_Mat).ToList();

                if (consulta_PS_APROVISIONAMIENTO_Sol_Mat != null && consulta_PS_APROVISIONAMIENTO_Sol_Mat.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_solicitud_entrega_materiales " + consulta_PS_APROVISIONAMIENTO_Sol_Mat.Count().ToString());
                        foreach (var itemPS_APROVISIONAMIENTO in consulta_PS_APROVISIONAMIENTO_Sol_Mat)
                        {
                            id_mongo = itemPS_APROVISIONAMIENTO.GetValue("_id").ToString();

                            sTextoDescarga_Sol_Mat = "";
                            //List<BsonValue> consulta_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio = !item_CV_DAS.ToBsonDocument().GetElement("datos_adicionales_servicio").Value.IsBsonNull ? item_CV_DAS.ToBsonDocument().GetElement("datos_adicionales_servicio").Value.AsBsonArray.ToList():null;
                            //var consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det = itemPS_APROVISIONAMIENTO.GetElement("solicitud_entrega_materiales").ToBsonDocument().ToArray();
                            //var consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det = !itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("solicitud_entrega_materiales").IsBsonNull ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("solicitud_entrega_materiales").ToBsonDocument().AsQueryable().ToArray().ToList(): null;
                            var consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det = !itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("solicitud_entrega_materiales").IsBsonNull ? itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("solicitud_entrega_materiales").ToBsonDocument() : null;

                            //BsonDocument Consulta_PS_VIABILIDAD_CV_respuesta = Col_PS_VIABILIDAD_CV_respuesta.Find(filterPS_VIABILIDAD_CV_respuesta).FirstOrDefault<BsonDocument>();
                            if (consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det != null && consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.Count() > 0)
                            {
                                try
                                {
                                    try
                                    {
                                        sTextoDescarga_Sol_Mat = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_APROVISIONAMIENTO.ToBsonDocument(), "_id", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "fecha_creacion", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "usuario_creacion", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "fecha_actualizacion", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "usuario_modificacion", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "fecha_solicitud", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "id_empresa", 30));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "empresa", 200));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "nombre_receptor", 200));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "apellidos_receptor", 200));
                                        sTextoDescarga_Sol_Mat += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "identificacion_receptor", 30));
                                        sTextoDescarga_Sol_Mat = sTextoDescarga_Sol_Mat.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        if (sTextoDescarga_Sol_Mat != "")
                                        {
                                            Archivo_PS_Aprovi_Sol_Mat.WriteLine(sTextoDescarga_Sol_Mat);
                                            Conteo_PS_APROVISIONAMIENTO_Sol_Mat++;
                                            //if (!consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument().GetElement("usuarios_aprovadores").ToBsonDocument().IsBsonNull)
                                            //{
                                                  string id_empresa_in = string.Format("{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument(), "id_empresa", 30));
                                            //    Conteo_PS_APROVISIONAMIENTO_usua_aprov = Extractor_PS_APROVISIONAMIENTO_SolMat_Usu_Aprov(id_mongo, id_empresa_in);
                                            //}
                                            if (consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.ToBsonDocument().Contains("usuarios_aprovadores") && consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.GetElement("usuarios_aprovadores").Value.AsBsonArray.Count > 0)
                                            {
                                                Conteo_PS_APROVISIONAMIENTO_usua_aprov = Extractor_PS_APROVISIONAMIENTO_SolMat_Usu_Aprov(id_mongo, id_mongo,id_empresa_in, consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.GetElement("usuarios_aprovadores").Value.AsBsonArray.ToList(), out contador_gupos_lider);
                                            }

                                        }

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_solicitud_entrega_materiales Id: " + id_mongo + "," + itemPS_APROVISIONAMIENTO.ToBsonDocument().GetValue("_id").ToString());
                                        continue;
                                    }
                                    
                                }
                                catch (Exception ex)
                                {
                                    string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_solicitud_entrega_materiales para el procesamiento de registros de mongo Id: " + id_mongo);
                                    continue;
                                }
                            }

                        }

                        if (Conteo_PS_APROVISIONAMIENTO_Sol_Mat > 0)
                        {
                            Archivo_PS_Aprovi_Sol_Mat.Close();

                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Adjuntos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }
                            return Conteo_PS_APROVISIONAMIENTO_Sol_Mat;
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_solicitud_entrega_materiales entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_Aprovi_Sol_Mat.Close();
            }
            return Conteo_PS_APROVISIONAMIENTO_Sol_Mat;
        } //Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_PS_APROVISIONAMIENTO_SolMat_Usu_Aprov(string id_mongo, string id_aprovisionamiento, string id_empresa_in, List<BsonValue> listaOpciones, out int Conteo_PS_Aprovisionamiento_Grupos_Lider)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROVISIONAMIENTO_usuarios_aprovadores");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_Aprovi_Usu_Aprov = null;

            int Conteo_PS_APROVISIONAMIENTO_Usu_Aprov = 0;
            Conteo_PS_Aprovisionamiento_Grupos_Lider = 0;
            string sTextoDescarga_Usu_Aprov = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_02_06_01_USU_APRO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_Aprovi_Usu_Aprov = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                if (listaOpciones.Count() > 0)
                {
                    foreach (BsonValue consulta_PS_APROVISIONAMIENTO_Usu_Aprov in listaOpciones)
                    {
                        try
                        {
                            //BsonDocument respuesta = ((consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument().Contains("usuarios_aprovadores") && !consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument().GetElement("usuarios_aprovadores").Value.IsBsonNull) ? consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument().GetElement("usuarios_aprovadores").Value.AsBsonDocument : null);
                            //consulta_PS_APROVISIONAMIENTO_Sol_Mat_Det.AsQueryable().ToBsonDocument();
                            sTextoDescarga_Usu_Aprov = string.Format("{0}", id_mongo);
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", id_empresa_in); 
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "_id", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "fecha_creacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "usuario_creacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "fecha_actualizacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "usuario_modificacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "username", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "id_rol", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "rol", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "id_tipo_identificacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "tipo_identificacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "identificacion", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "nombres", 100));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "apellidos", 100));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "id_division", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "division", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "correo_electronico", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "telefono_fijo", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "telefono_celular", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "es_activo", 8));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "id_tipo_contrato", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "tipo_contrato", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "id_empresa", 30));
                            sTextoDescarga_Usu_Aprov += string.Format("~|{0}", ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "empresa", 200));
                            sTextoDescarga_Usu_Aprov = sTextoDescarga_Usu_Aprov.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            if (sTextoDescarga_Usu_Aprov != "")
                            {
                                Archivo_PS_Aprovi_Usu_Aprov.WriteLine(sTextoDescarga_Usu_Aprov);
                                Conteo_PS_APROVISIONAMIENTO_Usu_Aprov++;
                            }
                            if (consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument().Contains("grupos_lider") && !consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument().GetElement("grupos_lider").Value.IsBsonNull)
                            {
                                string id_usu_aprobado = ValidarDatoEnBsonValue(consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument(), "_id", 30);
                                List<BsonValue> consulta_PS_Aprov_Grup_Lider = consulta_PS_APROVISIONAMIENTO_Usu_Aprov.ToBsonDocument().GetElement("grupos_lider").Value.AsBsonArray.AsQueryable().ToList();
                                Conteo_PS_Aprovisionamiento_Grupos_Lider = Extractor_APROVISIONAMIENTO_Grupos_lider(id_mongo, id_empresa_in, id_usu_aprobado, consulta_PS_Aprov_Grup_Lider);
                            }
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_solicitud_entrega_materiales Id: " + id_mongo);
                            continue;
                        }
                    }
                }
                if (Conteo_PS_APROVISIONAMIENTO_Usu_Aprov > 0)
                {
                    Archivo_PS_Aprovi_Usu_Aprov.Close();

                    if (pruebas == false)
                    {
                        //PublicarArchivo.PublicarArchivoExtractores("PS_APROVISIONAMIENTO_Adjuntos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                    }
                    return Conteo_PS_APROVISIONAMIENTO_Usu_Aprov;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_Aprovi_Usu_Aprov.Close();
            }
            return Conteo_PS_APROVISIONAMIENTO_Usu_Aprov;
        }//Se ejecuta con Extractor_PS_APROVISIONAMIENTO()

        internal static int Extractor_APROVISIONAMIENTO_Grupos_lider(string idmongo, string id_empresa_in, string id_usu_aprobado, List<BsonValue> Lista_Grupos_Lider)
        {
            string path = ValidarRutaArchivos("PS_02_06_01_01_GRPL_");
            string sTextoDescarga_Grupos_Lider = string.Empty;
            int Conteo_PS_Aprovisionamiento_Grupos_lider = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_Aprovisionamiento_Grupos_Lider = string.Format("{0}{1}{2}.txt", path, "PS_02_06_01_01_GRPL_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_Aprovisionamiento_Grupos_lider = new StreamWriter(archivo_Aprovisionamiento_Grupos_Lider, true, Encoding.GetEncoding("iso-8859-1"));

            try
            {
                if (Lista_Grupos_Lider?.Count > 0)
                {
                    foreach (BsonValue idGrupo in Lista_Grupos_Lider)
                    {
                        sTextoDescarga_Grupos_Lider = string.Empty;

                        sTextoDescarga_Grupos_Lider = string.Format("{0}", idmongo);
                        sTextoDescarga_Grupos_Lider = string.Format("~|{0}", id_empresa_in);
                        sTextoDescarga_Grupos_Lider = string.Format("~|{0}", id_usu_aprobado);
                        sTextoDescarga_Grupos_Lider += string.Format("~|{0}", (idGrupo.AsString.Length > 30 ? idGrupo.AsString.Substring(0, 29) : idGrupo.AsString));
                        sTextoDescarga_Grupos_Lider = sTextoDescarga_Grupos_Lider.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                        Conteo_PS_Aprovisionamiento_Grupos_lider++;
                        Archivo_Aprovisionamiento_Grupos_lider.WriteLine(sTextoDescarga_Grupos_Lider);
                    }
                }

                Archivo_Aprovisionamiento_Grupos_lider.Close();
            }
            catch (Exception ex)
            {
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_APROVISIONAMIENTO_GRUPOS_LIDER_ entre el modelo de datos y de registros de mongo Id: " + idmongo);
            }
            return Conteo_PS_Aprovisionamiento_Grupos_lider;

        }

        internal static int Extractor_PS_APROVISIONAMIENTO_datos_adicionales(string idmongo, List<BsonValue> lista_datos_adicionales_aprov)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_APROVISIONAMIENTO_datos_adicionales");
            }
            StreamWriter Archivo_PS_APROVIONAMIENTO_datos_adicionales = null;
            int Conteo_APROVISIONAMIENTO_datos_adicionales = 0;
            string sTextoDescarga_APROV_datos_adicionales = string.Empty;
            string id_mongo = idmongo;
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_Aprovisionamiento_datos_adicionales = path + "PS_02_07_DATO_ADICIO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROVIONAMIENTO_datos_adicionales = new StreamWriter(archivo_Aprovisionamiento_datos_adicionales, true, System.Text.Encoding.GetEncoding("iso-8859-1"));
                if (lista_datos_adicionales_aprov.Count() > 0)
                {
                    // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PS_SERVICIO_CLIENTE_datos_adicionales_servicio 
                    Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_datos_adicionales encontrados " + lista_datos_adicionales_aprov.Count.ToString());
                    foreach (BsonValue itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio in lista_datos_adicionales_aprov)
                    {
                        try
                        {
                            try
                            {
                                sTextoDescarga_APROV_datos_adicionales = string.Empty;
                                sTextoDescarga_APROV_datos_adicionales = string.Format("{0}", id_mongo);
                                sTextoDescarga_APROV_datos_adicionales += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "identificador", 30));
                                sTextoDescarga_APROV_datos_adicionales += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "valor", 30));
                                sTextoDescarga_APROV_datos_adicionales = sTextoDescarga_APROV_datos_adicionales.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_datos_adicionales Id: " + id_mongo + "," + itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument().ToString());
                                continue;
                            }
                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                            try
                            {
                                if (sTextoDescarga_APROV_datos_adicionales != "")
                                {
                                    Archivo_PS_APROVIONAMIENTO_datos_adicionales.WriteLine(sTextoDescarga_APROV_datos_adicionales);
                                    Console.WriteLine(sTextoDescarga_APROV_datos_adicionales);
                                    Conteo_APROVISIONAMIENTO_datos_adicionales++;
                                }
                                //Console.WriteLine("PS_SERVICIO_CLIENTE_datos_adicionales_servicio ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_datos_adicionales_servicio actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVIONAMIENTO_datos_adicionales en mongo Id: " + id_mongo);
                                continue;
                            }
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_datos_adicionales para el procesamiento de registros de mongo Id: " + id_mongo);
                            continue;
                        }
                    }
                    Console.WriteLine("PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio ACTUALIZADA: " + id_mongo + "Numero de PS_APROVISIONAMIENTO_datos_adicionales actializadas: " + Conteo_APROVISIONAMIENTO_datos_adicionales);
                }
                if (Conteo_APROVISIONAMIENTO_datos_adicionales > 0)
                {
                    Archivo_PS_APROVIONAMIENTO_datos_adicionales.Close();
                }
                return Conteo_APROVISIONAMIENTO_datos_adicionales;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROVIONAMIENTO_datos_adicionales.Close();
            }
            return Conteo_APROVISIONAMIENTO_datos_adicionales;
        } //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE()

        internal static int Extractor_PS_APROVISIONAMIENTO_respuesta(string idmongo, List<BsonValue> lista_respuesta_aprov)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_APROVISIONAMIENTO_respuesta");
            }
            StreamWriter Archivo_PS_APROVIONAMIENTO_respuesta = null;
            int Conteo_APROVISIONAMIENTO_respuesta = 0;
            string sTextoDescarga_APROV_respuesta = string.Empty;
            string id_mongo = idmongo;
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_Aprovisionamiento_respuesta = path + "PS_02_08_APROV_RESPU_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_APROVIONAMIENTO_respuesta = new StreamWriter(archivo_Aprovisionamiento_respuesta, true, System.Text.Encoding.GetEncoding("iso-8859-1"));
                if (lista_respuesta_aprov.Count() > 0)
                {
                    // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PS_SERVICIO_CLIENTE_datos_adicionales_servicio 
                    Console.WriteLine("Registros en la coleccion de PS_APROVISIONAMIENTO_respuesta encontrados " + lista_respuesta_aprov.Count.ToString());
                    foreach (BsonValue itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio in lista_respuesta_aprov)
                    {
                        try
                        {
                            try
                            {
                                sTextoDescarga_APROV_respuesta = string.Empty;
                                sTextoDescarga_APROV_respuesta = string.Format("{0}", id_mongo);
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "fecha_creacion", 30));
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "usuario_creacion", 30));
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "fecha_actualizacion", 30));
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "usuario_modificacion", 30));
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "id_causal_finalizacion", 30));
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "causal_finalizacion", 30));
                                sTextoDescarga_APROV_respuesta += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "observaciones_finalizacion", 200));
                                sTextoDescarga_APROV_respuesta = sTextoDescarga_APROV_respuesta.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_APROVISIONAMIENTO_respuesta Id: " + id_mongo + "," + itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument().ToString());
                                continue;
                            }
                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                            try
                            {
                                if (sTextoDescarga_APROV_respuesta != "")
                                {
                                    Archivo_PS_APROVIONAMIENTO_respuesta.WriteLine(sTextoDescarga_APROV_respuesta);
                                    Console.WriteLine(sTextoDescarga_APROV_respuesta);
                                    Conteo_APROVISIONAMIENTO_respuesta++;
                                }
                                //Console.WriteLine("PS_SERVICIO_CLIENTE_datos_adicionales_servicio ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_datos_adicionales_servicio actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_APROVISIONAMIENTO_respuesta en mongo Id: " + id_mongo);
                                continue;
                            }
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_APROVISIONAMIENTO_respuesta para el procesamiento de registros de mongo Id: " + id_mongo);
                            continue;
                        }
                    }
                    Console.WriteLine("PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio ACTUALIZADA: " + id_mongo + "Numero de PS_APROVISIONAMIENTO_respuesta actializadas: " + Conteo_APROVISIONAMIENTO_respuesta);
                }
                if (Conteo_APROVISIONAMIENTO_respuesta > 0)
                {
                    Archivo_PS_APROVIONAMIENTO_respuesta.Close();
                }
                return Conteo_APROVISIONAMIENTO_respuesta;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_APROVIONAMIENTO_respuesta.Close();
            }
            return Conteo_APROVISIONAMIENTO_respuesta;
        } //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE()

        internal static void Extractor_PS_ATRIBUTO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_ATRIBUTO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_ATRIBUTO = null;

            int Conteo_PS_ATRIBUTO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_ATRIBUTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_ATRIBUTO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_ATRIBUTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_ATRIBUTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_ATRIBUTO = builderPS_ATRIBUTO.Empty;

                if (tipo == "")
                {
                    filterPS_ATRIBUTO = builderPS_ATRIBUTO.Or(builderPS_ATRIBUTO.Eq("Actualizacion_Extractor", "1"), !builderPS_ATRIBUTO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_ATRIBUTO = builderPS_ATRIBUTO.And(builderPS_ATRIBUTO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_ATRIBUTO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_ATRIBUTO = Col_PS.Find(filterPS_ATRIBUTO).ToList();

                if (consulta_PS_ATRIBUTO != null && consulta_PS_ATRIBUTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_ATRIBUTO encontrados " + consulta_PS_ATRIBUTO.Count.ToString());
                        foreach (BsonDocument itemPS_ATRIBUTO in consulta_PS_ATRIBUTO)
                        {
                            id_mongo = itemPS_ATRIBUTO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_ATRIBUTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_ATRIBUTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_ATRIBUTO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_ATRIBUTO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("_id")?.ToString()) ? (itemPS_ATRIBUTO.GetValue("_id").ToString().Length > 30 ? itemPS_ATRIBUTO.GetValue("_id").ToString().Substring(0, 29) : itemPS_ATRIBUTO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("fecha_creacion") && !itemPS_ATRIBUTO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("fecha_creacion").ToString()) ? (itemPS_ATRIBUTO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_ATRIBUTO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_ATRIBUTO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("usuario_creacion") && !itemPS_ATRIBUTO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("usuario_creacion").ToString()) ? (itemPS_ATRIBUTO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_ATRIBUTO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_ATRIBUTO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("fecha_actualizacion") && !itemPS_ATRIBUTO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_ATRIBUTO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_ATRIBUTO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_ATRIBUTO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("usuario_modificacion") && !itemPS_ATRIBUTO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("usuario_modificacion").ToString()) ? (itemPS_ATRIBUTO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_ATRIBUTO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_ATRIBUTO.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("nombre") ? !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("nombre")?.ToString()) ? (itemPS_ATRIBUTO.GetValue("nombre").ToString().Length > 30 ? itemPS_ATRIBUTO.GetValue("nombre").ToString().Substring(0, 29) : itemPS_ATRIBUTO.GetValue("nombre").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("es_activo") && !itemPS_ATRIBUTO.GetValue("es_activo").IsBsonNull ? itemPS_ATRIBUTO.GetValue("es_activo").ToString().Length > 8 ? itemPS_ATRIBUTO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_ATRIBUTO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("atributo_sap") && !itemPS_ATRIBUTO.GetValue("atributo_sap").IsBsonNull && !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("atributo_sap").ToString()) ? (itemPS_ATRIBUTO.GetValue("atributo_sap").ToString().Length > 10 ? itemPS_ATRIBUTO.GetValue("atributo_sap").ToString().Substring(0, 10) : itemPS_ATRIBUTO.GetValue("atributo_sap").ToString()) : "") + //VARCHAR(40) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("descripcion") && !itemPS_ATRIBUTO.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("descripcion").ToString()) ? (itemPS_ATRIBUTO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_ATRIBUTO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_ATRIBUTO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ATRIBUTO.Contains("tipo_dato") && !itemPS_ATRIBUTO.GetValue("tipo_dato").IsBsonNull && !string.IsNullOrEmpty(itemPS_ATRIBUTO.GetValue("tipo_dato").ToString()) ? (itemPS_ATRIBUTO.GetValue("tipo_dato").ToString().Length > 10 ? itemPS_ATRIBUTO.GetValue("tipo_dato").ToString().Substring(0, 10) : itemPS_ATRIBUTO.GetValue("tipo_dato").ToString()) : ""); //VARCHAR(40) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_ATRIBUTO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_ATRIBUTO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_ATRIBUTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_ATRIBUTO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_ATRIBUTO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_ATRIBUTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_ATRIBUTO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_ATRIBUTO ACTUALIZADA: " + itemPS_ATRIBUTO.GetValue("_id").ToString() + "Numero de PS_ATRIBUTO actializadas: " + Conteo_PS_ATRIBUTO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_ATRIBUTO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_ATRIBUTO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_ATRIBUTO > 0)
                        {
                            Archivo_PS_ATRIBUTO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_ATRIBUTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_ATRIBUTO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_ATRIBUTO.Close();
            }

        }

        internal static void Extractor_PS_BODEGA(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_BODEGA");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_BODEGA = null;

            int Conteo_PS_BODEGA = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_BODEGA_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_BODEGA = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_BODEGA");
                FilterDefinitionBuilder<BsonDocument> builderPS_BODEGA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_BODEGA = builderPS_BODEGA.Empty;

                if (tipo == "")
                {
                    filterPS_BODEGA = builderPS_BODEGA.Or(builderPS_BODEGA.Eq("Actualizacion_Extractor", "1"), !builderPS_BODEGA.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_BODEGA = builderPS_BODEGA.And(builderPS_BODEGA.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_BODEGA.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_BODEGA = Col_PS.Find(filterPS_BODEGA).ToList();

                if (consulta_PS_BODEGA != null && consulta_PS_BODEGA.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_BODEGA encontrados " + consulta_PS_BODEGA.Count.ToString());
                        foreach (BsonDocument itemPS_BODEGA in consulta_PS_BODEGA)
                        {
                            id_mongo = itemPS_BODEGA.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_BODEGA.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_BODEGA.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_BODEGA.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_BODEGA.Contains("_id") ? !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("_id")?.ToString()) ? (itemPS_BODEGA.GetValue("_id").ToString().Length > 30 ? itemPS_BODEGA.GetValue("_id").ToString().Substring(0, 29) : itemPS_BODEGA.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("nombre_bodega") ? !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("nombre_bodega")?.ToString()) ? (itemPS_BODEGA.GetValue("nombre_bodega").ToString().Length > 30 ? itemPS_BODEGA.GetValue("nombre_bodega").ToString().Substring(0, 29) : itemPS_BODEGA.GetValue("nombre_bodega").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("ubicacion_bodega") ? !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("ubicacion_bodega")?.ToString()) ? (itemPS_BODEGA.GetValue("ubicacion_bodega").ToString().Length > 30 ? itemPS_BODEGA.GetValue("ubicacion_bodega").ToString().Substring(0, 29) : itemPS_BODEGA.GetValue("ubicacion_bodega").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("id_usuario") ? !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("id_usuario")?.ToString()) ? (itemPS_BODEGA.GetValue("id_usuario").ToString().Length > 30 ? itemPS_BODEGA.GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_BODEGA.GetValue("id_usuario").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_BODEGA.Contains("responsable") && !itemPS_BODEGA.GetValue("responsable").IsBsonNull && !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("responsable").ToString()) ? (itemPS_BODEGA.GetValue("responsable").ToString().Length > 50 ? itemPS_BODEGA.GetValue("responsable").ToString().Substring(0, 50) : itemPS_BODEGA.GetValue("responsable").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("contratista") && !itemPS_BODEGA.GetValue("contratista").IsBsonNull && !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("contratista").ToString()) ? (itemPS_BODEGA.GetValue("contratista").ToString().Length > 50 ? itemPS_BODEGA.GetValue("contratista").ToString().Substring(0, 50) : itemPS_BODEGA.GetValue("contratista").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("es_sap") && !itemPS_BODEGA.GetValue("es_sap").IsBsonNull ? itemPS_BODEGA.GetValue("es_sap").ToString().Length > 8 ? itemPS_BODEGA.GetValue("es_sap").ToString().Substring(0, 8) : itemPS_BODEGA.GetValue("es_sap").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("es_activo") && !itemPS_BODEGA.GetValue("es_activo").IsBsonNull ? itemPS_BODEGA.GetValue("es_activo").ToString().Length > 8 ? itemPS_BODEGA.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_BODEGA.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("fecha_creacion") && !itemPS_BODEGA.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("fecha_creacion").ToString()) ? (itemPS_BODEGA.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_BODEGA.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_BODEGA.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("usuario_creacion") && !itemPS_BODEGA.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("usuario_creacion").ToString()) ? (itemPS_BODEGA.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_BODEGA.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_BODEGA.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("fecha_actualizacion") && !itemPS_BODEGA.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("fecha_actualizacion").ToString()) ? (itemPS_BODEGA.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_BODEGA.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_BODEGA.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_BODEGA.Contains("usuario_modificacion") && !itemPS_BODEGA.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_BODEGA.GetValue("usuario_modificacion").ToString()) ? (itemPS_BODEGA.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_BODEGA.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_BODEGA.GetValue("usuario_modificacion").ToString()) : "");// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,

                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_BODEGA Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_BODEGA.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_BODEGA.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_BODEGA++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_BODEGA.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_BODEGA.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_BODEGA++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_BODEGA ACTUALIZADA: " + itemPS_BODEGA.GetValue("_id").ToString() + "Numero de PS_BODEGA actializadas: " + Conteo_PS_BODEGA);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_BODEGA en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_BODEGA para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_BODEGA > 0)
                        {
                            Archivo_PS_BODEGA.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_BODEGA_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_BODEGA entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_BODEGA.Close();
            }

        }

        internal static void Extractor_PS_CAMPO_DINAMICO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_CAMPO_DINAMICO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_CAMPO_DINAMICO = null;

            int Conteo_PS_CAMPO_DINAMICO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_CAMPO_DINAMICO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_CAMPO_DINAMICO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_CAMPO_DINAMICO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CAMPO_DINAMICO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CAMPO_DINAMICO = builderPS_CAMPO_DINAMICO.Empty;

                if (tipo == "")
                {
                    filterPS_CAMPO_DINAMICO = builderPS_CAMPO_DINAMICO.Or(builderPS_CAMPO_DINAMICO.Eq("Actualizacion_Extractor", "1"), !builderPS_CAMPO_DINAMICO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_CAMPO_DINAMICO = builderPS_CAMPO_DINAMICO.And(builderPS_CAMPO_DINAMICO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_CAMPO_DINAMICO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CAMPO_DINAMICO = Col_PS.Find(filterPS_CAMPO_DINAMICO).ToList();

                if (consulta_PS_CAMPO_DINAMICO != null && consulta_PS_CAMPO_DINAMICO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CAMPO_DINAMICO encontrados " + consulta_PS_CAMPO_DINAMICO.Count.ToString());
                        foreach (BsonDocument itemPS_CAMPO_DINAMICO in consulta_PS_CAMPO_DINAMICO)
                        {
                            id_mongo = itemPS_CAMPO_DINAMICO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_CAMPO_DINAMICO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_CAMPO_DINAMICO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_CAMPO_DINAMICO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_CAMPO_DINAMICO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_CAMPO_DINAMICO.GetValue("_id")?.ToString()) ? (itemPS_CAMPO_DINAMICO.GetValue("_id").ToString().Length > 30 ? itemPS_CAMPO_DINAMICO.GetValue("_id").ToString().Substring(0, 29) : itemPS_CAMPO_DINAMICO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("nombre") ? !string.IsNullOrEmpty(itemPS_CAMPO_DINAMICO.GetValue("nombre")?.ToString()) ? (itemPS_CAMPO_DINAMICO.GetValue("nombre").ToString().Length > 30 ? itemPS_CAMPO_DINAMICO.GetValue("nombre").ToString().Substring(0, 29) : itemPS_CAMPO_DINAMICO.GetValue("nombre").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("tipo") ? !string.IsNullOrEmpty(itemPS_CAMPO_DINAMICO.GetValue("tipo")?.ToString()) ? (itemPS_CAMPO_DINAMICO.GetValue("tipo").ToString().Length > 30 ? itemPS_CAMPO_DINAMICO.GetValue("tipo").ToString().Substring(0, 29) : itemPS_CAMPO_DINAMICO.GetValue("tipo").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("es_respuesta") && !itemPS_CAMPO_DINAMICO.GetValue("es_respuesta").IsBsonNull ? itemPS_CAMPO_DINAMICO.GetValue("es_respuesta").ToString().Length > 8 ? itemPS_CAMPO_DINAMICO.GetValue("es_respuesta").ToString().Substring(0, 8) : itemPS_CAMPO_DINAMICO.GetValue("es_respuesta").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("es_activo") && !itemPS_CAMPO_DINAMICO.GetValue("es_activo").IsBsonNull ? itemPS_CAMPO_DINAMICO.GetValue("es_activo").ToString().Length > 8 ? itemPS_CAMPO_DINAMICO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_CAMPO_DINAMICO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("es_inventario") && !itemPS_CAMPO_DINAMICO.GetValue("es_inventario").IsBsonNull ? itemPS_CAMPO_DINAMICO.GetValue("es_inventario").ToString().Length > 8 ? itemPS_CAMPO_DINAMICO.GetValue("es_inventario").ToString().Substring(0, 8) : itemPS_CAMPO_DINAMICO.GetValue("es_inventario").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("id_lista") ? !string.IsNullOrEmpty(itemPS_CAMPO_DINAMICO.GetValue("id_lista")?.ToString()) ? (itemPS_CAMPO_DINAMICO.GetValue("id_lista").ToString().Length > 30 ? itemPS_CAMPO_DINAMICO.GetValue("id_lista").ToString().Substring(0, 29) : itemPS_CAMPO_DINAMICO.GetValue("id_lista").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("apiname") && !itemPS_CAMPO_DINAMICO.GetValue("apiname").IsBsonNull && !string.IsNullOrEmpty(itemPS_CAMPO_DINAMICO.GetValue("apiname").ToString()) ? (itemPS_CAMPO_DINAMICO.GetValue("apiname").ToString().Length > 50 ? itemPS_CAMPO_DINAMICO.GetValue("apiname").ToString().Substring(0, 50) : itemPS_CAMPO_DINAMICO.GetValue("apiname").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CAMPO_DINAMICO.Contains("agrupador") && !itemPS_CAMPO_DINAMICO.GetValue("agrupador").IsBsonNull && !string.IsNullOrEmpty(itemPS_CAMPO_DINAMICO.GetValue("agrupador").ToString()) ? (itemPS_CAMPO_DINAMICO.GetValue("agrupador").ToString().Length > 50 ? itemPS_CAMPO_DINAMICO.GetValue("agrupador").ToString().Substring(0, 50) : itemPS_CAMPO_DINAMICO.GetValue("agrupador").ToString()) : ""); // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,


                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_CAMPO_DINAMICO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_CAMPO_DINAMICO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CAMPO_DINAMICO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_CAMPO_DINAMICO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_CAMPO_DINAMICO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CAMPO_DINAMICO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_CAMPO_DINAMICO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_CAMPO_DINAMICO ACTUALIZADA: " + itemPS_CAMPO_DINAMICO.GetValue("_id").ToString() + "Numero de PS_CAMPO_DINAMICO actializadas: " + Conteo_PS_CAMPO_DINAMICO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_CAMPO_DINAMICO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_CAMPO_DINAMICO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_CAMPO_DINAMICO > 0)
                        {
                            Archivo_PS_CAMPO_DINAMICO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_CAMPO_DINAMICO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_CAMPO_DINAMICO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_CAMPO_DINAMICO.Close();
            }

        }

        internal static void Extractor_PS_COMUNICACION(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_COMUNICACION");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_COMUNICACION = null;

            int Conteo_PS_COMUNICACION = 0;
            int Destinatarios = 0;
            int Adjuntos = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_COMUNICACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_COMUNICACION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_COMUNICACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_COMUNICACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_COMUNICACION = builderPS_COMUNICACION.Empty;

                if (tipo == "")
                {
                    filterPS_COMUNICACION = builderPS_COMUNICACION.Or(builderPS_COMUNICACION.Eq("Actualizacion_Extractor", "1"), !builderPS_COMUNICACION.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_COMUNICACION = builderPS_COMUNICACION.And(builderPS_COMUNICACION.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_COMUNICACION.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_COMUNICACION = Col_PS.Find(filterPS_COMUNICACION).ToList();

                if (consulta_PS_COMUNICACION != null && consulta_PS_COMUNICACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_COMUNICACION encontrados " + consulta_PS_COMUNICACION.Count.ToString());
                        foreach (BsonDocument itemPS_COMUNICACION in consulta_PS_COMUNICACION)
                        {
                            id_mongo = itemPS_COMUNICACION.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_COMUNICACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_COMUNICACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_COMUNICACION.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_COMUNICACION.Contains("_id") ? !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("_id")?.ToString()) ? (itemPS_COMUNICACION.GetValue("_id").ToString().Length > 30 ? itemPS_COMUNICACION.GetValue("_id").ToString().Substring(0, 29) : itemPS_COMUNICACION.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("fecha_creacion") && !itemPS_COMUNICACION.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("fecha_creacion").ToString()) ? (itemPS_COMUNICACION.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_COMUNICACION.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_COMUNICACION.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("usuario_creacion") && !itemPS_COMUNICACION.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("usuario_creacion").ToString()) ? (itemPS_COMUNICACION.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_COMUNICACION.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_COMUNICACION.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("fecha_actualizacion") && !itemPS_COMUNICACION.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("fecha_actualizacion").ToString()) ? (itemPS_COMUNICACION.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_COMUNICACION.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_COMUNICACION.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("usuario_modificacion") && !itemPS_COMUNICACION.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("usuario_modificacion").ToString()) ? (itemPS_COMUNICACION.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_COMUNICACION.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_COMUNICACION.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("asunto") && !itemPS_COMUNICACION.GetValue("asunto").IsBsonNull && !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("asunto").ToString()) ? (itemPS_COMUNICACION.GetValue("asunto").ToString().Length > 50 ? itemPS_COMUNICACION.GetValue("asunto").ToString().Substring(0, 50) : itemPS_COMUNICACION.GetValue("asunto").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("mensaje_html") ? !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("mensaje_html")?.ToString()) ? (itemPS_COMUNICACION.GetValue("mensaje_html").ToString().Length > 30 ? itemPS_COMUNICACION.GetValue("mensaje_html").ToString().Substring(0, 29) : itemPS_COMUNICACION.GetValue("mensaje_html").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_COMUNICACION.Contains("id_tarea_realcionada") ? !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("id_tarea_realcionada")?.ToString()) ? (itemPS_COMUNICACION.GetValue("id_tarea_realcionada").ToString().Length > 30 ? itemPS_COMUNICACION.GetValue("id_tarea_realcionada").ToString().Substring(0, 29) : itemPS_COMUNICACION.GetValue("id_tarea_realcionada").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_COMUNICACION.Contains("tarea_realcionada") && !itemPS_COMUNICACION.GetValue("tarea_realcionada").IsBsonNull && !string.IsNullOrEmpty(itemPS_COMUNICACION.GetValue("tarea_realcionada").ToString()) ? (itemPS_COMUNICACION.GetValue("tarea_realcionada").ToString().Length > 50 ? itemPS_COMUNICACION.GetValue("tarea_realcionada").ToString().Substring(0, 50) : itemPS_COMUNICACION.GetValue("tarea_realcionada").ToString()) : ""); // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        Destinatarios += Extractor_PS_COMUNICACION_Destinatarios(id_mongo);
                                        Adjuntos += Extractor_PS_COMUNICACION_adjuntos_comunicaciones(id_mongo);

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_COMUNICACION Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_COMUNICACION.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_COMUNICACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_COMUNICACION++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_COMUNICACION.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_COMUNICACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_COMUNICACION++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_COMUNICACION ACTUALIZADA: " + itemPS_COMUNICACION.GetValue("_id").ToString() + "Numero de PS_COMUNICACION actializadas: " + Conteo_PS_COMUNICACION);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_COMUNICACION en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_COMUNICACION para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_COMUNICACION > 0)
                        {
                            Archivo_PS_COMUNICACION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_COMUNICACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");

                                if (Destinatarios > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_COMUNICACION_Destinatarios_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (Adjuntos > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores(""PS_COMUNICACION_adjuntos_comunicaciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }

                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_COMUNICACION entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_COMUNICACION.Close();
            }

        }

        internal static int Extractor_PS_COMUNICACION_Destinatarios(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_COMUNICACION_Destinatarios");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_COMUNICACION_Destinatarios = null;

            int Conteo_PS_COMUNICACION_Destinatarios = 0;
            string sTextoDescarga = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_COMUNICACION_Destinatarios_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_COMUNICACION_Destinatarios = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_COMUNICACION = db.GetCollection<BsonDocument>("PS_COMUNICACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_COMUNICACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_COMUNICACION = builderPS_COMUNICACION.Empty;
                filterPS_COMUNICACION = builderPS_COMUNICACION.And(
                builderPS_COMUNICACION.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_COMUNICACION.SizeGte("destinatarios", 1));


                List<BsonDocument> consulta_PS_COMUNICACION = Col_PS_COMUNICACION.Find(filterPS_COMUNICACION).ToList();

                if (consulta_PS_COMUNICACION != null && consulta_PS_COMUNICACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_COMUNICACION_Destinatarios encontrados " + consulta_PS_COMUNICACION.Count.ToString());
                        foreach (BsonDocument itemPS_COMUNICACION in consulta_PS_COMUNICACION)
                        {
                            id_mongo = itemPS_COMUNICACION.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_COMUNICACION_Destinatarios = itemPS_COMUNICACION.GetElement("destinatarios").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_COMUNICACION_Destinatarios != null && consulta_PS_COMUNICACION_Destinatarios.Count() > 0)
                            {
                                foreach (BsonValue itemPS_COMUNICACION_Destinatarios in consulta_PS_COMUNICACION_Destinatarios)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga =
                                            (itemPS_COMUNICACION.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_COMUNICACION.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_COMUNICACION.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_COMUNICACION.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_COMUNICACION.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            "~|" + (itemPS_COMUNICACION_Destinatarios.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_COMUNICACION_Destinatarios Id: " + id_mongo + "," + itemPS_COMUNICACION_Destinatarios.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga != "")
                                            {
                                                Archivo_PS_COMUNICACION_Destinatarios.WriteLine(sTextoDescarga);
                                                Console.WriteLine(sTextoDescarga);
                                                Conteo_PS_COMUNICACION_Destinatarios++;
                                            }
                                            //Console.WriteLine("PS_COMUNICACION_Destinatarios ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_COMUNICACION_Destinatarios actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_COMUNICACION_Destinatarios en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_COMUNICACION_Destinatarios para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_COMUNICACION_Destinatarios ACTUALIZADA: " + itemPS_COMUNICACION.GetValue("_id").ToString() + "Numero de PS_COMUNICACION_Destinatarios actializadas: " + Conteo_PS_COMUNICACION_Destinatarios);
                            }

                        }

                        if (Conteo_PS_COMUNICACION_Destinatarios > 0)
                        {
                            Archivo_PS_COMUNICACION_Destinatarios.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_COMUNICACION_Destinatarios entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_COMUNICACION_Destinatarios;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_COMUNICACION_Destinatarios.Close();

            }
            return Conteo_PS_COMUNICACION_Destinatarios;
        } //Se ejecuta con Extractor_PS_COMUNICACION()

        internal static int Extractor_PS_COMUNICACION_adjuntos_comunicaciones(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_COMUNICACION_adjuntos_comunicaciones");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_COMUNICACION_adjuntos_comunicaciones = null;

            int Conteo_PS_COMUNICACION_adjuntos_comunicaciones = 0;
            string sTextoDescarga = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_COMUNICACION_adjuntos_comunicaciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_COMUNICACION_adjuntos_comunicaciones = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_COMUNICACION = db.GetCollection<BsonDocument>("PS_COMUNICACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_COMUNICACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_COMUNICACION = builderPS_COMUNICACION.Empty;
                filterPS_COMUNICACION = builderPS_COMUNICACION.And(
                builderPS_COMUNICACION.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_COMUNICACION.SizeGte("adjuntos_comunicaciones", 1));


                List<BsonDocument> consulta_PS_COMUNICACION = Col_PS_COMUNICACION.Find(filterPS_COMUNICACION).ToList();

                if (consulta_PS_COMUNICACION != null && consulta_PS_COMUNICACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_COMUNICACION_adjuntos_comunicaciones encontrados " + consulta_PS_COMUNICACION.Count.ToString());
                        foreach (BsonDocument itemPS_COMUNICACION in consulta_PS_COMUNICACION)
                        {
                            id_mongo = itemPS_COMUNICACION.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_COMUNICACION_adjuntos_comunicaciones = itemPS_COMUNICACION.GetElement("adjuntos_comunicaciones").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_COMUNICACION_adjuntos_comunicaciones != null && consulta_PS_COMUNICACION_adjuntos_comunicaciones.Count() > 0)
                            {
                                foreach (BsonValue itemPS_COMUNICACION_adjuntos_comunicaciones in consulta_PS_COMUNICACION_adjuntos_comunicaciones)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga =
                                            (itemPS_COMUNICACION.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_COMUNICACION.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_COMUNICACION.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_COMUNICACION.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_COMUNICACION.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            "~|" + (itemPS_COMUNICACION_adjuntos_comunicaciones.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_COMUNICACION_adjuntos_comunicaciones Id: " + id_mongo + "," + itemPS_COMUNICACION_adjuntos_comunicaciones.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga != "")
                                            {
                                                Archivo_PS_COMUNICACION_adjuntos_comunicaciones.WriteLine(sTextoDescarga);
                                                Console.WriteLine(sTextoDescarga);
                                                Conteo_PS_COMUNICACION_adjuntos_comunicaciones++;
                                            }
                                            //Console.WriteLine("PS_COMUNICACION_adjuntos_comunicaciones ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_COMUNICACION_adjuntos_comunicaciones actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_COMUNICACION_adjuntos_comunicaciones en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_COMUNICACION_adjuntos_comunicaciones para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_COMUNICACION_adjuntos_comunicaciones ACTUALIZADA: " + itemPS_COMUNICACION.GetValue("_id").ToString() + "Numero de PS_COMUNICACION_adjuntos_comunicaciones actializadas: " + Conteo_PS_COMUNICACION_adjuntos_comunicaciones);
                            }

                        }

                        if (Conteo_PS_COMUNICACION_adjuntos_comunicaciones > 0)
                        {
                            Archivo_PS_COMUNICACION_adjuntos_comunicaciones.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_COMUNICACION_adjuntos_comunicaciones entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_COMUNICACION_adjuntos_comunicaciones;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_COMUNICACION_adjuntos_comunicaciones.Close();

            }
            return Conteo_PS_COMUNICACION_adjuntos_comunicaciones;
        } //Se ejecuta con Extractor_PS_COMUNICACION()

        internal static void Extractor_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = null;

            int Conteo_PS_COMUNICACION = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Empty;

                if (tipo == "")
                {
                    filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Or(builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Eq("Actualizacion_Extractor", "1"), !builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.And(builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = Col_PS.Find(filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO).ToList();

                if (consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO != null && consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO encontrados " + consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Count.ToString());
                        foreach (BsonDocument itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO in consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO)
                        {
                            id_mongo = itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id")?.ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString().Length > 30 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString().Substring(0, 29) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("fecha_creacion") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_creacion").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("usuario_creacion") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_creacion").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("fecha_actualizacion") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("usuario_modificacion") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_modificacion").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("id_producto") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("id_producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("id_producto").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("id_producto").ToString().Length > 50 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("id_producto").ToString().Substring(0, 50) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("id_producto").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("producto") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("producto").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("producto").ToString().Length > 50 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("producto").ToString().Substring(0, 50) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("producto").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("es_activo") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("es_activo").IsBsonNull ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("es_activo").ToString().Length > 8 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Contains("observaciones") && !itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("observaciones").IsBsonNull ? !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("observaciones").ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "");// VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_COMUNICACION++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_COMUNICACION++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO ACTUALIZADA: " + itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.GetValue("_id").ToString() + "Numero de PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO actializadas: " + Conteo_PS_COMUNICACION);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_COMUNICACION > 0)
                        {
                            Archivo_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");                               
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Close();
            }

        }

        internal static void Extractor_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo _PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos = null;

            int Conteo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = db.GetCollection<BsonDocument>("PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Empty;

                if (tipo == "")
                {
                    filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Or(builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Eq("campos_dinamicos.Actualizacion_Extractor", "1"), !builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Exists("campos_dinamicos.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.And(builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Gte("campos_dinamicos.Fecha_extraccion", fechaconsulta.Date), builderPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Lt("campos_dinamicos.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO = Col_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Find(filterPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO).ToList();

                if (consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO != null && consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos encontrados " + consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.Count.ToString());
                        foreach (BsonDocument itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos in consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO)
                        {
                            id_mongo = itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos = itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.GetElement("campos_dinamicos").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos != null && consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos.Count() > 0)
                            {
                                foreach (BsonValue itemCampos_Dinamicos in consulta_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemCampos_Dinamicos.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemCampos_Dinamicos.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemCampos_Dinamicos.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("_id") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").IsBsonNull && !string.IsNullOrEmpty(itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").ToString()) ? (itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("nombre") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemCampos_Dinamicos.ToBsonDocument().GetValue("nombre").ToString()) ? (itemCampos_Dinamicos.ToBsonDocument().GetValue("nombre").ToString().Length > 50 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("nombre").ToString().Substring(0, 50) : itemCampos_Dinamicos.ToBsonDocument().GetValue("nombre").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("es_respuesta") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("es_respuesta").IsBsonNull ? itemCampos_Dinamicos.ToBsonDocument().GetValue("es_respuesta").ToString().Length > 8 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("es_respuesta").ToString().Substring(0, 8) : itemCampos_Dinamicos.ToBsonDocument().GetValue("es_respuesta").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("es_activo") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("es_activo").IsBsonNull ? itemCampos_Dinamicos.ToBsonDocument().GetValue("es_activo").ToString().Length > 8 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("es_activo").ToString().Substring(0, 8) : itemCampos_Dinamicos.ToBsonDocument().GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("es_inventario") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("es_inventario").IsBsonNull ? itemCampos_Dinamicos.ToBsonDocument().GetValue("es_inventario").ToString().Length > 8 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("es_inventario").ToString().Substring(0, 8) : itemCampos_Dinamicos.ToBsonDocument().GetValue("es_inventario").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("id_lista") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("id_lista").IsBsonNull && !string.IsNullOrEmpty(itemCampos_Dinamicos.ToBsonDocument().GetValue("id_lista").ToString()) ? (itemCampos_Dinamicos.ToBsonDocument().GetValue("id_lista").ToString().Length > 30 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("id_lista").ToString().Substring(0, 29) : itemCampos_Dinamicos.ToBsonDocument().GetValue("id_lista").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("apiname") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("apiname").IsBsonNull && !string.IsNullOrEmpty(itemCampos_Dinamicos.ToBsonDocument().GetValue("apiname").ToString()) ? (itemCampos_Dinamicos.ToBsonDocument().GetValue("apiname").ToString().Length > 30 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("apiname").ToString().Substring(0, 29) : itemCampos_Dinamicos.ToBsonDocument().GetValue("apiname").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("agrupador") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("agrupador").IsBsonNull && !string.IsNullOrEmpty(itemCampos_Dinamicos.ToBsonDocument().GetValue("agrupador").ToString()) ? (itemCampos_Dinamicos.ToBsonDocument().GetValue("agrupador").ToString().Length > 30 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("agrupador").ToString().Substring(0, 29) : itemCampos_Dinamicos.ToBsonDocument().GetValue("agrupador").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemCampos_Dinamicos.ToBsonDocument().Contains("orden_visualizacion") && !itemCampos_Dinamicos.ToBsonDocument().GetValue("orden_visualizador").IsBsonNull && !string.IsNullOrEmpty(itemCampos_Dinamicos.ToBsonDocument().GetValue("orden_visualizador").ToString()) ? (itemCampos_Dinamicos.ToBsonDocument().GetValue("orden_visualizador").ToString().Length > 30 ? itemCampos_Dinamicos.ToBsonDocument().GetValue("orden_visualizador").ToString().Substring(0, 29) : itemCampos_Dinamicos.ToBsonDocument().GetValue("orden_visualizador").ToString()) : "");
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de _PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos Id: " + id_mongo + "," + itemCampos_Dinamicos.ToBsonDocument().GetValue("id_inventario").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("campos_dinamicos._id", itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("campos_dinamicos.Actualizacion_Extractor", "0")
                                                                                                .Set("campos_dinamicos.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemCampos_Dinamicos.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("campos_dinamicos._id", itemCampos_Dinamicos.ToBsonDocument().GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("campos_dinamicos.Actualizacion_Extractor", "0")
                                                                                                .Set("campos_dinamicos.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos ACTUALIZADA: " + itemPS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_Campos.GetValue("_id").ToString() + "Numero de _PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos actializadas: " + Conteo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en _PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion _PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos > 0)
                        {
                            Archivo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("_PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en _PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo__PS_CONFIG_CAMPOS_RESPUESTA_PRODUCTO_campos_dinamicos.Close();
            }

        }

        internal static void Extractor_PS_CONFIG_SERVICIO_PRODUCTO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_CONFIG_SERVICIO_PRODUCTO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_CONFIG_SERVICIO_PRODUCTO = null;

            int Conteo_PS_CONFIG_SERVICIO_PRODUCTO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;


            string archivo = path + "PS_CONFIG_SERVICIO_PRODUCTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_CONFIG_SERVICIO_PRODUCTO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_CONFIG_SERVICIO_PRODUCTO = db.GetCollection<BsonDocument>("PS_CONFIG_SERVICIO_PRODUCTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CONFIG_SERVICIO_PRODUCTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CONFIG_SERVICIO_PRODUCTO = builderPS_CONFIG_SERVICIO_PRODUCTO.Empty;

                if (tipo == "")
                {
                    filterPS_CONFIG_SERVICIO_PRODUCTO = builderPS_CONFIG_SERVICIO_PRODUCTO.Or(builderPS_CONFIG_SERVICIO_PRODUCTO.Eq("Actualizacion_Extractor", "1"), !builderPS_CONFIG_SERVICIO_PRODUCTO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_CONFIG_SERVICIO_PRODUCTO = builderPS_CONFIG_SERVICIO_PRODUCTO.And(builderPS_CONFIG_SERVICIO_PRODUCTO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_CONFIG_SERVICIO_PRODUCTO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CONFIG_SERVICIO_PRODUCTO = Col_PS_CONFIG_SERVICIO_PRODUCTO.Find(filterPS_CONFIG_SERVICIO_PRODUCTO).ToList();

                if (consulta_PS_CONFIG_SERVICIO_PRODUCTO != null && consulta_PS_CONFIG_SERVICIO_PRODUCTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CONFIG_SERVICIO_PRODUCTO encontrados " + consulta_PS_CONFIG_SERVICIO_PRODUCTO.Count.ToString());
                        foreach (BsonDocument itemPS_CONFIG_SERVICIO_PRODUCTO in consulta_PS_CONFIG_SERVICIO_PRODUCTO)
                        {
                            id_mongo = itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id")?.ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString().Length > 30 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString().Substring(0, 29) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("fecha_creacion") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_creacion").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("usuario_creacion") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_creacion").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("fecha_actualizacion") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("usuario_modificacion") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_modificacion").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("id_producto") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("id_producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("id_producto").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("id_producto").ToString().Length > 30 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("id_producto").ToString().Substring(0, 29) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("id_producto").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("producto") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("producto").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("producto").ToString().Length > 50 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("producto").ToString().Substring(0, 50) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("producto").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("es_activo") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("es_activo").IsBsonNull ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("es_activo").ToString().Length > 8 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONFIG_SERVICIO_PRODUCTO.Contains("observaciones") && !itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("observaciones").IsBsonNull ? !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("observaciones").ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "");

                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_CONFIG_SERVICIO_PRODUCTO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_CONFIG_SERVICIO_PRODUCTO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_CONFIG_SERVICIO_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_CONFIG_SERVICIO_PRODUCTO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_CONFIG_SERVICIO_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_CONFIG_SERVICIO_PRODUCTO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_CONFIG_SERVICIO_PRODUCTO ACTUALIZADA: " + itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString() + "Numero de PS_CONFIG_SERVICIO_PRODUCTO actializadas: " + Conteo_PS_CONFIG_SERVICIO_PRODUCTO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_CONFIG_SERVICIO_PRODUCTO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_CONFIG_SERVICIO_PRODUCTO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_CONFIG_SERVICIO_PRODUCTO > 0)
                        {
                            Archivo_PS_CONFIG_SERVICIO_PRODUCTO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_CONFIG_SERVICIO_PRODUCTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");

                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_CONFIG_SERVICIO_PRODUCTO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_CONFIG_SERVICIO_PRODUCTO.Close();
            }

        }

        internal static void Extractor_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion = null;

            int Conteo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_CONFIG_SERVICIO_PRODUCTO = db.GetCollection<BsonDocument>("PS_CONFIG_SERVICIO_PRODUCTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CONFIG_SERVICIO_PRODUCTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CONFIG_SERVICIO_PRODUCTO = builderPS_CONFIG_SERVICIO_PRODUCTO.Empty;

                if (tipo == "")
                {
                    filterPS_CONFIG_SERVICIO_PRODUCTO = builderPS_CONFIG_SERVICIO_PRODUCTO.Or(builderPS_CONFIG_SERVICIO_PRODUCTO.Eq("elementos_configuracion.Actualizacion_Extractor", "1"), !builderPS_CONFIG_SERVICIO_PRODUCTO.Exists("elementos_configuracion.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_CONFIG_SERVICIO_PRODUCTO = builderPS_CONFIG_SERVICIO_PRODUCTO.And(builderPS_CONFIG_SERVICIO_PRODUCTO.Gte("elementos_configuracion.Fecha_extraccion", fechaconsulta.Date), builderPS_CONFIG_SERVICIO_PRODUCTO.Lt("elementos_configuracion.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CONFIG_SERVICIO_PRODUCTO = Col_PS_CONFIG_SERVICIO_PRODUCTO.Find(filterPS_CONFIG_SERVICIO_PRODUCTO).ToList();

                if (consulta_PS_CONFIG_SERVICIO_PRODUCTO != null && consulta_PS_CONFIG_SERVICIO_PRODUCTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion encontrados " + consulta_PS_CONFIG_SERVICIO_PRODUCTO.Count.ToString());
                        foreach (BsonDocument itemPS_CONFIG_SERVICIO_PRODUCTO in consulta_PS_CONFIG_SERVICIO_PRODUCTO)
                        {
                            id_mongo = itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion = itemPS_CONFIG_SERVICIO_PRODUCTO.GetElement("elementos_configuracion").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion != null && consulta_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion.Count() > 0)
                            {
                                foreach (BsonValue itemElementos_Configuracion in consulta_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemElementos_Configuracion.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemElementos_Configuracion.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemElementos_Configuracion.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_CONFIG_SERVICIO_PRODUCTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("_id") && !itemElementos_Configuracion.ToBsonDocument().GetValue("_id").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("_id").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemElementos_Configuracion.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemElementos_Configuracion.ToBsonDocument().GetValue("_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("fecha_creacion") && !itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_creacion").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_creacion").ToString().Length > 30 ? itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_creacion").ToString().Substring(0, 30) : itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("usuario_creacion") && !itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_creacion").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_creacion").ToString().Length > 50 ? itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_creacion").ToString().Substring(0, 50) : itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("fecha_actualizacion") && !itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_actualizacion").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_actualizacion").ToString().Length > 30 ? itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemElementos_Configuracion.ToBsonDocument().GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("usuario_modificacion") && !itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_modificacion").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_modificacion").ToString().Length > 50 ? itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("id_agrupador") && !itemElementos_Configuracion.ToBsonDocument().GetValue("id_agrupador").IsBsonNull ? itemElementos_Configuracion.ToBsonDocument().GetValue("id_agrupador").ToString().Length > 8 ? itemElementos_Configuracion.ToBsonDocument().GetValue("id_agrupador").ToString().Substring(0, 8) : itemElementos_Configuracion.ToBsonDocument().GetValue("id_agrupador").ToString() : "") +
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("nombre_agrupador") && !itemElementos_Configuracion.ToBsonDocument().GetValue("nombre_agrupador").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("nombre_agrupador").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("nombre_agrupador").ToString().Length > 30 ? itemElementos_Configuracion.ToBsonDocument().GetValue("nombre_agrupador").ToString().Substring(0, 29) : itemElementos_Configuracion.ToBsonDocument().GetValue("nombre_agrupador").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("cantidad") && !itemElementos_Configuracion.ToBsonDocument().GetValue("cantidad").IsBsonNull && !string.IsNullOrEmpty(itemElementos_Configuracion.ToBsonDocument().GetValue("cantidad").ToString()) ? (itemElementos_Configuracion.ToBsonDocument().GetValue("cantidad").ToString().Length > 30 ? itemElementos_Configuracion.ToBsonDocument().GetValue("cantidad").ToString().Substring(0, 29) : itemElementos_Configuracion.ToBsonDocument().GetValue("cantidad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("tipo_elemento") && !itemElementos_Configuracion.ToBsonDocument().GetValue("tipo_elemento").IsBsonNull ? itemElementos_Configuracion.ToBsonDocument().GetValue("tipo_elemento").ToString().Length > 8 ? itemElementos_Configuracion.ToBsonDocument().GetValue("tipo_elemento").ToString().Substring(0, 8) : itemElementos_Configuracion.ToBsonDocument().GetValue("tipo_elemento").ToString() : "") +
                                                "~|" + (itemElementos_Configuracion.ToBsonDocument().Contains("inventario_etb") && !itemElementos_Configuracion.ToBsonDocument().GetValue("inventario_etb").IsBsonNull ? itemElementos_Configuracion.ToBsonDocument().GetValue("inventario_etb").ToString().Length > 8 ? itemElementos_Configuracion.ToBsonDocument().GetValue("inventario_etb").ToString().Substring(0, 8) : itemElementos_Configuracion.ToBsonDocument().GetValue("inventario_etb").ToString() : "");
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion Id: " + id_mongo + "," + itemElementos_Configuracion.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_CONFIG_SERVICIO_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("elementos_configuracion._id", MongoDB.Bson.ObjectId.Parse(itemElementos_Configuracion.ToBsonDocument().GetValue("_id").ToString()))),
                                                                   Builders<BsonDocument>.Update.Set("elementos_configuracion.Actualizacion_Extractor", "0")
                                                                                                .Set("elementos_configuracion.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemElementos_Configuracion.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_CONFIG_SERVICIO_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                  Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString())),
                                                                  Builders<BsonDocument>.Filter.Eq("elementos_configuracion._id", MongoDB.Bson.ObjectId.Parse(itemElementos_Configuracion.ToBsonDocument().GetValue("_id").ToString()))),
                                                                  Builders<BsonDocument>.Update.Set("elementos_configuracion.Actualizacion_Extractor", "0")
                                                                                               .Set("elementos_configuracion.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion ACTUALIZADA: " + itemPS_CONFIG_SERVICIO_PRODUCTO.GetValue("_id").ToString() + "Numero de PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion actializadas: " + Conteo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion > 0)
                        {
                            Archivo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_CONFIG_SERVICIO_PRODUCTO_elementos_configuracion.Close();
            }

        }

        internal static void Extractor_PS_CONSECUTIVO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_CONSECUTIVO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_CONSECUTIVO = null;

            int Conteo_PS_CONSECUTIVO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_CONSECUTIVO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_CONSECUTIVO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_CONSECUTIVO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CONSECUTIVO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CONSECUTIVO = builderPS_CONSECUTIVO.Empty;

                if (tipo == "")
                {
                    filterPS_CONSECUTIVO = builderPS_CONSECUTIVO.Or(builderPS_CONSECUTIVO.Eq("Actualizacion_Extractor", "1"), !builderPS_CONSECUTIVO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_CONSECUTIVO = builderPS_CONSECUTIVO.And(builderPS_CONSECUTIVO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_CONSECUTIVO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CONSECUTIVO = Col_PS.Find(filterPS_CONSECUTIVO).ToList();

                if (consulta_PS_CONSECUTIVO != null && consulta_PS_CONSECUTIVO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CONSECUTIVO encontrados " + consulta_PS_CONSECUTIVO.Count.ToString());
                        foreach (BsonDocument itemPS_CONSECUTIVO in consulta_PS_CONSECUTIVO)
                        {
                            id_mongo = itemPS_CONSECUTIVO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_CONSECUTIVO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_CONSECUTIVO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_CONSECUTIVO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_CONSECUTIVO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("_id")?.ToString()) ? (itemPS_CONSECUTIVO.GetValue("_id").ToString().Length > 30 ? itemPS_CONSECUTIVO.GetValue("_id").ToString().Substring(0, 29) : itemPS_CONSECUTIVO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("fecha_creacion") && !itemPS_CONSECUTIVO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("fecha_creacion").ToString()) ? (itemPS_CONSECUTIVO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_CONSECUTIVO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_CONSECUTIVO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("usuario_creacion") && !itemPS_CONSECUTIVO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("usuario_creacion").ToString()) ? (itemPS_CONSECUTIVO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_CONSECUTIVO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_CONSECUTIVO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("fecha_actualizacion") && !itemPS_CONSECUTIVO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_CONSECUTIVO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_CONSECUTIVO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_CONSECUTIVO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("usuario_modificacion") && !itemPS_CONSECUTIVO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("usuario_modificacion").ToString()) ? (itemPS_CONSECUTIVO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_CONSECUTIVO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_CONSECUTIVO.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("entidad") ? !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("entidad")?.ToString()) ? (itemPS_CONSECUTIVO.GetValue("entidad").ToString().Length > 30 ? itemPS_CONSECUTIVO.GetValue("entidad").ToString().Substring(0, 29) : itemPS_CONSECUTIVO.GetValue("entidad").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("valor") ? !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("valor")?.ToString()) ? (itemPS_CONSECUTIVO.GetValue("valor").ToString().Length > 30 ? itemPS_CONSECUTIVO.GetValue("valor").ToString().Substring(0, 29) : itemPS_CONSECUTIVO.GetValue("valor").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("es_activo") && !itemPS_CONSECUTIVO.GetValue("es_activo").IsBsonNull ? itemPS_CONSECUTIVO.GetValue("es_activo").ToString().Length > 8 ? itemPS_CONSECUTIVO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_CONSECUTIVO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CONSECUTIVO.Contains("formato") ? !string.IsNullOrEmpty(itemPS_CONSECUTIVO.GetValue("formato")?.ToString()) ? (itemPS_CONSECUTIVO.GetValue("formato").ToString().Length > 30 ? itemPS_CONSECUTIVO.GetValue("formato").ToString().Substring(0, 29) : itemPS_CONSECUTIVO.GetValue("formato").ToString()) : "" : "");


                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_CONSECUTIVO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_CONSECUTIVO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONSECUTIVO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_CONSECUTIVO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_CONSECUTIVO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CONSECUTIVO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_CONSECUTIVO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_CONSECUTIVO ACTUALIZADA: " + itemPS_CONSECUTIVO.GetValue("_id").ToString() + "Numero de PS_CONSECUTIVO actializadas: " + Conteo_PS_CONSECUTIVO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_CONSECUTIVO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_CONSECUTIVO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_CONSECUTIVO > 0)
                        {
                            Archivo_PS_CONSECUTIVO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_CONSECUTIVO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_CONSECUTIVO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_CONSECUTIVO.Close();
            }

        }

        internal static void Extractor_PS_CRONOMETRO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_CRONOMETRO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_CRONOMETRO = null;

            int Conteo_PS_CRONOMETRO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_CRONOMETRO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_CRONOMETRO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_CRONOMETRO");
                FilterDefinitionBuilder<BsonDocument> builderPS_CRONOMETRO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_CRONOMETRO = builderPS_CRONOMETRO.Empty;

                if (tipo == "")
                {
                    filterPS_CRONOMETRO = builderPS_CRONOMETRO.Or(builderPS_CRONOMETRO.Eq("Actualizacion_Extractor", "1"), !builderPS_CRONOMETRO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_CRONOMETRO = builderPS_CRONOMETRO.And(builderPS_CRONOMETRO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_CRONOMETRO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_CRONOMETRO = Col_PS.Find(filterPS_CRONOMETRO).ToList();

                if (consulta_PS_CRONOMETRO != null && consulta_PS_CRONOMETRO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_CRONOMETRO encontrados " + consulta_PS_CRONOMETRO.Count.ToString());
                        foreach (BsonDocument itemPS_CRONOMETRO in consulta_PS_CRONOMETRO)
                        {
                            id_mongo = itemPS_CRONOMETRO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_CRONOMETRO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_CRONOMETRO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_CRONOMETRO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_CRONOMETRO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("_id")?.ToString()) ? (itemPS_CRONOMETRO.GetValue("_id").ToString().Length > 30 ? itemPS_CRONOMETRO.GetValue("_id").ToString().Substring(0, 29) : itemPS_CRONOMETRO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("fecha_creacion") && !itemPS_CRONOMETRO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("fecha_creacion").ToString()) ? (itemPS_CRONOMETRO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_CRONOMETRO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_CRONOMETRO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("usuario_creacion") && !itemPS_CRONOMETRO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("usuario_creacion").ToString()) ? (itemPS_CRONOMETRO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_CRONOMETRO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_CRONOMETRO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("fecha_actualizacion") && !itemPS_CRONOMETRO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_CRONOMETRO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_CRONOMETRO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_CRONOMETRO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("usuario_modificacion") && !itemPS_CRONOMETRO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("usuario_modificacion").ToString()) ? (itemPS_CRONOMETRO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_CRONOMETRO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_CRONOMETRO.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("nombre") ? !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("nombre")?.ToString()) ? (itemPS_CRONOMETRO.GetValue("nombre").ToString().Length > 30 ? itemPS_CRONOMETRO.GetValue("nombre").ToString().Substring(0, 29) : itemPS_CRONOMETRO.GetValue("nombre").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("descripcion") && !itemPS_CRONOMETRO.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("descripcion").ToString()) ? (itemPS_CRONOMETRO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_CRONOMETRO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_CRONOMETRO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("es_activo") && !itemPS_CRONOMETRO.GetValue("es_activo").IsBsonNull ? itemPS_CRONOMETRO.GetValue("es_activo").ToString().Length > 8 ? itemPS_CRONOMETRO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_CRONOMETRO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_CRONOMETRO.Contains("color") ? !string.IsNullOrEmpty(itemPS_CRONOMETRO.GetValue("color")?.ToString()) ? (itemPS_CRONOMETRO.GetValue("color").ToString().Length > 30 ? itemPS_CRONOMETRO.GetValue("color").ToString().Substring(0, 29) : itemPS_CRONOMETRO.GetValue("color").ToString()) : "" : "");


                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_CRONOMETRO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_CRONOMETRO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CRONOMETRO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_CRONOMETRO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_CRONOMETRO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_CRONOMETRO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_CRONOMETRO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_CRONOMETRO ACTUALIZADA: " + itemPS_CRONOMETRO.GetValue("_id").ToString() + "Numero de PS_CRONOMETRO actializadas: " + Conteo_PS_CRONOMETRO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_CRONOMETRO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_CRONOMETRO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_CRONOMETRO > 0)
                        {
                            Archivo_PS_CRONOMETRO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_CRONOMETRO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_CRONOMETRO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_CRONOMETRO.Close();
            }

        }

        internal static void Extractor_PS_ESTADO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_ESTADO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_ESTADO = null;

            int Conteo_PS_ESTADO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_ESTADO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_ESTADO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_ESTADO");
                FilterDefinitionBuilder<BsonDocument> builderPS_ESTADO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_ESTADO = builderPS_ESTADO.Empty;

                if (tipo == "")
                {
                    filterPS_ESTADO = builderPS_ESTADO.Or(builderPS_ESTADO.Eq("Actualizacion_Extractor", "1"), !builderPS_ESTADO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_ESTADO = builderPS_ESTADO.And(builderPS_ESTADO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_ESTADO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_ESTADO = Col_PS.Find(filterPS_ESTADO).ToList();

                if (consulta_PS_ESTADO != null && consulta_PS_ESTADO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_ESTADO encontrados " + consulta_PS_ESTADO.Count.ToString());
                        foreach (BsonDocument itemPS_ESTADO in consulta_PS_ESTADO)
                        {
                            id_mongo = itemPS_ESTADO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_ESTADO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_ESTADO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_ESTADO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_ESTADO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("_id")?.ToString()) ? (itemPS_ESTADO.GetValue("_id").ToString().Length > 30 ? itemPS_ESTADO.GetValue("_id").ToString().Substring(0, 29) : itemPS_ESTADO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("fecha_creacion") && !itemPS_ESTADO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("fecha_creacion").ToString()) ? (itemPS_ESTADO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_ESTADO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_ESTADO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("usuario_creacion") && !itemPS_ESTADO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("usuario_creacion").ToString()) ? (itemPS_ESTADO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_ESTADO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_ESTADO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("fecha_actualizacion") && !itemPS_ESTADO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_ESTADO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_ESTADO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_ESTADO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("usuario_modificacion") && !itemPS_ESTADO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("usuario_modificacion").ToString()) ? (itemPS_ESTADO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_ESTADO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_ESTADO.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("nombre_estado") ? !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("nombre_estado")?.ToString()) ? (itemPS_ESTADO.GetValue("nombre_estado").ToString().Length > 30 ? itemPS_ESTADO.GetValue("nombre_estado").ToString().Substring(0, 29) : itemPS_ESTADO.GetValue("nombre_estado").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("id_reloj") ? !string.IsNullOrEmpty(itemPS_ESTADO.GetValue("id_reloj")?.ToString()) ? (itemPS_ESTADO.GetValue("id_reloj").ToString().Length > 30 ? itemPS_ESTADO.GetValue("id_reloj").ToString().Substring(0, 29) : itemPS_ESTADO.GetValue("id_reloj").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("es_activo") && !itemPS_ESTADO.GetValue("es_activo").IsBsonNull ? itemPS_ESTADO.GetValue("es_activo").ToString().Length > 8 ? itemPS_ESTADO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_ESTADO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("es_inicial_tarea") && !itemPS_ESTADO.GetValue("es_inicial_tarea").IsBsonNull ? itemPS_ESTADO.GetValue("es_inicial_tarea").ToString().Length > 8 ? itemPS_ESTADO.GetValue("es_inicial_tarea").ToString().Substring(0, 8) : itemPS_ESTADO.GetValue("es_inicial_tarea").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ESTADO.Contains("es_final_tarea") && !itemPS_ESTADO.GetValue("es_final_tarea").IsBsonNull ? itemPS_ESTADO.GetValue("es_final_tarea").ToString().Length > 8 ? itemPS_ESTADO.GetValue("es_final_tarea").ToString().Substring(0, 8) : itemPS_ESTADO.GetValue("es_final_tarea").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,


                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_ESTADO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_ESTADO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_ESTADO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_ESTADO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_ESTADO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_ESTADO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_ESTADO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_ESTADO ACTUALIZADA: " + itemPS_ESTADO.GetValue("_id").ToString() + "Numero de PS_ESTADO actializadas: " + Conteo_PS_ESTADO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_ESTADO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_ESTADO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_ESTADO > 0)
                        {
                            Archivo_PS_ESTADO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_ESTADO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_ESTADO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_ESTADO.Close();
            }

        }

        internal static void Extractor_PS_FASE(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_FASE");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FASE = null;

            int Conteo_PS_FASE = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FASE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FASE = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_ESTADO");
                FilterDefinitionBuilder<BsonDocument> builderPS_FASE = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FASE = builderPS_FASE.Empty;

                if (tipo == "")
                {
                    filterPS_FASE = builderPS_FASE.Or(builderPS_FASE.Eq("Actualizacion_Extractor", "1"), !builderPS_FASE.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_FASE = builderPS_FASE.And(builderPS_FASE.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_FASE.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FASE = Col_PS.Find(filterPS_FASE).ToList();

                if (consulta_PS_FASE != null && consulta_PS_FASE.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FASE encontrados " + consulta_PS_FASE.Count.ToString());
                        foreach (BsonDocument itemPS_FASE in consulta_PS_FASE)
                        {
                            id_mongo = itemPS_FASE.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_FASE.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_FASE.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_FASE.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_FASE.Contains("_id") ? !string.IsNullOrEmpty(itemPS_FASE.GetValue("_id")?.ToString()) ? (itemPS_FASE.GetValue("_id").ToString().Length > 30 ? itemPS_FASE.GetValue("_id").ToString().Substring(0, 29) : itemPS_FASE.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("fecha_creacion") && !itemPS_FASE.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FASE.GetValue("fecha_creacion").ToString()) ? (itemPS_FASE.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_FASE.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_FASE.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("usuario_creacion") && !itemPS_FASE.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FASE.GetValue("usuario_creacion").ToString()) ? (itemPS_FASE.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_FASE.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_FASE.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("fecha_actualizacion") && !itemPS_FASE.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FASE.GetValue("fecha_actualizacion").ToString()) ? (itemPS_FASE.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_FASE.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_FASE.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("usuario_modificacion") && !itemPS_FASE.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FASE.GetValue("usuario_modificacion").ToString()) ? (itemPS_FASE.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_FASE.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_FASE.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("fase") ? !string.IsNullOrEmpty(itemPS_FASE.GetValue("fase")?.ToString()) ? (itemPS_FASE.GetValue("fase").ToString().Length > 30 ? itemPS_FASE.GetValue("fase").ToString().Substring(0, 29) : itemPS_FASE.GetValue("fase").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("es_activo") && !itemPS_FASE.GetValue("es_activo").IsBsonNull ? itemPS_FASE.GetValue("es_activo").ToString().Length > 8 ? itemPS_FASE.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_FASE.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FASE.Contains("es_inicial") && !itemPS_FASE.GetValue("es_inicial").IsBsonNull ? itemPS_FASE.GetValue("es_inicial").ToString().Length > 8 ? itemPS_FASE.GetValue("es_inicial").ToString().Substring(0, 8) : itemPS_FASE.GetValue("es_inicial").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,


                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FASE Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_FASE.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FASE.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_FASE++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_FASE.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FASE.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_FASE++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_FASE ACTUALIZADA: " + itemPS_FASE.GetValue("_id").ToString() + "Numero de PS_FASE actializadas: " + Conteo_PS_FASE);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FASE en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FASE para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_FASE > 0)
                        {
                            Archivo_PS_FASE.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FASE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FASE entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FASE.Close();
            }

        }

        internal static void Extractor_PS_FASE_estados(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_FASE_estados");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FASE_estados = null;

            int Conteo_PS_FASE_estados = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FASE_estados_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FASE_estados = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_FASE = db.GetCollection<BsonDocument>("PS_FASE");
                FilterDefinitionBuilder<BsonDocument> builderPS_FASE = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FASE = builderPS_FASE.Empty;

                if (tipo == "")
                {
                    filterPS_FASE = builderPS_FASE.Or(builderPS_FASE.Eq("estados.Actualizacion_Extractor", "1"), !builderPS_FASE.Exists("estados.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_FASE = builderPS_FASE.And(builderPS_FASE.Gte("estados.Fecha_extraccion", fechaconsulta.Date), builderPS_FASE.Lt("estados.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FASE = Col_PS_FASE.Find(filterPS_FASE).ToList();

                if (consulta_PS_FASE != null && consulta_PS_FASE.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FASE_estados encontrados " + consulta_PS_FASE.Count.ToString());
                        foreach (BsonDocument itemPS_FASE in consulta_PS_FASE)
                        {
                            id_mongo = itemPS_FASE.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_FASE_estados = itemPS_FASE.GetElement("estados").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_FASE_estados != null && consulta_PS_FASE_estados.Count() > 0)
                            {
                                foreach (BsonValue itemPS_FASE_estados in consulta_PS_FASE_estados)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemPS_FASE_estados.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemPS_FASE_estados.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemPS_FASE_estados.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_FASE.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_FASE.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_FASE.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_FASE.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_FASE.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_FASE_estados.ToBsonDocument().Contains("texto") && !itemPS_FASE_estados.ToBsonDocument().GetValue("texto").IsBsonNull && !string.IsNullOrEmpty(itemPS_FASE_estados.ToBsonDocument().GetValue("texto").ToString()) ? (itemPS_FASE_estados.ToBsonDocument().GetValue("texto").ToString().Length > 50 ? itemPS_FASE_estados.ToBsonDocument().GetValue("texto").ToString().Substring(0, 50) : itemPS_FASE_estados.ToBsonDocument().GetValue("texto").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_FASE_estados.ToBsonDocument().Contains("es_inicial") && !itemPS_FASE_estados.ToBsonDocument().GetValue("es_inicial").IsBsonNull ? itemPS_FASE_estados.ToBsonDocument().GetValue("es_inicial").ToString().Length > 8 ? itemPS_FASE_estados.ToBsonDocument().GetValue("es_inicial").ToString().Substring(0, 8) : itemPS_FASE_estados.ToBsonDocument().GetValue("es_inicial").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FASE_estados Id: " + id_mongo + "," + itemPS_FASE_estados.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_FASE_estados.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_FASE.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FASE.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("estados._id", itemPS_FASE_estados.ToBsonDocument().GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("estados.Actualizacion_Extractor", "0")
                                                                                                .Set("estados.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_FASE_estados++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemPS_FASE_estados.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_FASE.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                    Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FASE.GetValue("_id").ToString())),
                                                                    Builders<BsonDocument>.Filter.Eq("estados._id", itemPS_FASE_estados.ToBsonDocument().GetValue("_id").ToString())),
                                                                    Builders<BsonDocument>.Update.Set("estados.Actualizacion_Extractor", "0")
                                                                                                 .Set("estados.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_FASE_estados++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_FASE_estados ACTUALIZADA: " + itemPS_FASE.GetValue("_id").ToString() + "Numero de PS_FASE_estados actializadas: " + Conteo_PS_FASE_estados);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FASE_estados en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FASE_estados para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_FASE_estados > 0)
                        {
                            Archivo_PS_FASE_estados.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FASE_estados_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FASE_estados entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FASE_estados.Close();
            }

        }

        internal static void Extractor_PS_FORMATO_SALIDA(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_APROBACION");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FORMATO_SALIDA = null;

            int Conteo_PS_FORMATO_SALIDA = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FORMATO_SALIDA_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FORMATO_SALIDA = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_FORMATO_SALIDA = db.GetCollection<BsonDocument>("PS_FORMATO_SALIDA");
                FilterDefinitionBuilder<BsonDocument> builderPS_FORMATO_SALIDA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Empty;

                if (tipo == "")
                {
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Or(builderPS_FORMATO_SALIDA.Eq("Actualizacion_Extractor", "1"), !builderPS_FORMATO_SALIDA.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.And(builderPS_FORMATO_SALIDA.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_FORMATO_SALIDA.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FORMATO_SALIDA = Col_PS_FORMATO_SALIDA.Find(filterPS_FORMATO_SALIDA).ToList();

                if (consulta_PS_FORMATO_SALIDA != null && consulta_PS_FORMATO_SALIDA.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FORMATO_SALIDA encontrados " + consulta_PS_FORMATO_SALIDA.Count.ToString());
                        foreach (BsonDocument itemPS_FORMATO_SALIDA in consulta_PS_FORMATO_SALIDA)
                        {
                            id_mongo = itemPS_FORMATO_SALIDA.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_FORMATO_SALIDA.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_FORMATO_SALIDA.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_FORMATO_SALIDA.Contains("_id") ? !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("_id")?.ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("_id").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("_id").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("fecha_creacion") && !itemPS_FORMATO_SALIDA.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("fecha_creacion").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_FORMATO_SALIDA.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("usuario_creacion") && !itemPS_FORMATO_SALIDA.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("usuario_creacion").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_FORMATO_SALIDA.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_FORMATO_SALIDA.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("fecha_actualizacion") && !itemPS_FORMATO_SALIDA.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("fecha_actualizacion").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_FORMATO_SALIDA.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("usuario_modificacion") && !itemPS_FORMATO_SALIDA.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("usuario_modificacion").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_FORMATO_SALIDA.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_FORMATO_SALIDA.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("fecha_entrega") && !itemPS_FORMATO_SALIDA.GetValue("fecha_entrega").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("fecha_entrega").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("fecha_entrega").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("fecha_entrega").ToString().Substring(0, 30) : itemPS_FORMATO_SALIDA.GetValue("fecha_entrega").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("id_bodega") && !itemPS_FORMATO_SALIDA.GetValue("id_bodega").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("id_bodega").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("id_bodega").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("id_bodega").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("id_bodega").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("bodega") && !itemPS_FORMATO_SALIDA.GetValue("bodega").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("bodega").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("bodega").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("bodega").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("bodega").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("area_consumidora") && !itemPS_FORMATO_SALIDA.GetValue("area_consumidora").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("area_consumidora").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("area_consumidora").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("area_consumidora").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("area_consumidora").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("movimiento_contable") && !itemPS_FORMATO_SALIDA.GetValue("movimiento_contable").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("movimiento_contable").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("movimiento_contable").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("movimiento_contable").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("movimiento_contable").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("solicitado") && !itemPS_FORMATO_SALIDA.GetValue("solicitado").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("solicitado").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("solicitado").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("solicitado").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("solicitado").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("empresa_instala") && !itemPS_FORMATO_SALIDA.GetValue("empresa_instala").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("empresa_instala").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("empresa_instala").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("empresa_instala").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("empresa_instala").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("lugar_despacho") && !itemPS_FORMATO_SALIDA.GetValue("lugar_despacho").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("lugar_despacho").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("lugar_despacho").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("lugar_despacho").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("lugar_despacho").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("id_aprovisionamiento") && !itemPS_FORMATO_SALIDA.GetValue("id_aprovisionamiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("id_aprovisionamiento").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("id_aprovisionamiento").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("id_aprovisionamiento").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("id_aprovisionamiento").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("nombre_cliente") && !itemPS_FORMATO_SALIDA.GetValue("nombre_cliente").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("nombre_cliente").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("nombre_cliente").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("nombre_cliente").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("nombre_cliente").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("direccion_cliente") && !itemPS_FORMATO_SALIDA.GetValue("direccion_cliente").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("direccion_cliente").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("direccion_cliente").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("direccion_cliente").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("direccion_cliente").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("ciudad_cliente") && !itemPS_FORMATO_SALIDA.GetValue("ciudad_cliente").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("ciudad_cliente").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("ciudad_cliente").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("ciudad_cliente").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("ciudad_cliente").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("telefono_cliente") && !itemPS_FORMATO_SALIDA.GetValue("telefono_cliente").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("telefono_cliente").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("telefono_cliente").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("telefono_cliente").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("telefono_cliente").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("contacto_cliente") && !itemPS_FORMATO_SALIDA.GetValue("contacto_cliente").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("contacto_cliente").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("contacto_cliente").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("contacto_cliente").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("contacto_cliente").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("orden") && !itemPS_FORMATO_SALIDA.GetValue("orden").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("orden").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("orden").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("orden").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("orden").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("consecutivo") && !itemPS_FORMATO_SALIDA.GetValue("consecutivo").IsBsonNull && !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.GetValue("consecutivo").ToString()) ? (itemPS_FORMATO_SALIDA.GetValue("consecutivo").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.GetValue("consecutivo").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.GetValue("consecutivo").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("recibido") && !itemPS_FORMATO_SALIDA.GetValue("recibido").IsBsonNull ? itemPS_FORMATO_SALIDA.GetValue("recibido").ToString().Length > 8 ? itemPS_FORMATO_SALIDA.GetValue("recibido").ToString().Substring(0, 8) : itemPS_FORMATO_SALIDA.GetValue("recibido").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FORMATO_SALIDA.Contains("impresiones") && !itemPS_FORMATO_SALIDA.GetValue("impresiones").IsBsonNull ? itemPS_FORMATO_SALIDA.GetValue("impresiones").ToString().Length > 8 ? itemPS_FORMATO_SALIDA.GetValue("impresiones").ToString().Substring(0, 8) : itemPS_FORMATO_SALIDA.GetValue("impresiones").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FORMATO_SALIDA Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_FORMATO_SALIDA.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_FORMATO_SALIDA.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_FORMATO_SALIDA++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_FORMATO_SALIDA.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_FORMATO_SALIDA.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_FORMATO_SALIDA++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_FORMATO_SALIDA ACTUALIZADA: " + itemPS_FORMATO_SALIDA.GetValue("_id").ToString() + "Numero de PS_FORMATO_SALIDA actializadas: " + Conteo_PS_FORMATO_SALIDA);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FORMATO_SALIDA en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FORMATO_SALIDA para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_FORMATO_SALIDA > 0)
                        {
                            Archivo_PS_FORMATO_SALIDA.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FORMATO_SALIDA_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FORMATO_SALIDA entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FORMATO_SALIDA.Close();
            }

        }

        internal static void Extractor_PS_FORMATO_SALIDA_usuario_solicita(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_FORMATO_SALIDA_usuario_solicita");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FORMATO_SALIDA_usuario_solicita = null;

            int Conteo_PS_FORMATO_SALIDA_usuario_solicita = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FORMATO_SALIDA_usuario_solicita_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FORMATO_SALIDA_usuario_solicita = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_FORMATO_SALIDA = db.GetCollection<BsonDocument>("PS_FORMATO_SALIDA");
                FilterDefinitionBuilder<BsonDocument> builderPS_FORMATO_SALIDA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Empty;

                if (tipo == "")
                {
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Or(builderPS_FORMATO_SALIDA.Eq("usuario_solicita.Actualizacion_Extractor", "1"), !builderPS_FORMATO_SALIDA.Exists("usuario_solicita.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.And(builderPS_FORMATO_SALIDA.Gte("usuario_solicita.Fecha_extraccion", fechaconsulta.Date), builderPS_FORMATO_SALIDA.Lt("usuario_solicita.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FORMATO_SALIDA = Col_PS_FORMATO_SALIDA.Find(filterPS_FORMATO_SALIDA).ToList();

                if (consulta_PS_FORMATO_SALIDA != null && consulta_PS_FORMATO_SALIDA.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FORMATO_SALIDA_usuario_solicita encontrados " + consulta_PS_FORMATO_SALIDA.Count.ToString());
                        foreach (BsonDocument itemPS_FORMATO_SALIDA in consulta_PS_FORMATO_SALIDA)
                        {
                            id_mongo = itemPS_FORMATO_SALIDA.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_FORMATO_SALIDA_usuario_solicita = itemPS_FORMATO_SALIDA.GetElement("usuario_solicita").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_FORMATO_SALIDA_usuario_solicita != null && consulta_PS_FORMATO_SALIDA_usuario_solicita.Count() > 0)
                            {
                                foreach (BsonValue itemPS_usuario_solicita in consulta_PS_FORMATO_SALIDA_usuario_solicita)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemPS_usuario_solicita.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemPS_usuario_solicita.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemPS_usuario_solicita.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_FORMATO_SALIDA.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("rol") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("rol").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("rol").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("rol").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("rol").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("rol").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("id_usuario") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("usuario") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("usuario").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("usuario").ToString().Length > 50 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("usuario").ToString().Substring(0, 50) : itemPS_usuario_solicita.ToBsonDocument().GetValue("usuario").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("nombre") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("nombre").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("nombre").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("nombre").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("nombre").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("apellido") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("apellido").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("apellido").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("apellido").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("apellido").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("apellido").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("etb") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("etb").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("etb").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("etb").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("etb").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("etb").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("empresa") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("empresa").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("empresa").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("empresa").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("empresa").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("empresa").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("identificacion") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("identificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("identificacion").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("identificacion").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("identificacion").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("identificacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("correo_electronico") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("correo_electronico").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("correo_electronico").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("correo_electronico").ToString().Length > 30 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("correo_electronico").ToString().Substring(0, 29) : itemPS_usuario_solicita.ToBsonDocument().GetValue("correo_electronico").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_solicita.ToBsonDocument().Contains("firma") && !itemPS_usuario_solicita.ToBsonDocument().GetValue("firma").IsBsonNull ? !string.IsNullOrEmpty(itemPS_usuario_solicita.ToBsonDocument().GetValue("firma").ToString()) ? (itemPS_usuario_solicita.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 660000 ? itemPS_usuario_solicita.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_usuario_solicita.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : ""); // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FORMATO_SALIDA_usuario_solicita Id: " + id_mongo + "," + itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_FORMATO_SALIDA_usuario_solicita.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_FORMATO_SALIDA.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_solicita.id_usuario", itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_solicita.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_solicita.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_FORMATO_SALIDA_usuario_solicita++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemPS_usuario_solicita.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_FORMATO_SALIDA.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_solicita.id_usuario", itemPS_usuario_solicita.ToBsonDocument().GetValue("id_usuario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_solicita.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_solicita.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_FORMATO_SALIDA_usuario_solicita++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_FORMATO_SALIDA_usuario_solicita ACTUALIZADA: " + itemPS_FORMATO_SALIDA.GetValue("_id").ToString() + "Numero de PS_FORMATO_SALIDA_usuario_solicita actializadas: " + Conteo_PS_FORMATO_SALIDA_usuario_solicita);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FORMATO_SALIDA_usuario_solicita en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FORMATO_SALIDA_usuario_solicita para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_FORMATO_SALIDA_usuario_solicita > 0)
                        {
                            Archivo_PS_FORMATO_SALIDA_usuario_solicita.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FORMATO_SALIDA_usuario_solicita_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FORMATO_SALIDA_usuario_solicita entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FORMATO_SALIDA_usuario_solicita.Close();
            }

        }

        internal static void Extractor_PS_FORMATO_SALIDA_elementos_solicitados(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_FORMATO_SALIDA_elementos_solicitados");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FORMATO_SALIDA_elementos_solicitados = null;

            int Conteo_PS_FORMATO_SALIDA_elementos_solicitados = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FORMATO_SALIDA_elementos_solicitados_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FORMATO_SALIDA_elementos_solicitados = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_FORMATO_SALIDA = db.GetCollection<BsonDocument>("PS_FORMATO_SALIDA");
                FilterDefinitionBuilder<BsonDocument> builderPS_FORMATO_SALIDA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Empty;

                if (tipo == "")
                {
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Or(builderPS_FORMATO_SALIDA.Eq("elementos_solicitados.Actualizacion_Extractor", "1"), !builderPS_FORMATO_SALIDA.Exists("elementos_solicitados.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.And(builderPS_FORMATO_SALIDA.Gte("elementos_solicitados.Fecha_extraccion", fechaconsulta.Date), builderPS_FORMATO_SALIDA.Lt("elementos_solicitados.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FORMATO_SALIDA = Col_PS_FORMATO_SALIDA.Find(filterPS_FORMATO_SALIDA).ToList();

                if (consulta_PS_FORMATO_SALIDA != null && consulta_PS_FORMATO_SALIDA.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FORMATO_SALIDA_elementos_solicitados encontrados " + consulta_PS_FORMATO_SALIDA.Count.ToString());
                        foreach (BsonDocument itemPS_FORMATO_SALIDA in consulta_PS_FORMATO_SALIDA)
                        {
                            id_mongo = itemPS_FORMATO_SALIDA.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_FORMATO_SALIDA_elementos_solicitados = itemPS_FORMATO_SALIDA.GetElement("elementos_solicitados").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_FORMATO_SALIDA_elementos_solicitados != null && consulta_PS_FORMATO_SALIDA_elementos_solicitados.Count() > 0)
                            {
                                foreach (BsonValue itemPS_elementos_solicitados in consulta_PS_FORMATO_SALIDA_elementos_solicitados)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemPS_elementos_solicitados.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemPS_elementos_solicitados.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemPS_elementos_solicitados.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_FORMATO_SALIDA.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("item") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("item").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("item").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("item").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("item").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("item").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("codigo") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("codigo").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("codigo").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("codigo").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("codigo").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("codigo").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("id_inventario") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("id_producto") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("descripcion") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("descripcion").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("unidad") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("unidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("unidad").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("unidad").ToString().Length > 50 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("unidad").ToString().Substring(0, 50) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("unidad").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("cantidad") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("cantidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("cantidad").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("cantidad").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("cantidad").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("cantidad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("serial") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("serial").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("serial").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("serial").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("serial").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("serial").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("ubicacion") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("ubicacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("ubicacion").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("ubicacion").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("ubicacion").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("ubicacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,  
                                                "~|" + (itemPS_elementos_solicitados.ToBsonDocument().Contains("reserva") && !itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").IsBsonNull && !string.IsNullOrEmpty(itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").ToString()) ? (itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").ToString().Length > 30 ? itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").ToString().Substring(0, 29) : itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").ToString()) : "");  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FORMATO_SALIDA_elementos_solicitados Id: " + id_mongo + "," + itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_FORMATO_SALIDA_elementos_solicitados.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "") //inventario, reserva, producto
                                                        {
                                                            Col_PS_FORMATO_SALIDA.UpdateOne(
                                                                Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())),
                                                                        Builders<BsonDocument>.Filter.And(
                                                                        Builders<BsonDocument>.Filter.Eq("elementos_solicitados.id_inventario", MongoDB.Bson.ObjectId.Parse(itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString())),
                                                                        Builders<BsonDocument>.Filter.Eq("elementos_solicitados.id_producto", MongoDB.Bson.ObjectId.Parse(itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").ToString()))
                                                                                                        ),
                                                                   Builders<BsonDocument>.Filter.Eq("elementos_solicitados.reserva", itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").ToString())
                                                                                                ),
                                                                   Builders<BsonDocument>.Update.Set("elementos_solicitados.Actualizacion_Extractor", "0")
                                                                                                .Set("elementos_solicitados.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_FORMATO_SALIDA_elementos_solicitados++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemPS_elementos_solicitados.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_FORMATO_SALIDA.UpdateOne(
                                                                 Builders<BsonDocument>.Filter.And(
                                                                    Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())),
                                                                         Builders<BsonDocument>.Filter.And(
                                                                         Builders<BsonDocument>.Filter.Eq("elementos_solicitados.id_inventario", MongoDB.Bson.ObjectId.Parse(itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_inventario").ToString())),
                                                                         Builders<BsonDocument>.Filter.Eq("elementos_solicitados.id_producto", MongoDB.Bson.ObjectId.Parse(itemPS_elementos_solicitados.ToBsonDocument().GetValue("id_producto").ToString()))
                                                                                                         ),
                                                                    Builders<BsonDocument>.Filter.Eq("elementos_solicitados.reserva", itemPS_elementos_solicitados.ToBsonDocument().GetValue("reserva").ToString())
                                                                                                 ),
                                                                    Builders<BsonDocument>.Update.Set("elementos_solicitados.Actualizacion_Extractor", "0")
                                                                                                 .Set("elementos_solicitados.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_FORMATO_SALIDA_elementos_solicitados++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_FORMATO_SALIDA_elementos_solicitados ACTUALIZADA: " + itemPS_FORMATO_SALIDA.GetValue("_id").ToString() + "Numero de PS_FORMATO_SALIDA_elementos_solicitados actializadas: " + Conteo_PS_FORMATO_SALIDA_elementos_solicitados);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FORMATO_SALIDA_elementos_solicitados en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FORMATO_SALIDA_elementos_solicitados para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_FORMATO_SALIDA_elementos_solicitados > 0)
                        {
                            Archivo_PS_FORMATO_SALIDA_elementos_solicitados.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FORMATO_SALIDA_elementos_solicitados_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FORMATO_SALIDA_elementos_solicitados entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FORMATO_SALIDA_elementos_solicitados.Close();
            }

        }

        internal static void Extractor_PS_FORMATO_SALIDA_usuario_aprueba(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_FORMATO_SALIDA_usuario_aprueba");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FORMATO_SALIDA_usuario_aprueba = null;

            int Conteo_PS_FORMATO_SALIDA_usuario_aprueba = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FORMATO_SALIDA_usuario_aprueba_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FORMATO_SALIDA_usuario_aprueba = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_FORMATO_SALIDA = db.GetCollection<BsonDocument>("PS_FORMATO_SALIDA");
                FilterDefinitionBuilder<BsonDocument> builderPS_FORMATO_SALIDA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Empty;

                if (tipo == "")
                {
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.Or(builderPS_FORMATO_SALIDA.Eq("usuario_aprueba.Actualizacion_Extractor", "1"), !builderPS_FORMATO_SALIDA.Exists("usuario_aprueba.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_FORMATO_SALIDA = builderPS_FORMATO_SALIDA.And(builderPS_FORMATO_SALIDA.Gte("usuario_aprueba.Fecha_extraccion", fechaconsulta.Date), builderPS_FORMATO_SALIDA.Lt("usuario_aprueba.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FORMATO_SALIDA = Col_PS_FORMATO_SALIDA.Find(filterPS_FORMATO_SALIDA).ToList();

                if (consulta_PS_FORMATO_SALIDA != null && consulta_PS_FORMATO_SALIDA.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FORMATO_SALIDA_usuario_aprueba encontrados " + consulta_PS_FORMATO_SALIDA.Count.ToString());
                        foreach (BsonDocument itemPS_FORMATO_SALIDA in consulta_PS_FORMATO_SALIDA)
                        {
                            id_mongo = itemPS_FORMATO_SALIDA.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_FORMATO_SALIDA_usuario_aprueba = itemPS_FORMATO_SALIDA.GetElement("usuario_aprueba").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_FORMATO_SALIDA_usuario_aprueba != null && consulta_PS_FORMATO_SALIDA_usuario_aprueba.Count() > 0)
                            {
                                foreach (BsonValue itemPS_usuario_aprueba in consulta_PS_FORMATO_SALIDA_usuario_aprueba)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemPS_usuario_aprueba.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemPS_usuario_aprueba.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemPS_usuario_aprueba.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_FORMATO_SALIDA.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_FORMATO_SALIDA.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("rol") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("rol").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("rol").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("rol").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("rol").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("rol").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("id_usuario") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("usuario") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("usuario").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("usuario").ToString().Length > 50 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("usuario").ToString().Substring(0, 50) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("usuario").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("nombre") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("nombre").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("nombre").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("nombre").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("nombre").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("apellido") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("apellido").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("apellido").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("apellido").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("apellido").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("apellido").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("etb") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("etb").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("etb").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("etb").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("etb").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("etb").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("empresa") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("empresa").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("empresa").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("empresa").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("empresa").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("empresa").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("identificacion") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("identificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("identificacion").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("identificacion").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("identificacion").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("identificacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("correo_electronico") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("correo_electronico").IsBsonNull && !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("correo_electronico").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("correo_electronico").ToString().Length > 30 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("correo_electronico").ToString().Substring(0, 29) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("correo_electronico").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_usuario_aprueba.ToBsonDocument().Contains("firma") && !itemPS_usuario_aprueba.ToBsonDocument().GetValue("firma").IsBsonNull ? !string.IsNullOrEmpty(itemPS_usuario_aprueba.ToBsonDocument().GetValue("firma").ToString()) ? (itemPS_usuario_aprueba.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 660000 ? itemPS_usuario_aprueba.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_usuario_aprueba.ToBsonDocument().GetValue("firma").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : ""); // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FORMATO_SALIDA_usuario_aprueba Id: " + id_mongo + "," + itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_FORMATO_SALIDA_usuario_aprueba.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_FORMATO_SALIDA.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_aprueba.id_usuario", itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_aprueba.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_aprueba.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_FORMATO_SALIDA_usuario_aprueba++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemPS_usuario_aprueba.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_FORMATO_SALIDA.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FORMATO_SALIDA.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_aprueba.id_usuario", itemPS_usuario_aprueba.ToBsonDocument().GetValue("id_usuario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_aprueba.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_aprueba.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_FORMATO_SALIDA_usuario_aprueba++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_FORMATO_SALIDA_usuario_aprueba ACTUALIZADA: " + itemPS_FORMATO_SALIDA.GetValue("_id").ToString() + "Numero de PS_FORMATO_SALIDA_usuario_aprueba actializadas: " + Conteo_PS_FORMATO_SALIDA_usuario_aprueba);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FORMATO_SALIDA_usuario_aprueba en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FORMATO_SALIDA_usuario_aprueba para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_FORMATO_SALIDA_usuario_aprueba > 0)
                        {
                            Archivo_PS_FORMATO_SALIDA_usuario_aprueba.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FORMATO_SALIDA_usuario_aprueba_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FORMATO_SALIDA_usuario_aprueba entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FORMATO_SALIDA_usuario_aprueba.Close();
            }

        }

        internal static void Extractor_PS_FUNCIONALIDAD(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_FUNCIONALIDAD");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FUNCIONALIDAD = null;

            int Conteo_PS_FUNCIONALIDAD = 0;
            int acciones = 0;
            string sTextoDescarga_FUNCIONALIDAD = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_FUNCIONALIDAD_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FUNCIONALIDAD = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_FUNCIONALIDAD");
                FilterDefinitionBuilder<BsonDocument> builderPS_FUNCIONALIDAD = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FUNCIONALIDAD = builderPS_FUNCIONALIDAD.Empty;

                if (tipo == "")
                {
                    filterPS_FUNCIONALIDAD = builderPS_FUNCIONALIDAD.Or(builderPS_FUNCIONALIDAD.Eq("Actualizacion_Extractor", "1"), !builderPS_FUNCIONALIDAD.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_FUNCIONALIDAD = builderPS_FUNCIONALIDAD.And(builderPS_FUNCIONALIDAD.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_FUNCIONALIDAD.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_FUNCIONALIDAD = Col_PS.Find(filterPS_FUNCIONALIDAD).ToList();

                if (consulta_PS_FUNCIONALIDAD != null && consulta_PS_FUNCIONALIDAD.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FUNCIONALIDAD encontrados " + consulta_PS_FUNCIONALIDAD.Count.ToString());
                        foreach (BsonDocument itemPS_FUNCIONALIDAD in consulta_PS_FUNCIONALIDAD)
                        {
                            id_mongo = itemPS_FUNCIONALIDAD.GetValue("_id").ToString();

                            sTextoDescarga_FUNCIONALIDAD = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_FUNCIONALIDAD.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_FUNCIONALIDAD.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_FUNCIONALIDAD.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga_FUNCIONALIDAD =
                                        (itemPS_FUNCIONALIDAD.Contains("_id") ? !string.IsNullOrEmpty(itemPS_FUNCIONALIDAD.GetValue("_id")?.ToString()) ? (itemPS_FUNCIONALIDAD.GetValue("_id").ToString().Length > 30 ? itemPS_FUNCIONALIDAD.GetValue("_id").ToString().Substring(0, 29) : itemPS_FUNCIONALIDAD.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_FUNCIONALIDAD.Contains("nombre_funcionalidad") && !itemPS_FUNCIONALIDAD.GetValue("nombre_funcionalidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_FUNCIONALIDAD.GetValue("nombre_funcionalidad").ToString()) ? (itemPS_FUNCIONALIDAD.GetValue("nombre_funcionalidad").ToString().Length > 50 ? itemPS_FUNCIONALIDAD.GetValue("nombre_funcionalidad").ToString().Substring(0, 50) : itemPS_FUNCIONALIDAD.GetValue("nombre_funcionalidad").ToString()) : ""); // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga_FUNCIONALIDAD = sTextoDescarga_FUNCIONALIDAD.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        if (itemPS_FUNCIONALIDAD.Contains("acciones") && !itemPS_FUNCIONALIDAD.GetValue("acciones").IsBsonNull && itemPS_FUNCIONALIDAD.GetElement("acciones").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            acciones += Extractor_PS_FUNCIONALIDAD_acciones(id_mongo);
                                        }

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FUNCIONALIDAD Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga_FUNCIONALIDAD != "")
                                        {
                                            Archivo_PS_FUNCIONALIDAD.WriteLine(sTextoDescarga_FUNCIONALIDAD);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FUNCIONALIDAD.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_FUNCIONALIDAD++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_FUNCIONALIDAD.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_FUNCIONALIDAD.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_FUNCIONALIDAD++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_FUNCIONALIDAD ACTUALIZADA: " + itemPS_FUNCIONALIDAD.GetValue("_id").ToString() + "Numero de PS_FUNCIONALIDAD actializadas: " + Conteo_PS_FUNCIONALIDAD);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FUNCIONALIDAD en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FUNCIONALIDAD para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_FUNCIONALIDAD > 0)
                        {
                            Archivo_PS_FUNCIONALIDAD.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_FUNCIONALIDAD_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                if (acciones > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_FUNCIONALIDAD_acciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FUNCIONALIDAD entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FUNCIONALIDAD.Close();
            }

        }

        internal static int Extractor_PS_FUNCIONALIDAD_acciones(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo  PS_FUNCIONALIDAD_acciones");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_FUNCIONALIDAD_acciones = null;

            int Conteo_PS_FUNCIONALIDAD_acciones = 0;
            string sTextoDescarga = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_FUNCIONALIDAD_acciones_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_FUNCIONALIDAD_acciones = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_FUNCIONALIDAD_acciones = db.GetCollection<BsonDocument>("PS_FUNCIONALIDAD");
                FilterDefinitionBuilder<BsonDocument> builderPS_FUNCIONALIDAD_acciones = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_FUNCIONALIDAD_acciones = builderPS_FUNCIONALIDAD_acciones.Empty;
                filterPS_FUNCIONALIDAD_acciones = builderPS_FUNCIONALIDAD_acciones.And(
                builderPS_FUNCIONALIDAD_acciones.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_FUNCIONALIDAD_acciones.SizeGte("acciones", 1));


                List<BsonDocument> consulta_PS_FUNCIONALIDAD_ac = Col_PS_FUNCIONALIDAD_acciones.Find(filterPS_FUNCIONALIDAD_acciones).ToList();

                if (consulta_PS_FUNCIONALIDAD_ac != null && consulta_PS_FUNCIONALIDAD_ac.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_FUNCIONALIDAD_acciones encontrados " + consulta_PS_FUNCIONALIDAD_ac.Count.ToString());
                        foreach (BsonDocument itemPS_FUNCIONALIDAD in consulta_PS_FUNCIONALIDAD_ac)
                        {
                            id_mongo = itemPS_FUNCIONALIDAD.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_FUNCIONALIDAD_acciones = itemPS_FUNCIONALIDAD.GetElement("acciones").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_FUNCIONALIDAD_acciones != null && consulta_PS_FUNCIONALIDAD_acciones.Count() > 0)
                            {
                                foreach (BsonValue itemPS_FUNCIONALIDAD_acciones in consulta_PS_FUNCIONALIDAD_acciones)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga =
                                            (itemPS_FUNCIONALIDAD.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_FUNCIONALIDAD.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_FUNCIONALIDAD.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_FUNCIONALIDAD.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_FUNCIONALIDAD.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            "~|" + (itemPS_FUNCIONALIDAD_acciones.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_FUNCIONALIDAD_acciones Id: " + id_mongo + "," + itemPS_FUNCIONALIDAD_acciones.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga != "")
                                            {
                                                Archivo_PS_FUNCIONALIDAD_acciones.WriteLine(sTextoDescarga);
                                                Console.WriteLine(sTextoDescarga);
                                                Conteo_PS_FUNCIONALIDAD_acciones++;
                                            }
                                            //Console.WriteLine("PS_FUNCIONALIDAD_acciones ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_FUNCIONALIDAD_acciones actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_FUNCIONALIDAD_acciones en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_FUNCIONALIDAD_acciones para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_FUNCIONALIDAD_acciones ACTUALIZADA: " + itemPS_FUNCIONALIDAD.GetValue("_id").ToString() + "Numero de PS_FUNCIONALIDAD_acciones actializadas: " + Conteo_PS_FUNCIONALIDAD_acciones);
                            }

                        }

                        if (Conteo_PS_FUNCIONALIDAD_acciones > 0)
                        {
                            Archivo_PS_FUNCIONALIDAD_acciones.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_FUNCIONALIDAD_acciones entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_FUNCIONALIDAD_acciones;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_FUNCIONALIDAD_acciones.Close();

            }
            return Conteo_PS_FUNCIONALIDAD_acciones;
        } //Se ejecuta con Extractor_PS_FUNCIONALIDAD()

        internal static void Extractor_PS_GRUPO_ASIGNACION(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_GRUPO_ASIGNACION");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_GRUPO_ASIGNACION = null;

            int Conteo_GRUPO_ASIGNACION = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_GRUPO_ASIGNACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_GRUPO_ASIGNACION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_GRUPO_ASIGNACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_GRUPO_ASIGNACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_GRUPO_ASIGNACION = builderPS_GRUPO_ASIGNACION.Empty;

                if (tipo == "")
                {
                    filterPS_GRUPO_ASIGNACION = builderPS_GRUPO_ASIGNACION.Or(builderPS_GRUPO_ASIGNACION.Eq("Actualizacion_Extractor", "1"), !builderPS_GRUPO_ASIGNACION.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_GRUPO_ASIGNACION = builderPS_GRUPO_ASIGNACION.And(builderPS_GRUPO_ASIGNACION.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_GRUPO_ASIGNACION.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_GRUPO_ASIGNACION = Col_PS.Find(filterPS_GRUPO_ASIGNACION).ToList();

                if (consulta_PS_GRUPO_ASIGNACION != null && consulta_PS_GRUPO_ASIGNACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_GRUPO_ASIGNACION encontrados " + consulta_PS_GRUPO_ASIGNACION.Count.ToString());
                        foreach (BsonDocument itemPS_GRUPO_ASIGNACION in consulta_PS_GRUPO_ASIGNACION)
                        {
                            id_mongo = itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_GRUPO_ASIGNACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_GRUPO_ASIGNACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_GRUPO_ASIGNACION.Contains("_id") ? !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("_id")?.ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString().Substring(0, 29) : itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("fecha_creacion") && !itemPS_GRUPO_ASIGNACION.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("fecha_creacion").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_GRUPO_ASIGNACION.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("usuario_creacion") && !itemPS_GRUPO_ASIGNACION.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("usuario_creacion").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_GRUPO_ASIGNACION.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_GRUPO_ASIGNACION.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("fecha_actualizacion") && !itemPS_GRUPO_ASIGNACION.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("fecha_actualizacion").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_GRUPO_ASIGNACION.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("usuario_modificacion") && !itemPS_GRUPO_ASIGNACION.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("usuario_modificacion").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_GRUPO_ASIGNACION.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_GRUPO_ASIGNACION.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.ToBsonDocument().Contains("nombre") && !itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("nombre").ToString()) ? (itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("nombre").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("nombre").ToString().Substring(0, 29) : itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("nombre").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("es_activo") && !itemPS_GRUPO_ASIGNACION.GetValue("es_activo").IsBsonNull ? itemPS_GRUPO_ASIGNACION.GetValue("es_activo").ToString().Length > 8 ? itemPS_GRUPO_ASIGNACION.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_GRUPO_ASIGNACION.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("direccion") && !itemPS_GRUPO_ASIGNACION.GetValue("direccion").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("direccion").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("direccion").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.GetValue("direccion").ToString().Substring(0, 29) : itemPS_GRUPO_ASIGNACION.GetValue("direccion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("gerencia") && !itemPS_GRUPO_ASIGNACION.GetValue("gerencia").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("gerencia").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("gerencia").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.GetValue("gerencia").ToString().Substring(0, 29) : itemPS_GRUPO_ASIGNACION.GetValue("gerencia").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("tipo_proceso") && !itemPS_GRUPO_ASIGNACION.GetValue("tipo_proceso").IsBsonNull && !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("tipo_proceso").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("tipo_proceso").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.GetValue("tipo_proceso").ToString().Substring(0, 29) : itemPS_GRUPO_ASIGNACION.GetValue("tipo_proceso").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("descripcion") && !itemPS_GRUPO_ASIGNACION.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.GetValue("descripcion").ToString()) ? (itemPS_GRUPO_ASIGNACION.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_GRUPO_ASIGNACION.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_GRUPO_ASIGNACION.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("es_predeterminado_viabilidad") && !itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_viabilidad").IsBsonNull ? itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_viabilidad").ToString().Length > 8 ? itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_viabilidad").ToString().Substring(0, 8) : itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_viabilidad").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_GRUPO_ASIGNACION.Contains("es_predeterminado_aprovisionamiento") && !itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_aprovisionamiento").IsBsonNull ? itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_aprovisionamiento").ToString().Length > 8 ? itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_aprovisionamiento").ToString().Substring(0, 8) : itemPS_GRUPO_ASIGNACION.GetValue("es_predeterminado_aprovisionamiento").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                           
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_GRUPO_ASIGNACION Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_GRUPO_ASIGNACION.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_GRUPO_ASIGNACION++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_GRUPO_ASIGNACION.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_GRUPO_ASIGNACION++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_GRUPO_ASIGNACION ACTUALIZADA: " + itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString() + "Numero de PS_GRUPO_ASIGNACION actializadas: " + Conteo_GRUPO_ASIGNACION);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_GRUPO_ASIGNACION en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_GRUPO_ASIGNACION para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_GRUPO_ASIGNACION > 0)
                        {
                            Archivo_PS_GRUPO_ASIGNACION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_GRUPO_ASIGNACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_GRUPO_ASIGNACION entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_GRUPO_ASIGNACION.Close();
            }

        }

        internal static void Extractor_PS_GRUPO_ASIGNACION_integrantes(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_GRUPO_ASIGNACION_integrantes");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_GRUPO_ASIGNACION_integrantes = null;

            int Conteo_PS_GRUPO_ASIGNACION_integrantes = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_GRUPO_ASIGNACION_integrantes_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_GRUPO_ASIGNACION_integrantes = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_GRUPO_ASIGNACION = db.GetCollection<BsonDocument>("PS_GRUPO_ASIGNACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_GRUPO_ASIGNACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_GRUPO_ASIGNACION = builderPS_GRUPO_ASIGNACION.Empty;

                if (tipo == "")
                {
                    filterPS_GRUPO_ASIGNACION = builderPS_GRUPO_ASIGNACION.Or(builderPS_GRUPO_ASIGNACION.Eq("integrantes.Actualizacion_Extractor", "1"), !builderPS_GRUPO_ASIGNACION.Exists("integrantes.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_GRUPO_ASIGNACION = builderPS_GRUPO_ASIGNACION.And(builderPS_GRUPO_ASIGNACION.Gte("integrantes.Fecha_extraccion", fechaconsulta.Date), builderPS_GRUPO_ASIGNACION.Lt("integrantes.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_GRUPO_ASIGNACION = Col_PS_GRUPO_ASIGNACION.Find(filterPS_GRUPO_ASIGNACION).ToList();

                if (consulta_PS_GRUPO_ASIGNACION != null && consulta_PS_GRUPO_ASIGNACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_GRUPO_ASIGNACION_integrantes encontrados " + consulta_PS_GRUPO_ASIGNACION.Count.ToString());
                        foreach (BsonDocument itemPS_GRUPO_ASIGNACION in consulta_PS_GRUPO_ASIGNACION)
                        {
                            id_mongo = itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_GRUPO_ASIGNACION_integrantes = itemPS_GRUPO_ASIGNACION.GetElement("integrantes").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_GRUPO_ASIGNACION_integrantes != null && consulta_PS_GRUPO_ASIGNACION_integrantes.Count() > 0)
                            {
                                foreach (BsonValue itemPS_integrantes in consulta_PS_GRUPO_ASIGNACION_integrantes)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemPS_integrantes.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemPS_integrantes.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemPS_integrantes.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_GRUPO_ASIGNACION.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_GRUPO_ASIGNACION.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("id_usuario") && !itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString()) ? (itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString().Length > 30 ? itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("username") && !itemPS_integrantes.ToBsonDocument().GetValue("username").IsBsonNull && !string.IsNullOrEmpty(itemPS_integrantes.ToBsonDocument().GetValue("username").ToString()) ? (itemPS_integrantes.ToBsonDocument().GetValue("username").ToString().Length > 50 ? itemPS_integrantes.ToBsonDocument().GetValue("username").ToString().Substring(0, 50) : itemPS_integrantes.ToBsonDocument().GetValue("username").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("rol") && !itemPS_integrantes.ToBsonDocument().GetValue("rol").IsBsonNull && !string.IsNullOrEmpty(itemPS_integrantes.ToBsonDocument().GetValue("rol").ToString()) ? (itemPS_integrantes.ToBsonDocument().GetValue("rol").ToString().Length > 30 ? itemPS_integrantes.ToBsonDocument().GetValue("rol").ToString().Substring(0, 29) : itemPS_integrantes.ToBsonDocument().GetValue("rol").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("id_rol") && !itemPS_integrantes.ToBsonDocument().GetValue("id_rol").IsBsonNull && !string.IsNullOrEmpty(itemPS_integrantes.ToBsonDocument().GetValue("id_rol").ToString()) ? (itemPS_integrantes.ToBsonDocument().GetValue("id_rol").ToString().Length > 30 ? itemPS_integrantes.ToBsonDocument().GetValue("id_rol").ToString().Substring(0, 29) : itemPS_integrantes.ToBsonDocument().GetValue("id_rol").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("es_activo") && !itemPS_integrantes.ToBsonDocument().GetValue("es_activo").IsBsonNull ? itemPS_integrantes.ToBsonDocument().GetValue("es_activo").ToString().Length > 8 ? itemPS_integrantes.ToBsonDocument().GetValue("es_activo").ToString().Substring(0, 8) : itemPS_integrantes.ToBsonDocument().GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("es_lider") && !itemPS_integrantes.ToBsonDocument().GetValue("es_lider").IsBsonNull ? itemPS_integrantes.ToBsonDocument().GetValue("es_lider").ToString().Length > 8 ? itemPS_integrantes.ToBsonDocument().GetValue("es_lider").ToString().Substring(0, 8) : itemPS_integrantes.ToBsonDocument().GetValue("es_lider").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("nombres") && !itemPS_integrantes.ToBsonDocument().GetValue("nombres").IsBsonNull && !string.IsNullOrEmpty(itemPS_integrantes.ToBsonDocument().GetValue("nombres").ToString()) ? (itemPS_integrantes.ToBsonDocument().GetValue("nombres").ToString().Length > 30 ? itemPS_integrantes.ToBsonDocument().GetValue("nombres").ToString().Substring(0, 29) : itemPS_integrantes.ToBsonDocument().GetValue("nombres").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("apellidos") && !itemPS_integrantes.ToBsonDocument().GetValue("apellidos").IsBsonNull && !string.IsNullOrEmpty(itemPS_integrantes.ToBsonDocument().GetValue("apellidos").ToString()) ? (itemPS_integrantes.ToBsonDocument().GetValue("apellidos").ToString().Length > 30 ? itemPS_integrantes.ToBsonDocument().GetValue("apellidos").ToString().Substring(0, 29) : itemPS_integrantes.ToBsonDocument().GetValue("apellidos").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemPS_integrantes.ToBsonDocument().Contains("es_principal") && !itemPS_integrantes.ToBsonDocument().GetValue("es_principal").IsBsonNull ? itemPS_integrantes.ToBsonDocument().GetValue("es_principal").ToString().Length > 8 ? itemPS_integrantes.ToBsonDocument().GetValue("es_principal").ToString().Substring(0, 8) : itemPS_integrantes.ToBsonDocument().GetValue("es_principal").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,

                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_GRUPO_ASIGNACION_integrantes Id: " + id_mongo + "," + itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_GRUPO_ASIGNACION_integrantes.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_GRUPO_ASIGNACION.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_solicita.id_usuario", itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_solicita.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_solicita.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_GRUPO_ASIGNACION_integrantes++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemPS_integrantes.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_GRUPO_ASIGNACION.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("usuario_solicita.id_usuario", itemPS_integrantes.ToBsonDocument().GetValue("id_usuario").ToString())),
                                                                   Builders<BsonDocument>.Update.Set("usuario_solicita.Actualizacion_Extractor", "0")
                                                                                                .Set("usuario_solicita.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_GRUPO_ASIGNACION_integrantes++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_GRUPO_ASIGNACION_integrantes ACTUALIZADA: " + itemPS_GRUPO_ASIGNACION.GetValue("_id").ToString() + "Numero de PS_GRUPO_ASIGNACION_integrantes actializadas: " + Conteo_PS_GRUPO_ASIGNACION_integrantes);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_GRUPO_ASIGNACION_integrantes en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_GRUPO_ASIGNACION_integrantes para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_GRUPO_ASIGNACION_integrantes > 0)
                        {
                            Archivo_PS_GRUPO_ASIGNACION_integrantes.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_GRUPO_ASIGNACION_integrantes_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_GRUPO_ASIGNACION_integrantes entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_GRUPO_ASIGNACION_integrantes.Close();
            }

        }

        internal static void Extractor_PS_HISTORICO_MODIFICACIONES(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_HISTORICO_MODIFICACIONES");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_HISTORICO_MODIFICACIONES = null;

            int Conteo_HISTORICO_MODIFICACIONES = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_HISTORICO_MODIFICACIONES_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_HISTORICO_MODIFICACIONES = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_HISTORICO_MODIFICACIONES");
                FilterDefinitionBuilder<BsonDocument> builderPS_HISTORICO_MODIFICACIONES = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_HISTORICO_MODIFICACIONES = builderPS_HISTORICO_MODIFICACIONES.Empty;

                if (tipo == "")
                {
                    filterPS_HISTORICO_MODIFICACIONES = builderPS_HISTORICO_MODIFICACIONES.Or(builderPS_HISTORICO_MODIFICACIONES.Eq("Actualizacion_Extractor", "1"), !builderPS_HISTORICO_MODIFICACIONES.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_HISTORICO_MODIFICACIONES = builderPS_HISTORICO_MODIFICACIONES.And(builderPS_HISTORICO_MODIFICACIONES.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_HISTORICO_MODIFICACIONES.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_HISTORICO_MODIFICACIONES = Col_PS.Find(filterPS_HISTORICO_MODIFICACIONES).ToList();

                if (consulta_PS_HISTORICO_MODIFICACIONES != null && consulta_PS_HISTORICO_MODIFICACIONES.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_HISTORICO_MODIFICACIONES encontrados " + consulta_PS_HISTORICO_MODIFICACIONES.Count.ToString());
                        foreach (BsonDocument itemPS_HISTORICO_MODIFICACIONES in consulta_PS_HISTORICO_MODIFICACIONES)
                        {
                            id_mongo = itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_HISTORICO_MODIFICACIONES.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_HISTORICO_MODIFICACIONES.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_HISTORICO_MODIFICACIONES.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_HISTORICO_MODIFICACIONES.Contains("_id") ? !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("_id")?.ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString().Length > 30 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString().Substring(0, 29) : itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("fecha") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("fecha").IsBsonNull && !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("fecha").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("fecha").ToString().Length > 30 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("fecha").ToString().Substring(0, 30) : itemPS_HISTORICO_MODIFICACIONES.GetValue("fecha").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("accion") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("accion").IsBsonNull && !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("accion").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("accion").ToString().Length > 30 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("accion").ToString().Substring(0, 29) : itemPS_HISTORICO_MODIFICACIONES.GetValue("accion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("id_usuario") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("id_usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("id_usuario").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("id_usuario").ToString().Length > 30 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("id_usuario").ToString().Substring(0, 29) : itemPS_HISTORICO_MODIFICACIONES.GetValue("id_usuario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("usuario") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("usuario").IsBsonNull && !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("usuario").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("usuario").ToString().Length > 50 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("usuario").ToString().Substring(0, 50) : itemPS_HISTORICO_MODIFICACIONES.GetValue("usuario").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("comentarios") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("comentarios").IsBsonNull ? !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("comentarios").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("comentarios").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("comentarios").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_HISTORICO_MODIFICACIONES.GetValue("comentarios").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("ip") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("ip").IsBsonNull && !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("ip").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("ip").ToString().Length > 50 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("ip").ToString().Substring(0, 50) : itemPS_HISTORICO_MODIFICACIONES.GetValue("ip").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_HISTORICO_MODIFICACIONES.Contains("objeto_serializado") && !itemPS_HISTORICO_MODIFICACIONES.GetValue("objeto_serializado").IsBsonNull && !string.IsNullOrEmpty(itemPS_HISTORICO_MODIFICACIONES.GetValue("objeto_serializado").ToString()) ? (itemPS_HISTORICO_MODIFICACIONES.GetValue("objeto_serializado").ToString().Length > 50 ? itemPS_HISTORICO_MODIFICACIONES.GetValue("objeto_serializado").ToString().Substring(0, 50) : itemPS_HISTORICO_MODIFICACIONES.GetValue("objeto_serializado").ToString()) : ""); // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_HISTORICO_MODIFICACIONES Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_HISTORICO_MODIFICACIONES.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_HISTORICO_MODIFICACIONES++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_HISTORICO_MODIFICACIONES.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_HISTORICO_MODIFICACIONES++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_HISTORICO_MODIFICACIONES ACTUALIZADA: " + itemPS_HISTORICO_MODIFICACIONES.GetValue("_id").ToString() + "Numero de PS_HISTORICO_MODIFICACIONES actializadas: " + Conteo_HISTORICO_MODIFICACIONES);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_HISTORICO_MODIFICACIONES en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_HISTORICO_MODIFICACIONES para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_HISTORICO_MODIFICACIONES > 0)
                        {
                            Archivo_PS_HISTORICO_MODIFICACIONES.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_HISTORICO_MODIFICACIONES_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_HISTORICO_MODIFICACIONES entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_HISTORICO_MODIFICACIONES.Close();
            }

        }

        internal static void Extractor_PS_INVENTARIO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_INVENTARIO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_INVENTARIO = null;

            int Conteo_PS_INVENTARIO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;


            string archivo = path + "PS_INVENTARIO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_INVENTARIO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_INVENTARIO = db.GetCollection<BsonDocument>("PS_INVENTARIO");
                FilterDefinitionBuilder<BsonDocument> builderPS_INVENTARIO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_INVENTARIO = builderPS_INVENTARIO.Empty;

                if (tipo == "")
                {
                    filterPS_INVENTARIO = builderPS_INVENTARIO.Or(builderPS_INVENTARIO.Eq("Actualizacion_Extractor", "1"), !builderPS_INVENTARIO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_INVENTARIO = builderPS_INVENTARIO.And(builderPS_INVENTARIO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_INVENTARIO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_INVENTARIO = Col_PS_INVENTARIO.Find(filterPS_INVENTARIO).ToList();

                if (consulta_PS_INVENTARIO != null && consulta_PS_INVENTARIO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_INVENTARIO encontrados " + consulta_PS_INVENTARIO.Count.ToString());
                        foreach (BsonDocument itemPS_INVENTARIO in consulta_PS_INVENTARIO)
                        {
                            id_mongo = itemPS_INVENTARIO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_INVENTARIO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_INVENTARIO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_INVENTARIO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_INVENTARIO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("_id")?.ToString()) ? (itemPS_INVENTARIO.GetValue("_id").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("_id").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("fecha_creacion") && !itemPS_INVENTARIO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("fecha_creacion").ToString()) ? (itemPS_INVENTARIO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_INVENTARIO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("usuario_creacion") && !itemPS_INVENTARIO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("usuario_creacion").ToString()) ? (itemPS_INVENTARIO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_INVENTARIO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_INVENTARIO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("fecha_actualizacion") && !itemPS_INVENTARIO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_INVENTARIO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_INVENTARIO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("usuario_modificacion") && !itemPS_INVENTARIO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("usuario_modificacion").ToString()) ? (itemPS_INVENTARIO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_INVENTARIO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_INVENTARIO.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("id_producto") && !itemPS_INVENTARIO.GetValue("id_producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("id_producto").ToString()) ? (itemPS_INVENTARIO.GetValue("id_producto").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("id_producto").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("id_producto").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("producto") && !itemPS_INVENTARIO.GetValue("producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("producto").ToString()) ? (itemPS_INVENTARIO.GetValue("producto").ToString().Length > 50 ? itemPS_INVENTARIO.GetValue("producto").ToString().Substring(0, 50) : itemPS_INVENTARIO.GetValue("producto").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("serial") && !itemPS_INVENTARIO.GetValue("serial").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("serial").ToString()) ? (itemPS_INVENTARIO.GetValue("serial").ToString().Length > 50 ? itemPS_INVENTARIO.GetValue("serial").ToString().Substring(0, 50) : itemPS_INVENTARIO.GetValue("serial").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("cantidad") && !itemPS_INVENTARIO.GetValue("cantidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("cantidad").ToString()) ? (itemPS_INVENTARIO.GetValue("cantidad").ToString().Length > 15 ? itemPS_INVENTARIO.GetValue("cantidad").ToString().Substring(0, 15) : itemPS_INVENTARIO.GetValue("cantidad").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("cantidad_reserva") && !itemPS_INVENTARIO.GetValue("cantidad_reserva").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("cantidad_reserva").ToString()) ? (itemPS_INVENTARIO.GetValue("cantidad_reserva").ToString().Length > 15 ? itemPS_INVENTARIO.GetValue("cantidad_reserva").ToString().Substring(0, 15) : itemPS_INVENTARIO.GetValue("cantidad_reserva").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("lote") && !itemPS_INVENTARIO.GetValue("lote").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("lote").ToString()) ? (itemPS_INVENTARIO.GetValue("lote").ToString().Length > 15 ? itemPS_INVENTARIO.GetValue("lote").ToString().Substring(0, 15) : itemPS_INVENTARIO.GetValue("lote").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("estado") ? !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("estado")?.ToString()) ? (itemPS_INVENTARIO.GetValue("estado").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("estado").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("estado").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_INVENTARIO.Contains("id_estado") ? !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("id_estado")?.ToString()) ? (itemPS_INVENTARIO.GetValue("id_estado").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("id_estado").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("id_estado").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_INVENTARIO.Contains("centro_costo") && !itemPS_INVENTARIO.GetValue("centro_costo").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("centro_costo").ToString()) ? (itemPS_INVENTARIO.GetValue("centro_costo").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("centro_costo").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("centro_costo").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("valor_unitario") && !itemPS_INVENTARIO.GetValue("valor_unitario").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("valor_unitario").ToString()) ? (itemPS_INVENTARIO.GetValue("valor_unitario").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("valor_unitario").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("valor_unitario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("bodega") && !itemPS_INVENTARIO.GetValue("bodega").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("bodega").ToString()) ? (itemPS_INVENTARIO.GetValue("bodega").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("bodega").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("bodega").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("id_bodega") && !itemPS_INVENTARIO.GetValue("id_bodega").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("id_bodega").ToString()) ? (itemPS_INVENTARIO.GetValue("id_bodega").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("id_bodega").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("id_bodega").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("ubicacion") && !itemPS_INVENTARIO.GetValue("ubicacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("ubicacion").ToString()) ? (itemPS_INVENTARIO.GetValue("ubicacion").ToString().Length > 15 ? itemPS_INVENTARIO.GetValue("ubicacion").ToString().Substring(0, 15) : itemPS_INVENTARIO.GetValue("ubicacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_INVENTARIO.Contains("documento") && !itemPS_INVENTARIO.GetValue("documento").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("documento").ToString()) ? (itemPS_INVENTARIO.GetValue("documento").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("documento").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("documento").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("posicion") && !itemPS_INVENTARIO.GetValue("posicion").IsBsonNull && !string.IsNullOrEmpty(itemPS_INVENTARIO.GetValue("posicion").ToString()) ? (itemPS_INVENTARIO.GetValue("posicion").ToString().Length > 30 ? itemPS_INVENTARIO.GetValue("posicion").ToString().Substring(0, 29) : itemPS_INVENTARIO.GetValue("posicion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_INVENTARIO.Contains("es_activo") && !itemPS_INVENTARIO.GetValue("es_activo").IsBsonNull ? itemPS_INVENTARIO.GetValue("es_activo").ToString().Length > 8 ? itemPS_INVENTARIO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_INVENTARIO.GetValue("es_activo").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,

                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_INVENTARIO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_INVENTARIO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_INVENTARIO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_INVENTARIO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_INVENTARIO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_INVENTARIO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_INVENTARIO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_INVENTARIO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_INVENTARIO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_INVENTARIO ACTUALIZADA: " + itemPS_INVENTARIO.GetValue("_id").ToString() + "Numero de PS_INVENTARIO actializadas: " + Conteo_PS_INVENTARIO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_INVENTARIO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_INVENTARIO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_INVENTARIO > 0)
                        {
                            Archivo_PS_INVENTARIO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_INVENTARIO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");                               
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_INVENTARIO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_INVENTARIO.Close();
            }

        }

        internal static void Extractor_PS_INVENTARIO_accion_inventario(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_INVENTARIO_accion_inventario");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_INVENTARIO_accion_inventario = null;

            int Conteo_PS_INVENTARIO_accion_inventario = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_INVENTARIO_accion_inventario_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_INVENTARIO_accion_inventario = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_INVENTARIO = db.GetCollection<BsonDocument>("PS_INVENTARIO");
                FilterDefinitionBuilder<BsonDocument> builderPS_INVENTARIO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_INVENTARIO = builderPS_INVENTARIO.Empty;

                if (tipo == "")
                {
                    filterPS_INVENTARIO = builderPS_INVENTARIO.Or(builderPS_INVENTARIO.Eq("accion_inventario.Actualizacion_Extractor", "1"), !builderPS_INVENTARIO.Exists("accion_inventario.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_INVENTARIO = builderPS_INVENTARIO.And(builderPS_INVENTARIO.Gte("accion_inventario.Fecha_extraccion", fechaconsulta.Date), builderPS_INVENTARIO.Lt("accion_inventario.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_INVENTARIO = Col_PS_INVENTARIO.Find(filterPS_INVENTARIO).ToList();

                if (consulta_PS_INVENTARIO != null && consulta_PS_INVENTARIO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_INVENTARIO_accion_inventario encontrados " + consulta_PS_INVENTARIO.Count.ToString());
                        foreach (BsonDocument itemPS_INVENTARIO in consulta_PS_INVENTARIO)
                        {
                            id_mongo = itemPS_INVENTARIO.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_INVENTARIO_accion_inventario = itemPS_INVENTARIO.GetElement("accion_inventario").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_INVENTARIO_accion_inventario != null && consulta_PS_INVENTARIO_accion_inventario.Count() > 0)
                            {
                                foreach (BsonValue itemaccion_inventario in consulta_PS_INVENTARIO_accion_inventario)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itemaccion_inventario.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itemaccion_inventario.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itemaccion_inventario.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_INVENTARIO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_INVENTARIO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_INVENTARIO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_INVENTARIO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_INVENTARIO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("_id") && !itemaccion_inventario.ToBsonDocument().GetValue("_id").IsBsonNull && !string.IsNullOrEmpty(itemaccion_inventario.ToBsonDocument().GetValue("_id").ToString()) ? (itemaccion_inventario.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemaccion_inventario.ToBsonDocument().GetValue("_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("fecha_creacion") && !itemaccion_inventario.ToBsonDocument().GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemaccion_inventario.ToBsonDocument().GetValue("fecha_creacion").ToString()) ? (itemaccion_inventario.ToBsonDocument().GetValue("fecha_creacion").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("fecha_creacion").ToString().Substring(0, 30) : itemaccion_inventario.ToBsonDocument().GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("usuario_creacion") && !itemaccion_inventario.ToBsonDocument().GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemaccion_inventario.ToBsonDocument().GetValue("usuario_creacion").ToString()) ? (itemaccion_inventario.ToBsonDocument().GetValue("usuario_creacion").ToString().Length > 50 ? itemaccion_inventario.ToBsonDocument().GetValue("usuario_creacion").ToString().Substring(0, 50) : itemaccion_inventario.ToBsonDocument().GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("fecha_actualizacion") && !itemaccion_inventario.ToBsonDocument().GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemaccion_inventario.ToBsonDocument().GetValue("fecha_actualizacion").ToString()) ? (itemaccion_inventario.ToBsonDocument().GetValue("fecha_actualizacion").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemaccion_inventario.ToBsonDocument().GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("usuario_modificacion") && !itemaccion_inventario.ToBsonDocument().GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemaccion_inventario.ToBsonDocument().GetValue("usuario_modificacion").ToString()) ? (itemaccion_inventario.ToBsonDocument().GetValue("usuario_modificacion").ToString().Length > 50 ? itemaccion_inventario.ToBsonDocument().GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemaccion_inventario.ToBsonDocument().GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("tipo_accion") && !itemaccion_inventario.ToBsonDocument().GetValue("tipo_accion").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("tipo_accion").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("tipo_accion").ToString().Substring(0, 30) : itemaccion_inventario.ToBsonDocument().GetValue("tipo_accion").ToString() : "") +
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("id_tipo_accion") && !itemaccion_inventario.ToBsonDocument().GetValue("id_tipo_accion").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("id_tipo_accion").ToString().Length > 8 ? itemaccion_inventario.ToBsonDocument().GetValue("id_tipo_accion").ToString().Substring(0, 8) : itemaccion_inventario.ToBsonDocument().GetValue("id_tipo_accion").ToString() : "") +
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("cantidad") && !itemaccion_inventario.ToBsonDocument().GetValue("cantidad").IsBsonNull && !string.IsNullOrEmpty(itemaccion_inventario.ToBsonDocument().GetValue("cantidad").ToString()) ? (itemaccion_inventario.ToBsonDocument().GetValue("cantidad").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("cantidad").ToString().Substring(0, 29) : itemaccion_inventario.ToBsonDocument().GetValue("cantidad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("estado_inicial") && !itemaccion_inventario.ToBsonDocument().GetValue("estado_inicial").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("estado_inicial").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("estado_inicial").ToString().Substring(0, 30) : itemaccion_inventario.ToBsonDocument().GetValue("estado_inicial").ToString() : "") +
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("id_estado_inicial") && !itemaccion_inventario.ToBsonDocument().GetValue("id_estado_inicial").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("id_estado_inicial").ToString().Length > 8 ? itemaccion_inventario.ToBsonDocument().GetValue("id_estado_inicial").ToString().Substring(0, 8) : itemaccion_inventario.ToBsonDocument().GetValue("id_estado_inicial").ToString() : "") +
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("estado_final") && !itemaccion_inventario.ToBsonDocument().GetValue("estado_final").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("estado_final").ToString().Length > 30 ? itemaccion_inventario.ToBsonDocument().GetValue("estado_final").ToString().Substring(0, 30) : itemaccion_inventario.ToBsonDocument().GetValue("estado_final").ToString() : "") +
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("id_estado_final") && !itemaccion_inventario.ToBsonDocument().GetValue("id_estado_final").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("id_estado_final").ToString().Length > 8 ? itemaccion_inventario.ToBsonDocument().GetValue("id_estado_final").ToString().Substring(0, 8) : itemaccion_inventario.ToBsonDocument().GetValue("id_estado_final").ToString() : "") +
                                                "~|" + (itemaccion_inventario.ToBsonDocument().Contains("id_aprovisionamiento") && !itemaccion_inventario.ToBsonDocument().GetValue("id_aprovisionamiento").IsBsonNull ? itemaccion_inventario.ToBsonDocument().GetValue("id_aprovisionamiento").ToString().Length > 8 ? itemaccion_inventario.ToBsonDocument().GetValue("id_aprovisionamiento").ToString().Substring(0, 8) : itemaccion_inventario.ToBsonDocument().GetValue("id_aprovisionamiento").ToString() : "");
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_INVENTARIO_accion_inventario Id: " + id_mongo + "," + itemaccion_inventario.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_INVENTARIO_accion_inventario.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_INVENTARIO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_INVENTARIO.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("accion_inventario._id", MongoDB.Bson.ObjectId.Parse(itemaccion_inventario.ToBsonDocument().GetValue("_id").ToString()))),
                                                                   Builders<BsonDocument>.Update.Set("accion_inventario.Actualizacion_Extractor", "0")
                                                                                                .Set("accion_inventario.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_INVENTARIO_accion_inventario++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itemaccion_inventario.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_INVENTARIO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                  Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_INVENTARIO.GetValue("_id").ToString())),
                                                                  Builders<BsonDocument>.Filter.Eq("accion_inventario._id", MongoDB.Bson.ObjectId.Parse(itemaccion_inventario.ToBsonDocument().GetValue("_id").ToString()))),
                                                                  Builders<BsonDocument>.Update.Set("accion_inventario.Actualizacion_Extractor", "0")
                                                                                               .Set("accion_inventario.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_INVENTARIO_accion_inventario++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_INVENTARIO_accion_inventario ACTUALIZADA: " + itemPS_INVENTARIO.GetValue("_id").ToString() + "Numero de PS_INVENTARIO_accion_inventario actializadas: " + Conteo_PS_INVENTARIO_accion_inventario);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_INVENTARIO_accion_inventario en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_INVENTARIO_accion_inventario para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_INVENTARIO_accion_inventario > 0)
                        {
                            Archivo_PS_INVENTARIO_accion_inventario.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_INVENTARIO_accion_inventario_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_INVENTARIO_accion_inventario entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_INVENTARIO_accion_inventario.Close();
            }

        }

        internal static void Extractor_PS_MOVIMIENTO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_MOVIMIENTO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_MOVIMIENTO = null;

            int Conteo_PS_MOVIMIENTO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;


            string archivo = path + "PS_MOVIMIENTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_MOVIMIENTO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_MOVIMIENTO = db.GetCollection<BsonDocument>("PS_MOVIMIENTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_MOVIMIENTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_MOVIMIENTO = builderPS_MOVIMIENTO.Empty;

                if (tipo == "")
                {
                    filterPS_MOVIMIENTO = builderPS_MOVIMIENTO.Or(builderPS_MOVIMIENTO.Eq("Actualizacion_Extractor", "1"), !builderPS_MOVIMIENTO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_MOVIMIENTO = builderPS_MOVIMIENTO.And(builderPS_MOVIMIENTO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_MOVIMIENTO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_MOVIMIENTO = Col_PS_MOVIMIENTO.Find(filterPS_MOVIMIENTO).ToList();

                if (consulta_PS_MOVIMIENTO != null && consulta_PS_MOVIMIENTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_MOVIMIENTO encontrados " + consulta_PS_MOVIMIENTO.Count.ToString());
                        foreach (BsonDocument itemPS_MOVIMIENTO in consulta_PS_MOVIMIENTO)
                        {
                            id_mongo = itemPS_MOVIMIENTO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_MOVIMIENTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_MOVIMIENTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_MOVIMIENTO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_MOVIMIENTO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("_id")?.ToString()) ? (itemPS_MOVIMIENTO.GetValue("_id").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("_id").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("fecha_creacion") && !itemPS_MOVIMIENTO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("fecha_creacion").ToString()) ? (itemPS_MOVIMIENTO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_MOVIMIENTO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("usuario_creacion") && !itemPS_MOVIMIENTO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("usuario_creacion").ToString()) ? (itemPS_MOVIMIENTO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("fecha_actualizacion") && !itemPS_MOVIMIENTO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_MOVIMIENTO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_MOVIMIENTO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("usuario_modificacion") && !itemPS_MOVIMIENTO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("usuario_modificacion").ToString()) ? (itemPS_MOVIMIENTO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("id_inventario") && !itemPS_MOVIMIENTO.GetValue("id_inventario").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("id_inventario").ToString()) ? (itemPS_MOVIMIENTO.GetValue("id_inventario").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("id_inventario").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("id_inventario").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_MOVIMIENTO.Contains("id_movimiento") && !itemPS_MOVIMIENTO.GetValue("id_movimiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("id_movimiento").ToString()) ? (itemPS_MOVIMIENTO.GetValue("id_movimiento").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("id_movimiento").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("id_movimiento").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_MOVIMIENTO.Contains("movimiento") && !itemPS_MOVIMIENTO.GetValue("movimiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("movimiento").ToString()) ? (itemPS_MOVIMIENTO.GetValue("movimiento").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("movimiento").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("movimiento").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("cantidad") && !itemPS_MOVIMIENTO.GetValue("cantidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("cantidad").ToString()) ? (itemPS_MOVIMIENTO.GetValue("cantidad").ToString().Length > 15 ? itemPS_MOVIMIENTO.GetValue("cantidad").ToString().Substring(0, 15) : itemPS_MOVIMIENTO.GetValue("cantidad").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("id_estado_inicial") ? !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("id_estado_inicial")?.ToString()) ? (itemPS_MOVIMIENTO.GetValue("id_estado_inicial").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("id_estado_inicial").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("id_estado_inicial").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_MOVIMIENTO.Contains("estado_inicial") && !itemPS_MOVIMIENTO.GetValue("estado_inicial").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("estado_inicial").ToString()) ? (itemPS_MOVIMIENTO.GetValue("estado_inicial").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("estado_inicial").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("estado_inicial").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("id_estado_final") && !itemPS_MOVIMIENTO.GetValue("id_estado_final").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("id_estado_final").ToString()) ? (itemPS_MOVIMIENTO.GetValue("id_estado_final").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("id_estado_final").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("id_estado_final").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_MOVIMIENTO.Contains("estado_final") && !itemPS_MOVIMIENTO.GetValue("estado_final").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("estado_final").ToString()) ? (itemPS_MOVIMIENTO.GetValue("estado_final").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("estado_final").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("estado_final").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("id_bodega_inicial") && !itemPS_MOVIMIENTO.GetValue("id_bodega_inicial").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("id_bodega_inicial").ToString()) ? (itemPS_MOVIMIENTO.GetValue("id_bodega_inicial").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("id_bodega_inicial").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("id_bodega_inicial").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_MOVIMIENTO.Contains("bodega_inicial") && !itemPS_MOVIMIENTO.GetValue("bodega_inicial").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("bodega_inicial").ToString()) ? (itemPS_MOVIMIENTO.GetValue("bodega_inicial").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("bodega_inicial").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("bodega_inicial").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("id_bodega_final") && !itemPS_MOVIMIENTO.GetValue("id_bodega_final").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("id_bodega_final").ToString()) ? (itemPS_MOVIMIENTO.GetValue("id_bodega_final").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("id_bodega_final").ToString().Substring(0, 29) : itemPS_MOVIMIENTO.GetValue("id_bodega_final").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        "~|" + (itemPS_MOVIMIENTO.Contains("bodega_final") && !itemPS_MOVIMIENTO.GetValue("bodega_final").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("bodega_final").ToString()) ? (itemPS_MOVIMIENTO.GetValue("bodega_final").ToString().Length > 50 ? itemPS_MOVIMIENTO.GetValue("bodega_final").ToString().Substring(0, 50) : itemPS_MOVIMIENTO.GetValue("bodega_final").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("observacion") && !itemPS_MOVIMIENTO.GetValue("observacion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("observacion").ToString()) ? (itemPS_MOVIMIENTO.GetValue("observacion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_MOVIMIENTO.GetValue("observacion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_MOVIMIENTO.GetValue("observacion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("fecha_movimiento") && !itemPS_MOVIMIENTO.GetValue("fecha_movimiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_MOVIMIENTO.GetValue("fecha_movimiento").ToString()) ? (itemPS_MOVIMIENTO.GetValue("fecha_movimiento").ToString().Length > 30 ? itemPS_MOVIMIENTO.GetValue("fecha_movimiento").ToString().Substring(0, 30) : itemPS_MOVIMIENTO.GetValue("fecha_movimiento").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_MOVIMIENTO.Contains("es_activo") && !itemPS_MOVIMIENTO.GetValue("es_activo").IsBsonNull ? itemPS_MOVIMIENTO.GetValue("es_activo").ToString().Length > 8 ? itemPS_MOVIMIENTO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_MOVIMIENTO.GetValue("es_activo").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_MOVIMIENTO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_MOVIMIENTO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_MOVIMIENTO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_MOVIMIENTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_MOVIMIENTO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_MOVIMIENTO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_MOVIMIENTO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_MOVIMIENTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_MOVIMIENTO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_MOVIMIENTO ACTUALIZADA: " + itemPS_MOVIMIENTO.GetValue("_id").ToString() + "Numero de PS_MOVIMIENTO actializadas: " + Conteo_PS_MOVIMIENTO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_MOVIMIENTO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_MOVIMIENTO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_MOVIMIENTO > 0)
                        {
                            Archivo_PS_MOVIMIENTO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_MOVIMIENTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");                               
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_MOVIMIENTO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_MOVIMIENTO.Close();
            }

        }

        internal static void Extractor_PS_PARAMETRO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_PARAMETRO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_PARAMETRO = null;

            int Conteo_PS_PARAMETRO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;


            string archivo = path + "PS_PARAMETRO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_PARAMETRO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_PARAMETRO = db.GetCollection<BsonDocument>("PS_PARAMETRO");
                FilterDefinitionBuilder<BsonDocument> builderPS_PARAMETRO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_PARAMETRO = builderPS_PARAMETRO.Empty;

                if (tipo == "")
                {
                    filterPS_PARAMETRO = builderPS_PARAMETRO.Or(builderPS_PARAMETRO.Eq("Actualizacion_Extractor", "1"), !builderPS_PARAMETRO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_PARAMETRO = builderPS_PARAMETRO.And(builderPS_PARAMETRO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_PARAMETRO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_PARAMETRO = Col_PS_PARAMETRO.Find(filterPS_PARAMETRO).ToList();

                if (consulta_PS_PARAMETRO != null && consulta_PS_PARAMETRO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_PARAMETRO encontrados " + consulta_PS_PARAMETRO.Count.ToString());
                        foreach (BsonDocument itemPS_PARAMETRO in consulta_PS_PARAMETRO)
                        {
                            id_mongo = itemPS_PARAMETRO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_PARAMETRO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_PARAMETRO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_PARAMETRO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_PARAMETRO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("_id")?.ToString()) ? (itemPS_PARAMETRO.GetValue("_id").ToString().Length > 30 ? itemPS_PARAMETRO.GetValue("_id").ToString().Substring(0, 29) : itemPS_PARAMETRO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("fecha_creacion") && !itemPS_PARAMETRO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("fecha_creacion").ToString()) ? (itemPS_PARAMETRO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_PARAMETRO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_PARAMETRO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("usuario_creacion") && !itemPS_PARAMETRO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("usuario_creacion").ToString()) ? (itemPS_PARAMETRO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_PARAMETRO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_PARAMETRO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("fecha_actualizacion") && !itemPS_PARAMETRO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_PARAMETRO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_PARAMETRO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_PARAMETRO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("usuario_modificacion") && !itemPS_PARAMETRO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("usuario_modificacion").ToString()) ? (itemPS_PARAMETRO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_PARAMETRO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_PARAMETRO.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("nombre") && !itemPS_PARAMETRO.GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("nombre").ToString()) ? (itemPS_PARAMETRO.GetValue("nombre").ToString().Length > 50 ? itemPS_PARAMETRO.GetValue("nombre").ToString().Substring(0, 50) : itemPS_PARAMETRO.GetValue("nombre").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("valor") && !itemPS_PARAMETRO.GetValue("valor").IsBsonNull && !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("valor").ToString()) ? (itemPS_PARAMETRO.GetValue("valor").ToString().Length > 50 ? itemPS_PARAMETRO.GetValue("valor").ToString().Substring(0, 50) : itemPS_PARAMETRO.GetValue("valor").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("es_activo") && !itemPS_PARAMETRO.GetValue("es_activo").IsBsonNull ? itemPS_PARAMETRO.GetValue("es_activo").ToString().Length > 8 ? itemPS_PARAMETRO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_PARAMETRO.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PARAMETRO.Contains("modulo") ? !string.IsNullOrEmpty(itemPS_PARAMETRO.GetValue("modulo")?.ToString()) ? (itemPS_PARAMETRO.GetValue("modulo").ToString().Length > 30 ? itemPS_PARAMETRO.GetValue("modulo").ToString().Substring(0, 29) : itemPS_PARAMETRO.GetValue("modulo").ToString()) : "" : "");  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC, 
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_PARAMETRO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_PARAMETRO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS_PARAMETRO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PARAMETRO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_PARAMETRO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_PARAMETRO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS_PARAMETRO.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PARAMETRO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_PARAMETRO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_PARAMETRO ACTUALIZADA: " + itemPS_PARAMETRO.GetValue("_id").ToString() + "Numero de PS_PARAMETRO actializadas: " + Conteo_PS_PARAMETRO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_PARAMETRO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_PARAMETRO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_PARAMETRO > 0)
                        {
                            Archivo_PS_PARAMETRO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_PARAMETRO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");                               
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_PARAMETRO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_PARAMETRO.Close();
            }

        }

        internal static void Extractor_PS_PLANTILLA_COMUNICACION(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_PLANTILLA_COMUNICACION");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_PLANTILLA_COMUNICACION = null;

            int Conteo_PS_PLANTILLA_COMUNICACION = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_PLANTILLA_COMUNICACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_PLANTILLA_COMUNICACION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_PLANTILLA_COMUNICACION");
                FilterDefinitionBuilder<BsonDocument> builderPS_PLANTILLA_COMUNICACION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_PLANTILLA_COMUNICACION = builderPS_PLANTILLA_COMUNICACION.Empty;

                if (tipo == "")
                {
                    filterPS_PLANTILLA_COMUNICACION = builderPS_PLANTILLA_COMUNICACION.Or(builderPS_PLANTILLA_COMUNICACION.Eq("Actualizacion_Extractor", "1"), !builderPS_PLANTILLA_COMUNICACION.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_PLANTILLA_COMUNICACION = builderPS_PLANTILLA_COMUNICACION.And(builderPS_PLANTILLA_COMUNICACION.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_PLANTILLA_COMUNICACION.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_PLANTILLA_COMUNICACION = Col_PS.Find(filterPS_PLANTILLA_COMUNICACION).ToList();

                if (consulta_PS_PLANTILLA_COMUNICACION != null && consulta_PS_PLANTILLA_COMUNICACION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_PLANTILLA_COMUNICACION encontrados " + consulta_PS_PLANTILLA_COMUNICACION.Count.ToString());
                        foreach (BsonDocument itemPS_PLANTILLA_COMUNICACION in consulta_PS_PLANTILLA_COMUNICACION)
                        {
                            id_mongo = itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_PLANTILLA_COMUNICACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_PLANTILLA_COMUNICACION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_PLANTILLA_COMUNICACION.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_PLANTILLA_COMUNICACION.Contains("_id") ? !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("_id")?.ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString().Substring(0, 29) : itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("fecha_creacion") && !itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_creacion").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("usuario_creacion") && !itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_creacion").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("fecha_actualizacion") && !itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_actualizacion").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_PLANTILLA_COMUNICACION.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("usuario_modificacion") && !itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_modificacion").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_PLANTILLA_COMUNICACION.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("Plantilla") && !itemPS_PLANTILLA_COMUNICACION.GetValue("Plantilla").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("Plantilla").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("Plantilla").ToString().Length > 50 ? itemPS_PLANTILLA_COMUNICACION.GetValue("Plantilla").ToString().Substring(0, 50) : itemPS_PLANTILLA_COMUNICACION.GetValue("Plantilla").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("observaciones") && !itemPS_PLANTILLA_COMUNICACION.GetValue("observaciones").IsBsonNull ? !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("observaciones").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_PLANTILLA_COMUNICACION.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_PLANTILLA_COMUNICACION.GetValue("observaciones").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("htmlPlantilla") ? !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("htmlPlantilla")?.ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("htmlPlantilla").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("htmlPlantilla").ToString().Substring(0, 29) : itemPS_PLANTILLA_COMUNICACION.GetValue("htmlPlantilla").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("es_activo") && !itemPS_PLANTILLA_COMUNICACION.GetValue("es_activo").IsBsonNull ? itemPS_PLANTILLA_COMUNICACION.GetValue("es_activo").ToString().Length > 8 ? itemPS_PLANTILLA_COMUNICACION.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_PLANTILLA_COMUNICACION.GetValue("es_activo").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("id_tipo_plantilla") ? !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_plantilla")?.ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_plantilla").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_plantilla").ToString().Substring(0, 29) : itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_plantilla").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("tipo_plantilla") && !itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_plantilla").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_plantilla").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_plantilla").ToString().Length > 50 ? itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_plantilla").ToString().Substring(0, 50) : itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_plantilla").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("id_producto") ? !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("id_producto")?.ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("id_producto").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("id_producto").ToString().Substring(0, 29) : itemPS_PLANTILLA_COMUNICACION.GetValue("id_producto").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("producto") && !itemPS_PLANTILLA_COMUNICACION.GetValue("producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("producto").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("producto").ToString().Length > 50 ? itemPS_PLANTILLA_COMUNICACION.GetValue("producto").ToString().Substring(0, 50) : itemPS_PLANTILLA_COMUNICACION.GetValue("producto").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("id_tipo_operacion") ? !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_operacion")?.ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_operacion").ToString().Length > 30 ? itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_operacion").ToString().Substring(0, 29) : itemPS_PLANTILLA_COMUNICACION.GetValue("id_tipo_operacion").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PLANTILLA_COMUNICACION.Contains("tipo_operacion") && !itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_operacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_operacion").ToString()) ? (itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_operacion").ToString().Length > 50 ? itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_operacion").ToString().Substring(0, 50) : itemPS_PLANTILLA_COMUNICACION.GetValue("tipo_operacion").ToString()) : ""); // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_PLANTILLA_COMUNICACION Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_PLANTILLA_COMUNICACION.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_PLANTILLA_COMUNICACION++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_PLANTILLA_COMUNICACION.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_PLANTILLA_COMUNICACION++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_PLANTILLA_COMUNICACION ACTUALIZADA: " + itemPS_PLANTILLA_COMUNICACION.GetValue("_id").ToString() + "Numero de PS_PLANTILLA_COMUNICACION actializadas: " + Conteo_PS_PLANTILLA_COMUNICACION);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_PLANTILLA_COMUNICACION en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_PLANTILLA_COMUNICACION para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_PLANTILLA_COMUNICACION > 0)
                        {
                            Archivo_PS_PLANTILLA_COMUNICACION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_PLANTILLA_COMUNICACION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_PLANTILLA_COMUNICACION entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_PLANTILLA_COMUNICACION.Close();
            }

        }

        internal static void Extractor_PS_PRODUCTO(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_PRODUCTO");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_PRODUCTO = null;

            int Conteo_PS_PRODUCTO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_PRODUCTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_PRODUCTO = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_PRODUCTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_PRODUCTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_PRODUCTO = builderPS_PRODUCTO.Empty;

                if (tipo == "")
                {
                    filterPS_PRODUCTO = builderPS_PRODUCTO.Or(builderPS_PRODUCTO.Eq("Actualizacion_Extractor", "1"), !builderPS_PRODUCTO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_PRODUCTO = builderPS_PRODUCTO.And(builderPS_PRODUCTO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_PRODUCTO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_PRODUCTO = Col_PS.Find(filterPS_PRODUCTO).ToList();

                if (consulta_PS_PRODUCTO != null && consulta_PS_PRODUCTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_PRODUCTO encontrados " + consulta_PS_PRODUCTO.Count.ToString());
                        foreach (BsonDocument itemPS_PRODUCTO in consulta_PS_PRODUCTO)
                        {
                            id_mongo = itemPS_PRODUCTO.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_PRODUCTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_PRODUCTO.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_PRODUCTO.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_PRODUCTO.Contains("_id") ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("_id")?.ToString()) ? (itemPS_PRODUCTO.GetValue("_id").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("_id").ToString().Substring(0, 29) : itemPS_PRODUCTO.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("fecha_creacion") && !itemPS_PRODUCTO.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("fecha_creacion").ToString()) ? (itemPS_PRODUCTO.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_PRODUCTO.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("usuario_creacion") && !itemPS_PRODUCTO.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("usuario_creacion").ToString()) ? (itemPS_PRODUCTO.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("fecha_actualizacion") && !itemPS_PRODUCTO.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("fecha_actualizacion").ToString()) ? (itemPS_PRODUCTO.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_PRODUCTO.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("usuario_modificacion") && !itemPS_PRODUCTO.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("usuario_modificacion").ToString()) ? (itemPS_PRODUCTO.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("descripcion") && !itemPS_PRODUCTO.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("descripcion").ToString()) ? (itemPS_PRODUCTO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_PRODUCTO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_PRODUCTO.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("codigo") && !itemPS_PRODUCTO.GetValue("codigo").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("codigo").ToString()) ? (itemPS_PRODUCTO.GetValue("codigo").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("codigo").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("codigo").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("fabricante") && !itemPS_PRODUCTO.GetValue("fabricante").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("fabricante").ToString()) ? (itemPS_PRODUCTO.GetValue("fabricante").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("fabricante").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("fabricante").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("modelo") && !itemPS_PRODUCTO.GetValue("modelo").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("modelo").ToString()) ? (itemPS_PRODUCTO.GetValue("modelo").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("modelo").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("modelo").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("id_ramo") ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("id_ramo")?.ToString()) ? (itemPS_PRODUCTO.GetValue("id_ramo").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("id_ramo").ToString().Substring(0, 29) : itemPS_PRODUCTO.GetValue("id_ramo").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PRODUCTO.Contains("ramo") && !itemPS_PRODUCTO.GetValue("ramo").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("ramo").ToString()) ? (itemPS_PRODUCTO.GetValue("ramo").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("ramo").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("ramo").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("id_tipo_material") ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("id_tipo_material")?.ToString()) ? (itemPS_PRODUCTO.GetValue("id_tipo_material").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("id_tipo_material").ToString().Substring(0, 29) : itemPS_PRODUCTO.GetValue("id_tipo_material").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PRODUCTO.Contains("tipo_material") && !itemPS_PRODUCTO.GetValue("tipo_material").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("tipo_material").ToString()) ? (itemPS_PRODUCTO.GetValue("tipo_material").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("tipo_material").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("tipo_material").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("id_unidad_medida") ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("id_unidad_medida")?.ToString()) ? (itemPS_PRODUCTO.GetValue("id_unidad_medida").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("id_unidad_medida").ToString().Substring(0, 29) : itemPS_PRODUCTO.GetValue("id_unidad_medida").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PRODUCTO.Contains("unidad_medida") && !itemPS_PRODUCTO.GetValue("unidad_medida").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("unidad_medida").ToString()) ? (itemPS_PRODUCTO.GetValue("unidad_medida").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("unidad_medida").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("unidad_medida").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("id_agrupador") ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("id_agrupador")?.ToString()) ? (itemPS_PRODUCTO.GetValue("id_agrupador").ToString().Length > 30 ? itemPS_PRODUCTO.GetValue("id_agrupador").ToString().Substring(0, 29) : itemPS_PRODUCTO.GetValue("id_agrupador").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_PRODUCTO.Contains("agrupador") && !itemPS_PRODUCTO.GetValue("agrupador").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("agrupador").ToString()) ? (itemPS_PRODUCTO.GetValue("agrupador").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("agrupador").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("agrupador").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("comentarios") && !itemPS_PRODUCTO.GetValue("comentarios").IsBsonNull ? !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("comentarios").ToString()) ? (itemPS_PRODUCTO.GetValue("comentarios").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_PRODUCTO.GetValue("comentarios").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_PRODUCTO.GetValue("comentarios").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("es_serializable") && !itemPS_PRODUCTO.GetValue("es_serializable").IsBsonNull ? itemPS_PRODUCTO.GetValue("es_serializable").ToString().Length > 8 ? itemPS_PRODUCTO.GetValue("es_serializable").ToString().Substring(0, 8) : itemPS_PRODUCTO.GetValue("es_serializable").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("existencia_minima") && !itemPS_PRODUCTO.GetValue("existencia_minima").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("existencia_minima").ToString()) ? (itemPS_PRODUCTO.GetValue("existencia_minima").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("existencia_minima").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("existencia_minima").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("existencia_maxima") && !itemPS_PRODUCTO.GetValue("existencia_maxima").IsBsonNull && !string.IsNullOrEmpty(itemPS_PRODUCTO.GetValue("existencia_maxima").ToString()) ? (itemPS_PRODUCTO.GetValue("existencia_maxima").ToString().Length > 50 ? itemPS_PRODUCTO.GetValue("existencia_maxima").ToString().Substring(0, 50) : itemPS_PRODUCTO.GetValue("existencia_maxima").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("es_fisico") && !itemPS_PRODUCTO.GetValue("es_fisico").IsBsonNull ? itemPS_PRODUCTO.GetValue("es_fisico").ToString().Length > 8 ? itemPS_PRODUCTO.GetValue("es_fisico").ToString().Substring(0, 8) : itemPS_PRODUCTO.GetValue("es_fisico").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_PRODUCTO.Contains("es_activo") && !itemPS_PRODUCTO.GetValue("es_activo").IsBsonNull ? itemPS_PRODUCTO.GetValue("es_activo").ToString().Length > 8 ? itemPS_PRODUCTO.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_PRODUCTO.GetValue("es_activo").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_PRODUCTO Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_PRODUCTO.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PRODUCTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_PRODUCTO++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_PRODUCTO.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PRODUCTO.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_PRODUCTO++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_PRODUCTO ACTUALIZADA: " + itemPS_PRODUCTO.GetValue("_id").ToString() + "Numero de PS_PRODUCTO actializadas: " + Conteo_PS_PRODUCTO);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_PRODUCTO en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_PRODUCTO para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_PRODUCTO > 0)
                        {
                            Archivo_PS_PRODUCTO.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_PRODUCTO_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_PRODUCTO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_PRODUCTO.Close();
            }

        }

        internal static void Extractor_PS_PRODUCTO_atributos_producto(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_PRODUCTO_atributos_producto");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_PRODUCTO_atributos = null;

            int Conteo_PS_PRODUCTO = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;

            string archivo = path + "PS_PRODUCTO_atributos_producto_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_PRODUCTO_atributos = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_PRODUCTO = db.GetCollection<BsonDocument>("PS_PRODUCTO");
                FilterDefinitionBuilder<BsonDocument> builderPS_PRODUCTO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_PRODUCTO = builderPS_PRODUCTO.Empty;

                if (tipo == "")
                {
                    filterPS_PRODUCTO = builderPS_PRODUCTO.Or(builderPS_PRODUCTO.Eq("atributos_producto.Actualizacion_Extractor", "1"), !builderPS_PRODUCTO.Exists("atributos_producto.Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);
                    filterPS_PRODUCTO = builderPS_PRODUCTO.And(builderPS_PRODUCTO.Gte("atributos_producto.Fecha_extraccion", fechaconsulta.Date), builderPS_PRODUCTO.Lt("atributos_producto.Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_PRODUCTO = Col_PS_PRODUCTO.Find(filterPS_PRODUCTO).ToList();

                if (consulta_PS_PRODUCTO != null && consulta_PS_PRODUCTO.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_PRODUCTO_atributos_producto encontrados " + consulta_PS_PRODUCTO.Count.ToString());
                        foreach (BsonDocument itemPS_PRODUCTO in consulta_PS_PRODUCTO)
                        {
                            id_mongo = itemPS_PRODUCTO.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_PRODUCTO_atributos_producto = itemPS_PRODUCTO.GetElement("atributos_producto").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_PRODUCTO_atributos_producto != null && consulta_PS_PRODUCTO_atributos_producto.Count() > 0)
                            {
                                foreach (BsonValue itematributos_producto in consulta_PS_PRODUCTO_atributos_producto)
                                {
                                    try
                                    {
                                        if (!string.IsNullOrEmpty(id_mongo)
                                            && (!itematributos_producto.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || itematributos_producto.ToBsonDocument().Contains("Actualizacion_Extractor")
                                            || (itematributos_producto.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                            )
                                        {
                                            try
                                            {
                                                sTextoDescarga =
                                                (itemPS_PRODUCTO.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_PRODUCTO.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_PRODUCTO.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_PRODUCTO.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_PRODUCTO.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("_id") && !itematributos_producto.ToBsonDocument().GetValue("_id").IsBsonNull && !string.IsNullOrEmpty(itematributos_producto.ToBsonDocument().GetValue("_id").ToString()) ? (itematributos_producto.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itematributos_producto.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itematributos_producto.ToBsonDocument().GetValue("_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("nombre") && !itematributos_producto.ToBsonDocument().GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itematributos_producto.ToBsonDocument().GetValue("nombre").ToString()) ? (itematributos_producto.ToBsonDocument().GetValue("nombre").ToString().Length > 30 ? itematributos_producto.ToBsonDocument().GetValue("nombre").ToString().Substring(0, 29) : itematributos_producto.ToBsonDocument().GetValue("nombre").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("atributo_sap") && !itematributos_producto.ToBsonDocument().GetValue("atributo_sap").IsBsonNull && !string.IsNullOrEmpty(itematributos_producto.ToBsonDocument().GetValue("atributo_sap").ToString()) ? (itematributos_producto.ToBsonDocument().GetValue("atributo_sap").ToString().Length > 30 ? itematributos_producto.ToBsonDocument().GetValue("atributo_sap").ToString().Substring(0, 29) : itematributos_producto.ToBsonDocument().GetValue("atributo_sap").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("descripcion") && !itematributos_producto.ToBsonDocument().GetValue("descripcion").IsBsonNull && !string.IsNullOrEmpty(itematributos_producto.ToBsonDocument().GetValue("descripcion").ToString()) ? (itematributos_producto.ToBsonDocument().GetValue("descripcion").ToString().Length > 30 ? itematributos_producto.ToBsonDocument().GetValue("descripcion").ToString().Substring(0, 29) : itematributos_producto.ToBsonDocument().GetValue("descripcion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("tipo_dato") && !itematributos_producto.ToBsonDocument().GetValue("tipo_dato").IsBsonNull && !string.IsNullOrEmpty(itematributos_producto.ToBsonDocument().GetValue("tipo_dato").ToString()) ? (itematributos_producto.ToBsonDocument().GetValue("tipo_dato").ToString().Length > 30 ? itematributos_producto.ToBsonDocument().GetValue("tipo_dato").ToString().Substring(0, 29) : itematributos_producto.ToBsonDocument().GetValue("tipo_dato").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("valor") && !itematributos_producto.ToBsonDocument().GetValue("valor").IsBsonNull && !string.IsNullOrEmpty(itematributos_producto.ToBsonDocument().GetValue("valor").ToString()) ? (itematributos_producto.ToBsonDocument().GetValue("valor").ToString().Length > 30 ? itematributos_producto.ToBsonDocument().GetValue("valor").ToString().Substring(0, 29) : itematributos_producto.ToBsonDocument().GetValue("valor").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                "~|" + (itematributos_producto.ToBsonDocument().Contains("es_activo") && !itematributos_producto.ToBsonDocument().GetValue("es_activo").IsBsonNull ? itematributos_producto.ToBsonDocument().GetValue("es_activo").ToString().Length > 8 ? itematributos_producto.ToBsonDocument().GetValue("es_activo").ToString().Substring(0, 8) : itematributos_producto.ToBsonDocument().GetValue("es_activo").ToString() : "");
                                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_PRODUCTO_atributos_producto Id: " + id_mongo + "," + itematributos_producto.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                                continue;
                                            }
                                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                            try
                                            {
                                                if (sTextoDescarga != "")
                                                {
                                                    Archivo_PS_PRODUCTO_atributos.WriteLine(sTextoDescarga);
                                                    if (pruebas == false)
                                                    {
                                                        if (tipo == "")
                                                        {
                                                            Col_PS_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                   Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PRODUCTO.GetValue("_id").ToString())),
                                                                   Builders<BsonDocument>.Filter.Eq("atributos_producto._id", MongoDB.Bson.ObjectId.Parse(itematributos_producto.ToBsonDocument().GetValue("_id").ToString()))),
                                                                   Builders<BsonDocument>.Update.Set("atributos_producto.Actualizacion_Extractor", "0")
                                                                                                .Set("atributos_producto.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                            Conteo_PS_PRODUCTO++;
                                                        }
                                                        else if (tipo != "")
                                                        {
                                                            if ((itematributos_producto.ToBsonDocument().GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                            {
                                                                Col_PS_PRODUCTO.UpdateOne(Builders<BsonDocument>.Filter.And(
                                                                  Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_PRODUCTO.GetValue("_id").ToString())),
                                                                  Builders<BsonDocument>.Filter.Eq("atributos_producto._id", MongoDB.Bson.ObjectId.Parse(itematributos_producto.ToBsonDocument().GetValue("_id").ToString()))),
                                                                  Builders<BsonDocument>.Update.Set("atributos_producto.Actualizacion_Extractor", "0")
                                                                                               .Set("atributos_producto.Fecha_extraccion", fechatemp.ToLocalTime()));
                                                                Conteo_PS_PRODUCTO++;
                                                            }

                                                        }

                                                    }
                                                }
                                                Console.WriteLine("PS_PRODUCTO_atributos_producto ACTUALIZADA: " + itemPS_PRODUCTO.GetValue("_id").ToString() + "Numero de PS_PRODUCTO_atributos_producto actializadas: " + Conteo_PS_PRODUCTO);
                                            }
                                            catch (Exception ex)
                                            {
                                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                                prcManejoErrores objError = new prcManejoErrores();
                                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_PRODUCTO_atributos_producto en mongo Id: " + id_mongo);
                                                continue;
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_PRODUCTO_atributos_producto para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_PRODUCTO > 0)
                        {
                            Archivo_PS_PRODUCTO_atributos.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_PRODUCTO_atributos_producto_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_PRODUCTO_atributos_producto entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_PRODUCTO_atributos.Close();
            }

        }

        internal static void Extractor_PS_REGLA_ASIGANCION(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_REGLA_ASIGANCION");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_REGLA_ASIGANCION = null;

            int Conteo_PS_REGLA_ASIGANCION = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;
            int validacion_parametros = 0;

            string archivo = path + "PS_REGLA_ASIGANCION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_REGLA_ASIGANCION = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_REGLA_ASIGANCION");
                FilterDefinitionBuilder<BsonDocument> builderPS_REGLA_ASIGANCION = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_REGLA_ASIGANCION = builderPS_REGLA_ASIGANCION.Empty;

                if (tipo == "")
                {
                    filterPS_REGLA_ASIGANCION = builderPS_REGLA_ASIGANCION.Or(builderPS_REGLA_ASIGANCION.Eq("Actualizacion_Extractor", "1"), !builderPS_REGLA_ASIGANCION.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_REGLA_ASIGANCION = builderPS_REGLA_ASIGANCION.And(builderPS_REGLA_ASIGANCION.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_REGLA_ASIGANCION.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_REGLA_ASIGANCION = Col_PS.Find(filterPS_REGLA_ASIGANCION).ToList();

                if (consulta_PS_REGLA_ASIGANCION != null && consulta_PS_REGLA_ASIGANCION.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_REGLA_ASIGANCION encontrados " + consulta_PS_REGLA_ASIGANCION.Count.ToString());
                        foreach (BsonDocument itemPS_REGLA_ASIGANCION in consulta_PS_REGLA_ASIGANCION)
                        {
                            id_mongo = itemPS_REGLA_ASIGANCION.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_REGLA_ASIGANCION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_REGLA_ASIGANCION.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_REGLA_ASIGANCION.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_REGLA_ASIGANCION.Contains("_id") ? !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("_id")?.ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("_id").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION.GetValue("_id").ToString().Substring(0, 29) : itemPS_REGLA_ASIGANCION.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("fecha_creacion") && !itemPS_REGLA_ASIGANCION.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("fecha_creacion").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_REGLA_ASIGANCION.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("usuario_creacion") && !itemPS_REGLA_ASIGANCION.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("usuario_creacion").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_REGLA_ASIGANCION.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_REGLA_ASIGANCION.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("fecha_actualizacion") && !itemPS_REGLA_ASIGANCION.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("fecha_actualizacion").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_REGLA_ASIGANCION.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("usuario_modificacion") && !itemPS_REGLA_ASIGANCION.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("usuario_modificacion").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_REGLA_ASIGANCION.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_REGLA_ASIGANCION.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("nombre_regla") && !itemPS_REGLA_ASIGANCION.GetValue("nombre_regla").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("nombre_regla").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("nombre_regla").ToString().Length > 50 ? itemPS_REGLA_ASIGANCION.GetValue("nombre_regla").ToString().Substring(0, 50) : itemPS_REGLA_ASIGANCION.GetValue("nombre_regla").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("descripcion") && !itemPS_REGLA_ASIGANCION.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("descripcion").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_REGLA_ASIGANCION.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_REGLA_ASIGANCION.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("id_grupo_asignado") ? !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("id_grupo_asignado")?.ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("id_grupo_asignado").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION.GetValue("id_grupo_asignado").ToString().Substring(0, 29) : itemPS_REGLA_ASIGANCION.GetValue("id_grupo_asignado").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("grupo_asignado") && !itemPS_REGLA_ASIGANCION.GetValue("grupo_asignado").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.GetValue("grupo_asignado").ToString()) ? (itemPS_REGLA_ASIGANCION.GetValue("grupo_asignado").ToString().Length > 50 ? itemPS_REGLA_ASIGANCION.GetValue("grupo_asignado").ToString().Substring(0, 50) : itemPS_REGLA_ASIGANCION.GetValue("grupo_asignado").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_REGLA_ASIGANCION.Contains("es_activo") && !itemPS_REGLA_ASIGANCION.GetValue("es_activo").IsBsonNull ? itemPS_REGLA_ASIGANCION.GetValue("es_activo").ToString().Length > 8 ? itemPS_REGLA_ASIGANCION.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_REGLA_ASIGANCION.GetValue("es_activo").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        if (itemPS_REGLA_ASIGANCION.Contains("validaciones_parametros") && !itemPS_REGLA_ASIGANCION.GetValue("validaciones_parametros").IsBsonNull && itemPS_REGLA_ASIGANCION.GetElement("validaciones_parametros").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            validacion_parametros += Extractor_PS_REGLA_ASIGANCION_validaciones_parametros(id_mongo);
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_REGLA_ASIGANCION Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_REGLA_ASIGANCION.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_REGLA_ASIGANCION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_REGLA_ASIGANCION++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_REGLA_ASIGANCION.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_REGLA_ASIGANCION.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_REGLA_ASIGANCION++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_REGLA_ASIGANCION ACTUALIZADA: " + itemPS_REGLA_ASIGANCION.GetValue("_id").ToString() + "Numero de PS_REGLA_ASIGANCION actializadas: " + Conteo_PS_REGLA_ASIGANCION);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_REGLA_ASIGANCION en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_REGLA_ASIGANCION para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_REGLA_ASIGANCION > 0)
                        {
                            Archivo_PS_REGLA_ASIGANCION.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_REGLA_ASIGANCION_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                if (validacion_parametros > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_REGLA_ASIGANCION_validaciones_parametros_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_REGLA_ASIGANCION entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_REGLA_ASIGANCION.Close();
            }

        }

        internal static int Extractor_PS_REGLA_ASIGANCION_validaciones_parametros(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_REGLA_ASIGANCION_validaciones_parametros");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_REGLA_ASIGANCION_validaciones_parametros = null;

            int Conteo_PS_REGLA_ASIGANCION_validaciones_parametros = 0;
            string sTextoDescarga_validacion_parametros = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_REGLA_ASIGANCION_validaciones_parametros_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_REGLA_ASIGANCION_validaciones_parametros = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_REGLA_ASIGANCION_validaciones_parametros = db.GetCollection<BsonDocument>("PS_REGLA_ASIGANCION");
                FilterDefinitionBuilder<BsonDocument> builderPS_REGLA_ASIGANCION_validaciones_parametros = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_REGLA_ASIGANCION_validaciones_parametros = builderPS_REGLA_ASIGANCION_validaciones_parametros.Empty;
                filterPS_REGLA_ASIGANCION_validaciones_parametros = builderPS_REGLA_ASIGANCION_validaciones_parametros.And(
                builderPS_REGLA_ASIGANCION_validaciones_parametros.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_REGLA_ASIGANCION_validaciones_parametros.SizeGte("validaciones_parametros", 1));


                List<BsonDocument> consulta_PS_REGLA_ASIGANCION_VP = Col_PS_REGLA_ASIGANCION_validaciones_parametros.Find(filterPS_REGLA_ASIGANCION_validaciones_parametros).ToList();

                if (consulta_PS_REGLA_ASIGANCION_VP != null && consulta_PS_REGLA_ASIGANCION_VP.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_REGLA_ASIGANCION_validaciones_parametros encontrados " + consulta_PS_REGLA_ASIGANCION_VP.Count.ToString());
                        foreach (BsonDocument itemPS_REGLA_ASIGANCION in consulta_PS_REGLA_ASIGANCION_VP)
                        {
                            id_mongo = itemPS_REGLA_ASIGANCION.GetValue("_id").ToString();

                            sTextoDescarga_validacion_parametros = "";
                            List<BsonValue> consulta_PS_REGLA_ASIGANCION_validaciones_parametros = itemPS_REGLA_ASIGANCION.GetElement("validaciones_parametros").Value.AsBsonArray.AsQueryable().ToList();

                            if (consulta_PS_REGLA_ASIGANCION_validaciones_parametros != null && consulta_PS_REGLA_ASIGANCION_validaciones_parametros.Count() > 0)
                            {
                                foreach (BsonValue itemPS_REGLA_ASIGANCION_validaciones_parametros in consulta_PS_REGLA_ASIGANCION_validaciones_parametros)
                                {
                                    try
                                    {
                                        try
                                        {
                                            List<BsonValue> consulta_PS_REGLA_ASIGANCION_parametros_validaciones = itemPS_REGLA_ASIGANCION.GetElement("valor_validacion").Value.AsBsonArray.AsQueryable().ToList();
                                            if (consulta_PS_REGLA_ASIGANCION_parametros_validaciones != null && consulta_PS_REGLA_ASIGANCION_parametros_validaciones.Count() > 0)
                                            {
                                                foreach (var item in consulta_PS_REGLA_ASIGANCION_parametros_validaciones)
                                                {
                                                    sTextoDescarga_validacion_parametros =
                                                    (itemPS_REGLA_ASIGANCION.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_REGLA_ASIGANCION.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_REGLA_ASIGANCION.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                     "~|" + (itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().Contains("campo_validacion") && !itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("campo_validacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("campo_validacion").ToString()) ? (itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("campo_validacion").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("campo_validacion").ToString().Substring(0, 29) : itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("campo_validacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                     "~|" + (itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().Contains("parametro_validacion") && !itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("parametro_validacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("parametro_validacion").ToString()) ? (itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("parametro_validacion").ToString().Length > 30 ? itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("parametro_validacion").ToString().Substring(0, 29) : itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().GetValue("parametro_validacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                                     "~|" + (item.ToString());// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                                    sTextoDescarga_validacion_parametros = sTextoDescarga_validacion_parametros.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                                }
                                            }
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_REGLA_ASIGANCION_validaciones_parametros Id: " + id_mongo + "," + itemPS_REGLA_ASIGANCION_validaciones_parametros.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga_validacion_parametros != "")
                                            {
                                                Archivo_PS_REGLA_ASIGANCION_validaciones_parametros.WriteLine(sTextoDescarga_validacion_parametros);
                                                Console.WriteLine(sTextoDescarga_validacion_parametros);
                                                Conteo_PS_REGLA_ASIGANCION_validaciones_parametros++;
                                            }
                                            //Console.WriteLine("PS_REGLA_ASIGANCION_validaciones_parametros ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_REGLA_ASIGANCION_validaciones_parametros actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_REGLA_ASIGANCION_validaciones_parametros en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_REGLA_ASIGANCION_validaciones_parametros para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_REGLA_ASIGANCION_validaciones_parametros ACTUALIZADA: " + itemPS_REGLA_ASIGANCION.GetValue("_id").ToString() + "Numero de PS_REGLA_ASIGANCION_validaciones_parametros actializadas: " + Conteo_PS_REGLA_ASIGANCION_validaciones_parametros);
                            }

                        }

                        if (Conteo_PS_REGLA_ASIGANCION_validaciones_parametros > 0)
                        {
                            Archivo_PS_REGLA_ASIGANCION_validaciones_parametros.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_REGLA_ASIGANCION_validaciones_parametros entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_REGLA_ASIGANCION_validaciones_parametros;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_REGLA_ASIGANCION_validaciones_parametros.Close();

            }
            return Conteo_PS_REGLA_ASIGANCION_validaciones_parametros;
        } //Se ejecuta con Extractor_PS_REGLA_ASIGANCION()

        internal static void Extractor_PS_ROL(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_ROL");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_ROL = null;

            int Conteo_PS_ROL = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;
            int permisos = 0;

            string archivo = path + "PS_ROL_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_ROL = new StreamWriter(archivo, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS = db.GetCollection<BsonDocument>("PS_ROL");
                FilterDefinitionBuilder<BsonDocument> builderPS_ROL = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_ROL = builderPS_ROL.Empty;

                if (tipo == "")
                {
                    filterPS_ROL = builderPS_ROL.Or(builderPS_ROL.Eq("Actualizacion_Extractor", "1"), !builderPS_ROL.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_ROL = builderPS_ROL.And(builderPS_ROL.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_ROL.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_ROL = Col_PS.Find(filterPS_ROL).ToList();

                if (consulta_PS_ROL != null && consulta_PS_ROL.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_ROL encontrados " + consulta_PS_ROL.Count.ToString());
                        foreach (BsonDocument itemPS_ROL in consulta_PS_ROL)
                        {
                            id_mongo = itemPS_ROL.GetValue("_id").ToString();

                            sTextoDescarga = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_ROL.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_ROL.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_ROL.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga =
                                        (itemPS_ROL.Contains("_id") ? !string.IsNullOrEmpty(itemPS_ROL.GetValue("_id")?.ToString()) ? (itemPS_ROL.GetValue("_id").ToString().Length > 30 ? itemPS_ROL.GetValue("_id").ToString().Substring(0, 29) : itemPS_ROL.GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("fecha_creacion") && !itemPS_ROL.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL.GetValue("fecha_creacion").ToString()) ? (itemPS_ROL.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_ROL.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_ROL.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("usuario_creacion") && !itemPS_ROL.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL.GetValue("usuario_creacion").ToString()) ? (itemPS_ROL.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_ROL.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_ROL.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("fecha_actualizacion") && !itemPS_ROL.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL.GetValue("fecha_actualizacion").ToString()) ? (itemPS_ROL.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_ROL.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_ROL.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("usuario_modificacion") && !itemPS_ROL.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL.GetValue("usuario_modificacion").ToString()) ? (itemPS_ROL.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_ROL.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_ROL.GetValue("usuario_modificacion").ToString()) : "") +// VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("nombre") && !itemPS_ROL.GetValue("nombre").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL.GetValue("nombre").ToString()) ? (itemPS_ROL.GetValue("nombre").ToString().Length > 50 ? itemPS_ROL.GetValue("nombre").ToString().Substring(0, 50) : itemPS_ROL.GetValue("nombre").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("descripcion") && !itemPS_ROL.GetValue("descripcion").IsBsonNull ? !string.IsNullOrEmpty(itemPS_ROL.GetValue("descripcion").ToString()) ? (itemPS_ROL.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Length > 500 ? itemPS_ROL.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ").Substring(0, 500) : itemPS_ROL.GetValue("descripcion").ToString().Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ")) : "" : "") + // VARCHAR(8000) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        "~|" + (itemPS_ROL.Contains("es_activo") && !itemPS_ROL.GetValue("es_activo").IsBsonNull ? itemPS_ROL.GetValue("es_activo").ToString().Length > 8 ? itemPS_ROL.GetValue("es_activo").ToString().Substring(0, 8) : itemPS_ROL.GetValue("es_activo").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        if (itemPS_ROL.Contains("permisos") && !itemPS_ROL.GetValue("permisos").IsBsonNull && itemPS_ROL.GetElement("permisos").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            permisos += Extractor_PS_ROL_permisos(id_mongo);
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_ROL Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        if (sTextoDescarga != "")
                                        {
                                            Archivo_PS_ROL.WriteLine(sTextoDescarga);
                                            if (pruebas == false)
                                            {
                                                if (tipo == "")
                                                {
                                                    Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_ROL.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                .Set("Fecha_extraccion", fechatemp.ToLocalTime()));
                                                    Conteo_PS_ROL++;
                                                }
                                                else if (tipo != "")
                                                {
                                                    if ((itemPS_ROL.GetValue("Actualizacion_Extractor") ?? "").ToString() != "0")
                                                    {
                                                        Col_PS.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", MongoDB.Bson.ObjectId.Parse(itemPS_ROL.GetValue("_id").ToString())), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                                                                                                    .Set("Fecha_extraccion", fechatemp.ToLocalTime()/*.ToString("dd/MM/yyyy")*/));
                                                        Conteo_PS_ROL++;
                                                    }

                                                }

                                            }
                                        }
                                        Console.WriteLine("PS_ROL ACTUALIZADA: " + itemPS_ROL.GetValue("_id").ToString() + "Numero de PS_ROL actializadas: " + Conteo_PS_ROL);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_ROL en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_ROL para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_ROL > 0)
                        {
                            Archivo_PS_ROL.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_ROL_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                if (permisos > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_ROL_permisos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_ROL entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_ROL.Close();
            }

        }

        internal static int Extractor_PS_ROL_permisos(string id_mongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_ROL_permisos");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_ROL_permisos = null;

            int Conteo_PS_ROL_permisos = 0;
            string sTextoDescarga_permisos = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();


            string archivo = path + "PS_ROL_permisos_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_ROL_permisos = new StreamWriter(archivo, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_ROL_permisos = db.GetCollection<BsonDocument>("PS_ROL");
                FilterDefinitionBuilder<BsonDocument> builderPS_ROL_permisos = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_ROL_permisos = builderPS_ROL_permisos.Empty;
                filterPS_ROL_permisos = builderPS_ROL_permisos.And(
                builderPS_ROL_permisos.Eq("_id", MongoDB.Bson.ObjectId.Parse(id_mongo)),
                builderPS_ROL_permisos.SizeGte("permisos", 1));


                List<BsonDocument> consulta_PS_ROL_Permisos = Col_PS_ROL_permisos.Find(filterPS_ROL_permisos).ToList();

                if (consulta_PS_ROL_Permisos != null && consulta_PS_ROL_Permisos.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_ROL_permisos encontrados " + consulta_PS_ROL_Permisos.Count.ToString());
                        foreach (BsonDocument itemPS_ROL in consulta_PS_ROL_Permisos)
                        {
                            id_mongo = itemPS_ROL.GetValue("_id").ToString();

                            sTextoDescarga_permisos = "";
                            List<BsonValue> consulta_PS_ROL_permisos = itemPS_ROL.GetElement("permisos").Value.AsBsonArray.AsQueryable().ToList();

                            if (consulta_PS_ROL_permisos != null && consulta_PS_ROL_permisos.Count() > 0)
                            {
                                foreach (BsonValue itemPS_ROL_permisos in consulta_PS_ROL_permisos)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga_permisos =
                                            (itemPS_ROL.ToBsonDocument().Contains("_id") ? !string.IsNullOrEmpty(itemPS_ROL.ToBsonDocument().GetValue("_id")?.ToString()) ? (itemPS_ROL.ToBsonDocument().GetValue("_id").ToString().Length > 30 ? itemPS_ROL.ToBsonDocument().GetValue("_id").ToString().Substring(0, 29) : itemPS_ROL.ToBsonDocument().GetValue("_id").ToString()) : "" : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                             "~|" + (itemPS_ROL_permisos.ToBsonDocument().Contains("funcionalidad") && !itemPS_ROL_permisos.ToBsonDocument().GetValue("funcionalidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL_permisos.ToBsonDocument().GetValue("funcionalidad").ToString()) ? (itemPS_ROL_permisos.ToBsonDocument().GetValue("funcionalidad").ToString().Length > 30 ? itemPS_ROL_permisos.ToBsonDocument().GetValue("funcionalidad").ToString().Substring(0, 29) : itemPS_ROL_permisos.ToBsonDocument().GetValue("funcionalidad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                             "~|" + (itemPS_ROL_permisos.ToBsonDocument().Contains("accion") && !itemPS_ROL_permisos.ToBsonDocument().GetValue("accion").IsBsonNull && !string.IsNullOrEmpty(itemPS_ROL_permisos.ToBsonDocument().GetValue("accion").ToString()) ? (itemPS_ROL_permisos.ToBsonDocument().GetValue("accion").ToString().Length > 30 ? itemPS_ROL_permisos.ToBsonDocument().GetValue("accion").ToString().Substring(0, 29) : itemPS_ROL_permisos.ToBsonDocument().GetValue("accion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                             "~|" + (itemPS_ROL.Contains("permitido") && !itemPS_ROL.GetValue("permitido").IsBsonNull ? itemPS_ROL.GetValue("permitido").ToString().Length > 8 ? itemPS_ROL.GetValue("permitido").ToString().Substring(0, 8) : itemPS_ROL.GetValue("permitido").ToString() : "") + //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                             "~|" + (itemPS_ROL.Contains("todos_elementos") && !itemPS_ROL.GetValue("todos_elementos").IsBsonNull ? itemPS_ROL.GetValue("todos_elementos").ToString().Length > 8 ? itemPS_ROL.GetValue("todos_elementos").ToString().Substring(0, 8) : itemPS_ROL.GetValue("todos_elementos").ToString() : ""); //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,
                                            sTextoDescarga_permisos = sTextoDescarga_permisos.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_ROL_permisos Id: " + id_mongo + "," + itemPS_ROL_permisos.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga_permisos != "")
                                            {
                                                Archivo_PS_ROL_permisos.WriteLine(sTextoDescarga_permisos);
                                                Console.WriteLine(sTextoDescarga_permisos);
                                                Conteo_PS_ROL_permisos++;
                                            }
                                            //Console.WriteLine("PS_ROL_permisos ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_ROL_permisos actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_ROL_permisos en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_ROL_permisos para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_ROL_permisos ACTUALIZADA: " + itemPS_ROL.GetValue("_id").ToString() + "Numero de PS_ROL_permisos actializadas: " + Conteo_PS_ROL_permisos);
                            }

                        }

                        if (Conteo_PS_ROL_permisos > 0)
                        {
                            Archivo_PS_ROL_permisos.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_ROL_permisos entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_ROL_permisos;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_ROL_permisos.Close();

            }
            return Conteo_PS_ROL_permisos;
        } //Se ejecuta con Extractor_PS_REGLA_ASIGANCION()

        internal static void Extractor_PS_SERVICIO_CLIENTE(string tipo = "")
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_SERVICIO_CLIENTE = null;

            int Conteo_PS_SERVICIO_CLIENTE = 0;
            int PS_SERVICIO_CLIENTE_CV = 0;
            string sTextoDescarga_SC = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            bool pruebas = true;
            int datos_adicionales = 0;
            int datos_adicionales_CV = 0;
            int Conteo_datos_adicionales_CV = 0;
            int Conteo_Configuracion_Servicio = 0;
            int Conteo_Configuracion_Servicio_CV = 0;
            int Configuracion_Servicio_CV = 0;
            int Conteo_Valores_Elementos = 0;
            int Conteo_Valores_Elementos_CV = 0;
            int Valores_Elementos_CV = 0;
            int Valores_Elementos = 0;
            string archivo_SC = path + "PS_01_00_SER_CLIENTE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_SERVICIO_CLIENTE = db.GetCollection<BsonDocument>("PS_SERVICIO_CLIENTE");
                FilterDefinitionBuilder<BsonDocument> builderPS_SERVICIO_CLIENTE = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_SERVICIO_CLIENTE = builderPS_SERVICIO_CLIENTE.Empty;

                if (tipo == "")
                {
                    filterPS_SERVICIO_CLIENTE = builderPS_SERVICIO_CLIENTE.Or(builderPS_SERVICIO_CLIENTE.Eq("Actualizacion_Extractor", "1"), !builderPS_SERVICIO_CLIENTE.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_SERVICIO_CLIENTE = builderPS_SERVICIO_CLIENTE.And(builderPS_SERVICIO_CLIENTE.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_SERVICIO_CLIENTE.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_SERVICIO_CLIENTE = Col_PS_SERVICIO_CLIENTE.Find(filterPS_SERVICIO_CLIENTE).ToList();

                if (consulta_PS_SERVICIO_CLIENTE != null && consulta_PS_SERVICIO_CLIENTE.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE encontrados " + consulta_PS_SERVICIO_CLIENTE.Count.ToString());
                        foreach (BsonDocument itemPS_SERVICIO_CLIENTE in consulta_PS_SERVICIO_CLIENTE)
                        {
                            id_mongo = itemPS_SERVICIO_CLIENTE.GetValue("_id").ToString();

                            sTextoDescarga_SC = "";

                            try
                            {
                                if (!string.IsNullOrEmpty(id_mongo)
                                    && (!itemPS_SERVICIO_CLIENTE.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || itemPS_SERVICIO_CLIENTE.ToBsonDocument().Contains("Actualizacion_Extractor")
                                    || (itemPS_SERVICIO_CLIENTE.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull))
                                    )
                                {
                                    try
                                    {
                                        sTextoDescarga_SC = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "_id", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "fecha_creacion", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "usuario_creacion", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "fecha_actualizacion", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "usuario_modificacion", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "estado", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "ancho_banda", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "cuenta_cliente", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "nit", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "id_servicio", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "nombre_producto", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "plan", 200));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "sucursal", 200));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "ciudad", 200));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "disponibilidad_servicio", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "servicio_etb", 50));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "cuenta_facturacion", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "aliado_colaborador", 200));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "proveedor_ultima_milla", 200));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "medio_ultima_milla", 200));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "external_service_id", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "numero_conexion", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "numero_aprovisionamiento", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "numero_viabilidad", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "opcion_respuesta_viabilidad", 100));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "fecha_inicio_facturacion", 30));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "version", 10));
                                        sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE, "id_Aprovisionamiento", 30));









                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("fecha_creacion") && !itemPS_SERVICIO_CLIENTE.GetValue("fecha_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("fecha_creacion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("fecha_creacion").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("fecha_creacion").ToString().Substring(0, 30) : itemPS_SERVICIO_CLIENTE.GetValue("fecha_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("usuario_creacion") && !itemPS_SERVICIO_CLIENTE.GetValue("usuario_creacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("usuario_creacion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("usuario_creacion").ToString().Length > 50 ? itemPS_SERVICIO_CLIENTE.GetValue("usuario_creacion").ToString().Substring(0, 50) : itemPS_SERVICIO_CLIENTE.GetValue("usuario_creacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("fecha_actualizacion") && !itemPS_SERVICIO_CLIENTE.GetValue("fecha_actualizacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("fecha_actualizacion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("fecha_actualizacion").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("fecha_actualizacion").ToString().Substring(0, 30) : itemPS_SERVICIO_CLIENTE.GetValue("fecha_actualizacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("usuario_modificacion") && !itemPS_SERVICIO_CLIENTE.GetValue("usuario_modificacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("usuario_modificacion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("usuario_modificacion").ToString().Length > 50 ? itemPS_SERVICIO_CLIENTE.GetValue("usuario_modificacion").ToString().Substring(0, 50) : itemPS_SERVICIO_CLIENTE.GetValue("usuario_modificacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("estado") && !itemPS_SERVICIO_CLIENTE.GetValue("estado").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("estado").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("estado").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("estado").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("estado").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("ancho_banda") && !itemPS_SERVICIO_CLIENTE.GetValue("ancho_banda").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("ancho_banda").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("ancho_banda").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("ancho_banda").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("ancho_banda").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("cuenta_cliente") && !itemPS_SERVICIO_CLIENTE.GetValue("cuenta_cliente").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("cuenta_cliente").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("cuenta_cliente").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("cuenta_cliente").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("cuenta_cliente").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("nit") && !itemPS_SERVICIO_CLIENTE.GetValue("nit").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("nit").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("nit").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("nit").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("nit").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("id_servicio") && !itemPS_SERVICIO_CLIENTE.GetValue("id_servicio").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("id_servicio").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("id_servicio").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("id_servicio").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("id_servicio").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("nombre_producto") && !itemPS_SERVICIO_CLIENTE.GetValue("nombre_producto").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("nombre_producto").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("nombre_producto").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("nombre_producto").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("nombre_producto").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("plan") && !itemPS_SERVICIO_CLIENTE.GetValue("plan").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("plan").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("plan").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("plan").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("plan").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("sucursal") && !itemPS_SERVICIO_CLIENTE.GetValue("sucursal").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("sucursal").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("sucursal").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("sucursal").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("sucursal").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("ciudad") && !itemPS_SERVICIO_CLIENTE.GetValue("ciudad").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("ciudad").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("ciudad").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("ciudad").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("ciudad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("disponibilidad_servicio") && !itemPS_SERVICIO_CLIENTE.GetValue("disponibilidad_servicio").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("disponibilidad_servicio").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("disponibilidad_servicio").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("disponibilidad_servicio").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("disponibilidad_servicio").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("servicio_etb") && !itemPS_SERVICIO_CLIENTE.GetValue("servicio_etb").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("servicio_etb").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("servicio_etb").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("servicio_etb").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("servicio_etb").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("cuenta_facturacion") && !itemPS_SERVICIO_CLIENTE.GetValue("cuenta_facturacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("cuenta_facturacion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("cuenta_facturacion").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("cuenta_facturacion").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("cuenta_facturacion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("aliado_colaborador") && !itemPS_SERVICIO_CLIENTE.GetValue("aliado_colaborador").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("aliado_colaborador").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("aliado_colaborador").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("aliado_colaborador").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("aliado_colaborador").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("proveedor_ultima_milla") && !itemPS_SERVICIO_CLIENTE.GetValue("proveedor_ultima_milla").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("proveedor_ultima_milla").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("proveedor_ultima_milla").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("proveedor_ultima_milla").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("proveedor_ultima_milla").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("medio_ultima_milla") && !itemPS_SERVICIO_CLIENTE.GetValue("medio_ultima_milla").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("medio_ultima_milla").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("medio_ultima_milla").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("medio_ultima_milla").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("medio_ultima_milla").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("external_service_id") && !itemPS_SERVICIO_CLIENTE.GetValue("external_service_id").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("external_service_id").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("external_service_id").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("external_service_id").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("external_service_id").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("numero_conexion") && !itemPS_SERVICIO_CLIENTE.GetValue("numero_conexion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("numero_conexion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("numero_conexion").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("numero_conexion").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("numero_conexion").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("numero_aprovisionamiento") && !itemPS_SERVICIO_CLIENTE.GetValue("numero_aprovisionamiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("numero_aprovisionamiento").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("numero_aprovisionamiento").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("numero_aprovisionamiento").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("numero_aprovisionamiento").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("numero_viabilidad") && !itemPS_SERVICIO_CLIENTE.GetValue("numero_viabilidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("numero_viabilidad").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("numero_viabilidad").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("numero_viabilidad").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("numero_viabilidad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("opcion_respuesta_viabilidad") && !itemPS_SERVICIO_CLIENTE.GetValue("opcion_respuesta_viabilidad").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("opcion_respuesta_viabilidad").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("opcion_respuesta_viabilidad").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("opcion_respuesta_viabilidad").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("opcion_respuesta_viabilidad").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("fecha_inicio_facturacion") && !itemPS_SERVICIO_CLIENTE.GetValue("fecha_inicio_facturacion").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("fecha_inicio_facturacion").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("fecha_inicio_facturacion").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("fecha_inicio_facturacion").ToString().Substring(0, 30) : itemPS_SERVICIO_CLIENTE.GetValue("fecha_inicio_facturacion").ToString()) : "") + // VARCHAR(50) CHARACTER SET LATIN NOT CASESPECIFIC,
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("version") && !itemPS_SERVICIO_CLIENTE.GetValue("version").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("version").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("version").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("version").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("version").ToString()) : "") +  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   
                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("id_Aprovisionamiento") && !itemPS_SERVICIO_CLIENTE.GetValue("id_Aprovisionamiento").IsBsonNull && !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("id_Aprovisionamiento").ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("id_Aprovisionamiento").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("id_Aprovisionamiento").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("id_Aprovisionamiento").ToString()) : "");  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,   


                                        //"~|" + (itemPS_SERVICIO_CLIENTE.Contains("historico_modificaciones") ? !string.IsNullOrEmpty(itemPS_SERVICIO_CLIENTE.GetValue("historico_modificaciones")?.ToString()) ? (itemPS_SERVICIO_CLIENTE.GetValue("historico_modificaciones").ToString().Length > 30 ? itemPS_SERVICIO_CLIENTE.GetValue("historico_modificaciones").ToString().Substring(0, 29) : itemPS_SERVICIO_CLIENTE.GetValue("historico_modificaciones").ToString()) : "" : "");  //VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC,                                        
                                        sTextoDescarga_SC = sTextoDescarga_SC.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        if (itemPS_SERVICIO_CLIENTE.Contains("datos_adicionales_servicio") && !itemPS_SERVICIO_CLIENTE.GetValue("datos_adicionales_servicio").IsBsonNull && itemPS_SERVICIO_CLIENTE.GetElement("datos_adicionales_servicio").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            datos_adicionales += Extractor_PS_SERVICIO_CLIENTE_datos_adicionales_servicio(id_mongo);
                                        }
                                        if (itemPS_SERVICIO_CLIENTE.Contains("configuracion_servicio") && !itemPS_SERVICIO_CLIENTE.GetValue("configuracion_servicio").IsBsonNull && itemPS_SERVICIO_CLIENTE.GetElement("configuracion_servicio").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            Conteo_Configuracion_Servicio += Extractor_PS_SERVICIO_CLIENTE_configuracion_servicio(id_mongo, out Valores_Elementos);
                                            Conteo_Valores_Elementos += Valores_Elementos;
                                        }
                                        if (itemPS_SERVICIO_CLIENTE.Contains("control_versiones") && !itemPS_SERVICIO_CLIENTE.GetValue("control_versiones").IsBsonNull && itemPS_SERVICIO_CLIENTE.GetElement("control_versiones").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                        {
                                            PS_SERVICIO_CLIENTE_CV += Extractor_PS_SERVICIO_CLIENTE_CV(id_mongo, out Configuracion_Servicio_CV, out Valores_Elementos_CV, out datos_adicionales_CV);
                                            Conteo_Configuracion_Servicio_CV += Configuracion_Servicio_CV;
                                            Conteo_Valores_Elementos_CV += Valores_Elementos_CV;
                                            Conteo_datos_adicionales_CV += datos_adicionales_CV;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE Id: " + id_mongo);
                                        continue;
                                    }
                                    // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                    try
                                    {
                                        Conteo_PS_SERVICIO_CLIENTE++;
                                        Archivo_PS_SERVICIO_CLIENTE.WriteLine(sTextoDescarga_SC);
                                        Console.WriteLine("PS_SERVICIO_CLIENTE ACTUALIZADA: " + itemPS_SERVICIO_CLIENTE.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE actializadas: " + Conteo_PS_SERVICIO_CLIENTE);
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE en mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_SERVICIO_CLIENTE para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_SERVICIO_CLIENTE > 0)
                        {
                            Archivo_PS_SERVICIO_CLIENTE.Close();
                            if (pruebas == false)
                            {
                                //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                if (Conteo_Configuracion_Servicio > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_configuracion_servicio_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (Conteo_Valores_Elementos > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_valores_elementos_configuracion_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (datos_adicionales > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_datos_adicionales_servicio_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (PS_SERVICIO_CLIENTE_CV > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_CV_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (Conteo_Configuracion_Servicio_CV > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_CV_CS_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");

                                }
                                if (Conteo_Valores_Elementos_CV > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                                }
                                if (Conteo_datos_adicionales_CV > 0)
                                {
                                    //PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");

                                }


                            }

                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_SERVICIO_CLIENTE entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE.Close();
            }

        }

        internal static int Extractor_PS_SERVICIO_CLIENTE_configuracion_servicio(string idmongo, out int valores_elementos)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_configuracion_servicio");
            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());
            StreamWriter Archivo_PS_SERVICIO_CLIENTE_configuracion_servicio = null;
            int Conteo_PS_SERVICIO_CLIENTE = 0;
            valores_elementos = 0;
            string sTextoDescarga = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_CS2 = path + "PS_01_02_CONFI_SERVC_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_configuracion_servicio = new StreamWriter(archivo_CS2, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_SERVICIO_CLIENTE_CS = db.GetCollection<BsonDocument>("PS_SERVICIO_CLIENTE");
                FilterDefinitionBuilder<BsonDocument> builderPS_SERVICIO_CLIENTE_CS = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_SERVICIO_CLIENTE_CS = builderPS_SERVICIO_CLIENTE_CS.Empty;
                filterPS_SERVICIO_CLIENTE_CS = builderPS_SERVICIO_CLIENTE_CS.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));
                List<BsonDocument> consulta_PS_SERVICIO_CLIENTE_CS = Col_PS_SERVICIO_CLIENTE_CS.Find(filterPS_SERVICIO_CLIENTE_CS).ToList();

                if (consulta_PS_SERVICIO_CLIENTE_CS != null && consulta_PS_SERVICIO_CLIENTE_CS.Count() > 0)
                {
                    try
                    {
                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PQR 
                        Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_configuracion_servicio encontrados " + consulta_PS_SERVICIO_CLIENTE_CS.Count.ToString());
                        foreach (BsonDocument itemPS_SERVICIO_CLIENTE_CS in consulta_PS_SERVICIO_CLIENTE_CS)
                        {
                            id_mongo = itemPS_SERVICIO_CLIENTE_CS.GetValue("_id").ToString();

                            sTextoDescarga = "";
                            List<BsonValue> consulta_PS_SERVICIO_CLIENTE_configuracion_servicio = itemPS_SERVICIO_CLIENTE_CS.GetElement("configuracion_servicio").Value.AsBsonArray.AsQueryable().ToList();
                            if (consulta_PS_SERVICIO_CLIENTE_configuracion_servicio != null && consulta_PS_SERVICIO_CLIENTE_configuracion_servicio.Count() > 0)
                            {
                                foreach (BsonValue itemconfiguracion_servicio in consulta_PS_SERVICIO_CLIENTE_configuracion_servicio)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga = string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_CS.ToBsonDocument(), "_id", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "_id", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "fecha_creacion", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "usuario_creacion", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "fecha_actualizacion", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "usuario_modificacion", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "id_agrupador", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "nombre_agrupador", 100));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "nombre_elemento", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "cantidad", 30));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "tipo_elemento", 100));
                                            sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(itemconfiguracion_servicio.ToBsonDocument(), "inventario_etb", 200));
                                            if (itemconfiguracion_servicio.ToBsonDocument().Contains("valores_elementos_configuracion") && !itemconfiguracion_servicio.ToBsonDocument().GetValue("valores_elementos_configuracion").IsBsonNull && itemconfiguracion_servicio.ToBsonDocument().GetElement("valores_elementos_configuracion").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                            {
                                                List<BsonValue> consulta_valores_elementos_configuracion = itemconfiguracion_servicio.ToBsonDocument().GetElement("valores_elementos_configuracion").Value.AsBsonArray.AsQueryable().ToList();
                                                valores_elementos += Extractor_PS_SERVICIO_CLIENTE_valores_elementos_configuracion(id_mongo, itemconfiguracion_servicio.ToBsonDocument().GetValue("_id").ToString(), consulta_valores_elementos_configuracion);
                                            }

                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_configuracion_servicio Id: " + id_mongo + "," + itemconfiguracion_servicio.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga != "")
                                            {
                                                Archivo_PS_SERVICIO_CLIENTE_configuracion_servicio.WriteLine(sTextoDescarga);
                                                Conteo_PS_SERVICIO_CLIENTE++;
                                            }
                                            Console.WriteLine("PS_SERVICIO_CLIENTE_configuracion_servicio ACTUALIZADA: " + itemPS_SERVICIO_CLIENTE_CS.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_configuracion_servicio actializadas: " + Conteo_PS_SERVICIO_CLIENTE);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_configuracion_servicio en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_SERVICIO_CLIENTE_configuracion_servicio para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                            }

                        }

                        if (Conteo_PS_SERVICIO_CLIENTE > 0)
                        {
                            Archivo_PS_SERVICIO_CLIENTE_configuracion_servicio.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_SERVICIO_CLIENTE_configuracion_servicio entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_configuracion_servicio.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE;
        } //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE()

        internal static int Extractor_PS_SERVICIO_CLIENTE_valores_elementos_configuracion(string idmongo, string id_mongo_registro, List<BsonValue> lista_val_elementos)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_valores_elementos_configuracion");

            }
            StreamWriter Archivo_PS_SERVICIO_CLIENTE_valores_elementos_configuracion = null;
            int Conteo_PS_SERVICIO_CLIENTE = 0;
            string sTextoDescarga_SC = string.Empty;
            string id_mongo = idmongo;
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_VC = path + "PS_01_03_VAL_ELEMENT_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_valores_elementos_configuracion = new StreamWriter(archivo_VC, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                if (lista_val_elementos.Count() > 0)
                {
                    // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PS_SERVICIO_CLIENTE_valores_elementos_configuracion 
                    Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_valores_elementos_configuracion encontrados " + lista_val_elementos.Count.ToString());
                    foreach (BsonValue item_elementos_configuracion in lista_val_elementos)
                    {
                        try
                        {
                            sTextoDescarga_SC = string.Empty;
                            sTextoDescarga_SC = string.Format("{0}", id_mongo);
                            sTextoDescarga_SC += string.Format("~|{0}", id_mongo_registro);
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "_id", 30));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "fecha_creacion", 30));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "usuario_creacion", 30));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "fecha_actualizacion", 30));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "usuario_modificacion", 30));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "marca", 100));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "referencia", 30));
                            sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "valor_asignacion", 30));
                            sTextoDescarga_SC = sTextoDescarga_SC.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_valores_elementos_configuracion Id: " + id_mongo + "," + item_elementos_configuracion.ToBsonDocument().GetValue("_id").ToString());
                            continue;
                        }
                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                        try
                        {
                            if (sTextoDescarga_SC != "")
                            {
                                Archivo_PS_SERVICIO_CLIENTE_valores_elementos_configuracion.WriteLine(sTextoDescarga_SC);
                                Conteo_PS_SERVICIO_CLIENTE++;
                            }
                            Console.WriteLine("PS_SERVICIO_CLIENTE_valores_elementos_configuracion ACTUALIZADA: " + ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "_id", 30) + "Numero de PS_SERVICIO_CLIENTE_valores_elementos_configuracion actializadas: " + Conteo_PS_SERVICIO_CLIENTE);
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_valores_elementos_configuracion en mongo Id: " + id_mongo);
                            continue;
                        }
                    }
                }
                if (Conteo_PS_SERVICIO_CLIENTE > 0)
                {
                    Archivo_PS_SERVICIO_CLIENTE_valores_elementos_configuracion.Close();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_valores_elementos_configuracion.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE;
        }  //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE_configuracion_servicio()

        internal static int Extractor_PS_SERVICIO_CLIENTE_datos_adicionales_servicio(string idmongo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_datos_adicionales_servicio");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());
            StreamWriter Archivo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio = null;
            int Conteo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio = 0;
            string sTextoDescarga_datos_adicionales_servicio = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_datos_adicionales_servicio = path + "PS_01_01_DATOS_SERVC_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio = new StreamWriter(archivo_datos_adicionales_servicio, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_SERVICIO_CLIENTE_datos_adicionales_servicio = db.GetCollection<BsonDocument>("PS_SERVICIO_CLIENTE");
                FilterDefinitionBuilder<BsonDocument> builderPS_SERVICIO_CLIENTE_datos_adicionales_servicio = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_SERVICIO_CLIENTE_datos_adicionales_servicio = builderPS_SERVICIO_CLIENTE_datos_adicionales_servicio.Empty;
                filterPS_SERVICIO_CLIENTE_datos_adicionales_servicio = builderPS_SERVICIO_CLIENTE_datos_adicionales_servicio.And(
                builderPS_SERVICIO_CLIENTE_datos_adicionales_servicio.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo)),
                builderPS_SERVICIO_CLIENTE_datos_adicionales_servicio.SizeGte("datos_adicionales_servicio", 1));


                List<BsonDocument> consulta_PS_SERVICIO_CLIENTE_datos = Col_PS_SERVICIO_CLIENTE_datos_adicionales_servicio.Find(filterPS_SERVICIO_CLIENTE_datos_adicionales_servicio).ToList();

                if (consulta_PS_SERVICIO_CLIENTE_datos != null && consulta_PS_SERVICIO_CLIENTE_datos.Count() > 0)
                {
                    try
                    {
                        foreach (BsonDocument itemPS_SERVICIO_CLIENTE in consulta_PS_SERVICIO_CLIENTE_datos)
                        {
                            id_mongo = itemPS_SERVICIO_CLIENTE.GetValue("_id").ToString();

                            sTextoDescarga_datos_adicionales_servicio = "";
                            List<BsonValue> consulta_PS_SERVICIO_CLIENTE_datos_adicionales_servicio = itemPS_SERVICIO_CLIENTE.GetElement("datos_adicionales_servicio").Value.AsBsonArray.AsQueryable().ToList();

                            if (consulta_PS_SERVICIO_CLIENTE_datos_adicionales_servicio != null && consulta_PS_SERVICIO_CLIENTE_datos_adicionales_servicio.Count() > 0)
                            {
                                // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PS_SERVICIO_CLIENTE_datos_adicionales_servicio 
                                Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_datos_adicionales_servicio encontrados " + consulta_PS_SERVICIO_CLIENTE_datos_adicionales_servicio.Count.ToString());
                                foreach (BsonValue itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio in consulta_PS_SERVICIO_CLIENTE_datos_adicionales_servicio)
                                {
                                    try
                                    {
                                        try
                                        {
                                            sTextoDescarga_datos_adicionales_servicio = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE.ToBsonDocument(), "_id", 30));
                                            sTextoDescarga_datos_adicionales_servicio += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "identificador", 30));
                                            sTextoDescarga_datos_adicionales_servicio += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "valor", 30));
                                            sTextoDescarga_datos_adicionales_servicio = sTextoDescarga_datos_adicionales_servicio.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_datos_adicionales_servicio Id: " + id_mongo + "," + itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument().ToString());
                                            continue;
                                        }
                                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                        try
                                        {
                                            if (sTextoDescarga_datos_adicionales_servicio != "")
                                            {
                                                Archivo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio.WriteLine(sTextoDescarga_datos_adicionales_servicio);
                                                Console.WriteLine(sTextoDescarga_datos_adicionales_servicio);
                                                Conteo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio++;
                                            }
                                            //Console.WriteLine("PS_SERVICIO_CLIENTE_datos_adicionales_servicio ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_datos_adicionales_servicio actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                                        }
                                        catch (Exception ex)
                                        {
                                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                            prcManejoErrores objError = new prcManejoErrores();
                                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_datos_adicionales_servicio en mongo Id: " + id_mongo);
                                            continue;
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                        prcManejoErrores objError = new prcManejoErrores();
                                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_SERVICIO_CLIENTE_datos_adicionales_servicio para el procesamiento de registros de mongo Id: " + id_mongo);
                                        continue;
                                    }
                                }
                                Console.WriteLine("PS_SERVICIO_CLIENTE_datos_adicionales_servicio ACTUALIZADA: " + itemPS_SERVICIO_CLIENTE.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_datos_adicionales_servicio actializadas: " + Conteo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio);
                            }

                        }

                        if (Conteo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio > 0)
                        {
                            Archivo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_SERVICIO_CLIENTE_datos_adicionales_servicio entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
                return Conteo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE_datos_adicionales_servicio;
        } //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE()

        internal static int Extractor_PS_SERVICIO_CLIENTE_CV(string idmongo, out int configuracion_servicio_CV, out int valores_elementos_CV, out int datos_adicionales_CV)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_CV");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_SERVICIO_CLIENTE_CV = null;

            int Conteo_PS_SERVICIO_CLIENTE_CV = 0;
            string sTextoDescarga_cv = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            datos_adicionales_CV = 0;
            valores_elementos_CV = 0;
            configuracion_servicio_CV = 0;
            string id_control_versiones = string.Empty;

            string archivo_CV = path + "PS_01_04_00_CV_SERVC_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_CV = new StreamWriter(archivo_CV, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_SERVICIO_CLIENTE_CV = db.GetCollection<BsonDocument>("PS_SERVICIO_CLIENTE");
                FilterDefinitionBuilder<BsonDocument> builderPS_SERVICIO_CLIENTE_CV = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_SERVICIO_CLIENTE_CV = builderPS_SERVICIO_CLIENTE_CV.Empty;
                filterPS_SERVICIO_CLIENTE_CV = builderPS_SERVICIO_CLIENTE_CV.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

                List<BsonDocument> consulta_PS_SERVICIO_CLIENTE_CV = Col_PS_SERVICIO_CLIENTE_CV.Find(filterPS_SERVICIO_CLIENTE_CV).ToList();

                if (consulta_PS_SERVICIO_CLIENTE_CV != null && consulta_PS_SERVICIO_CLIENTE_CV.Count() > 0)
                {
                    try
                    {
                        foreach (BsonDocument itemPS_SERVICIO_CLIENTE_CV in consulta_PS_SERVICIO_CLIENTE_CV)
                        {
                            id_mongo = itemPS_SERVICIO_CLIENTE_CV.GetValue("_id").ToString();
                            sTextoDescarga_cv = "";
                            try
                            {
                                try
                                {
                                    List<BsonValue> consulta_PS_SERVICIO_CLIENTE_CVI = itemPS_SERVICIO_CLIENTE_CV.GetElement("control_versiones").Value.AsBsonArray.AsQueryable().ToList();
                                    if (consulta_PS_SERVICIO_CLIENTE_CVI != null && consulta_PS_SERVICIO_CLIENTE_CVI.Count() > 0)
                                    {
                                        // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PS_SERVICIO_CLIENTE_CV
                                        Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_CV encontrados " + consulta_PS_SERVICIO_CLIENTE_CV.Count.ToString());
                                        foreach (var item_CVI in consulta_PS_SERVICIO_CLIENTE_CVI)
                                        {
                                            sTextoDescarga_cv = string.Format("{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_CV, "_id", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "_id", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "fecha_creacion", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "usuario_creacion", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "fecha_actualizacion", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "usuario_modificacion", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "estado", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "ancho_banda", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "cuenta_cliente", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "nit", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "id_servicio", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "nombre_producto", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "plan", 200));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "sucursal", 200));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "ciudad", 200));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "disponibilidad_servicio", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "servicio_etb", 50));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "cuenta_facturacion", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "aliado_colaborador", 200));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "proveedor_ultima_milla", 200));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "medio_ultima_milla", 200));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "external_service_id", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "numero_conexion", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "numero_aprovisionamiento", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "numero_viabilidad", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "opcion_respuesta_viabilidad", 100));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "fecha_inicio_facturacion", 30));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "version", 10));
                                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "id_Aprovisionamiento", 30));
                                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                            if (item_CVI.ToBsonDocument().Contains("datos_adicionales_servicio") && !item_CVI.ToBsonDocument().GetValue("datos_adicionales_servicio").IsBsonNull && item_CVI.ToBsonDocument().GetElement("datos_adicionales_servicio").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                            {
                                                id_control_versiones = ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "_id", 30);
                                                List<BsonValue> consulta_Datos_Adicionales_Serv = item_CVI.ToBsonDocument().GetElement("datos_adicionales_servicio").Value.AsBsonArray.AsQueryable().ToList();
                                                datos_adicionales_CV += Extractor_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio(id_mongo, id_control_versiones, consulta_Datos_Adicionales_Serv);
                                            }
                                            if (item_CVI.ToBsonDocument().Contains("configuracion_servicio") && !item_CVI.ToBsonDocument().GetValue("configuracion_servicio").IsBsonNull && item_CVI.ToBsonDocument().GetElement("configuracion_servicio").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                            {
                                                id_control_versiones = ValidarDatoEnBsonValue(item_CVI.ToBsonDocument(), "_id", 30);
                                                List<BsonValue> consulta_PS_SERVICIO_CLIENTE_CS = item_CVI.ToBsonDocument().GetElement("configuracion_servicio").Value.AsBsonArray.AsQueryable().ToList();
                                                configuracion_servicio_CV += Extractor_PS_SERVICIO_CLIENTE_CV_CS(id_mongo, id_control_versiones, consulta_PS_SERVICIO_CLIENTE_CS, out valores_elementos_CV);
                                            }

                                        }
                                    }
                                }
                                catch (Exception ex)
                                {
                                    string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_CV Id: " + id_mongo);
                                    continue;
                                }
                                // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                try
                                {
                                    Conteo_PS_SERVICIO_CLIENTE_CV++;
                                    Archivo_PS_SERVICIO_CLIENTE_CV.WriteLine(sTextoDescarga_cv);
                                    Console.WriteLine("PS_SERVICIO_CLIENTE_CV ACTUALIZADA: " + itemPS_SERVICIO_CLIENTE_CV.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_CV actializadas: " + Conteo_PS_SERVICIO_CLIENTE_CV);
                                }
                                catch (Exception ex)
                                {
                                    string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_CV en mongo Id: " + id_mongo);
                                    continue;
                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_SERVICIO_CLIENTE_CV para el procesamiento de registros de mongo Id: " + id_mongo);
                                continue;
                            }
                        }

                        if (Conteo_PS_SERVICIO_CLIENTE_CV > 0)
                        {
                            Archivo_PS_SERVICIO_CLIENTE_CV.Close();
                        }
                    }
                    catch (Exception ex)
                    {
                        string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_SERVICIO_CLIENTE_CV entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_CV.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE_CV;
        }  //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE()

        internal static int Extractor_PS_SERVICIO_CLIENTE_CV_CS(string idmongo, string id_control_versiones, List<BsonValue> lista_cfg_ser, out int valores_elementos_CVI)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_CV_CS");
            }
            //Conexion a DB
            // CONTROL VERSIONES CONFIGURACION SERVICIOS
            StreamWriter Archivo_PS_SERVICIO_CLIENTE_CV_CS = null;
            int Conteo_PS_SERVICIO_CLIENTE_CV_CS = 0;
            valores_elementos_CVI = 0;
            string sTextoDescarga = "";
            string id_mongo = idmongo;
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_CV_CS = path + "PS_01_04_02_CFG_SERV_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_CV_CS = new StreamWriter(archivo_CV_CS, true, System.Text.Encoding.GetEncoding("iso-8859-1"));
                if (lista_cfg_ser.Count() >0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_CV_CS encontrados " + lista_cfg_ser.Count.ToString());
                    foreach (BsonDocument item_Configuracion_Servicio in lista_cfg_ser)
                    {
                        sTextoDescarga = "";
                        try
                        {
                            try
                            {
                                sTextoDescarga = string.Format("{0}", id_mongo);
                                sTextoDescarga += string.Format("~|{0}", id_control_versiones);
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "_id", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "fecha_creacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "usuario_creacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "fecha_actualizacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "usuario_modificacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "id_agrupador", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "nombre_agrupador", 100));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "nombre_elemento", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "cantidad", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "tipo_elemento", 100));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "inventario_etb", 200));
                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                if (item_Configuracion_Servicio.ToBsonDocument().Contains("valores_elementos_configuracion") && !item_Configuracion_Servicio.ToBsonDocument().GetValue("valores_elementos_configuracion").IsBsonNull && item_Configuracion_Servicio.ToBsonDocument().GetElement("valores_elementos_configuracion").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                {
                                    string id_coleccion = id_mongo;
                                    string configuracion_servicio = item_Configuracion_Servicio.ToBsonDocument().GetValue("_id").ToString();
                                    if (!item_Configuracion_Servicio.ToBsonDocument().GetValue("valores_elementos_configuracion").IsBsonNull)
                                    {
                                        List<BsonValue> consulta_PS_SERVICIO_CLIENTE_valores_elementos_configuracion = item_Configuracion_Servicio.ToBsonDocument().GetElement("valores_elementos_configuracion").Value.AsBsonArray.AsQueryable().ToList();
                                        valores_elementos_CVI += Extractor_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion(id_mongo, id_control_versiones, configuracion_servicio, consulta_PS_SERVICIO_CLIENTE_valores_elementos_configuracion);
                                    }
                                }

                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_CV_CS Id: " + id_mongo + "," + item_Configuracion_Servicio.ToBsonDocument().GetValue("usuario_aprobacion").ToString());
                                continue;
                            }
                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                            try
                            {
                                if (sTextoDescarga != "")
                                {
                                    Archivo_PS_SERVICIO_CLIENTE_CV_CS.WriteLine(sTextoDescarga);
                                    Conteo_PS_SERVICIO_CLIENTE_CV_CS++;
                                    Console.WriteLine("PS_SERVICIO_CLIENTE_CV_CS ACTUALIZADA: " + ValidarDatoEnBsonValue(item_Configuracion_Servicio.ToBsonDocument(), "_id", 30) + "Numero de PS_SERVICIO_CLIENTE_CV_CS actializadas: " + Conteo_PS_SERVICIO_CLIENTE_CV_CS);

                                }
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_CV_CS en mongo Id: " + id_mongo);
                                continue;
                            }
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_SERVICIO_CLIENTE_CV_CS para el procesamiento de registros de mongo Id: " + id_mongo);
                            continue;
                        }

                    }
                    if (Conteo_PS_SERVICIO_CLIENTE_CV_CS > 0)
                    {
                        Archivo_PS_SERVICIO_CLIENTE_CV_CS.Close();
                    }
                }
                
                
                
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_CV_CS.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE_CV_CS;
        } //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE_CV()

        internal static int Extractor_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion(string idmongo, string id_control_version, string configuracion_servicio, List<BsonValue> lista_valores_elementos_cfg)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion");

            }

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());
            StreamWriter Archivo_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion = null;
            int Conteo_PS_SERVICIO_CLIENTE_CV_VE = 0;
            string sTextoDescarga_CV_VE = "";
            string id_mongo = "";
            DateTime fechatemp = DateTime.Now.ToUniversalTime();

            string archivo_CV_valores_elementos_configuracion = path + "PS_01_04_03_VAL_ELEM_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";

            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion = new StreamWriter(archivo_CV_valores_elementos_configuracion, true, System.Text.Encoding.GetEncoding("iso-8859-1"));

                if (lista_valores_elementos_cfg.Count() > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion encontrados " + lista_valores_elementos_cfg.Count.ToString());
                    foreach (var item_elementos_configuracion in lista_valores_elementos_cfg)
                    {
                        try
                        {
                            sTextoDescarga_CV_VE = string.Empty;
                            sTextoDescarga_CV_VE = string.Format("{0}", idmongo);
                            sTextoDescarga_CV_VE += string.Format("~|{0}", id_control_version);
                            sTextoDescarga_CV_VE += string.Format("~|{0}", configuracion_servicio);
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "_id", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "fecha_creacion", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "usuario_creacion", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "fecha_actualizacion", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "usuario_modificacion", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "marca", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "referencia", 30));
                            sTextoDescarga_CV_VE += string.Format("~|{0}", ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "valor_asignacion", 30));
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion Id: " + id_mongo + "," + item_elementos_configuracion.ToBsonDocument().GetValue("_id").ToString());
                            continue;
                        }
                        // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                        try
                        {
                            if (sTextoDescarga_CV_VE != "")
                            {
                                Archivo_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion.WriteLine(sTextoDescarga_CV_VE);
                                Conteo_PS_SERVICIO_CLIENTE_CV_VE++;
                            }
                            Console.WriteLine("PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion ACTUALIZADA: " + ValidarDatoEnBsonValue(item_elementos_configuracion.ToBsonDocument(), "_id", 30) + "Numero de PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion actializadas: " + Conteo_PS_SERVICIO_CLIENTE_CV_VE);
                            
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion en mongo Id: " + id_mongo);
                            continue;
                        }
                    }
                    if (Conteo_PS_SERVICIO_CLIENTE_CV_VE > 0)
                    {
                        Archivo_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion.Close();
                    }
                }                
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_CV_valores_elementos_configuracion.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE_CV_VE;
        }  //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE_CV_CS()

        internal static int Extractor_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio(string idmongo, string id_control_versiones, List<BsonValue> lista_datos_adicionales_serv)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                bool IsExists = System.IO.Directory.Exists(path);
                if (!IsExists)
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en creacion del directorio del archivo PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio");
            }
            StreamWriter Archivo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio = null;
            int Conteo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio = 0;
            string sTextoDescarga_CV_datos_adicionales_servicio = string.Empty;
            string id_mongo = idmongo;
            DateTime fechatemp = DateTime.Now.ToUniversalTime();
            string archivo_CV_datos_adicionales_servicio = path + "PS_01_04_01_DAT_SERV_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt";
            try
            {
                // Se abren los archivos para poder escribirlos
                Archivo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio = new StreamWriter(archivo_CV_datos_adicionales_servicio, true, System.Text.Encoding.GetEncoding("iso-8859-1"));
                if (lista_datos_adicionales_serv.Count() > 0)
                {
                    // ESCRIBIR LOS DATOS OBTENIDOS DE LAS CONSULTAS POR REGISTRO DE PS_SERVICIO_CLIENTE_datos_adicionales_servicio 
                    Console.WriteLine("Registros en la coleccion de PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio encontrados " + lista_datos_adicionales_serv.Count.ToString());
                    foreach (BsonValue itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio in lista_datos_adicionales_serv)
                    {
                        try
                        {
                            try
                            {
                                sTextoDescarga_CV_datos_adicionales_servicio = string.Empty;
                                sTextoDescarga_CV_datos_adicionales_servicio = string.Format("{0}",id_mongo);
                                sTextoDescarga_CV_datos_adicionales_servicio += string.Format("~|{0}", id_control_versiones);
                                sTextoDescarga_CV_datos_adicionales_servicio += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "identificador", 30));
                                sTextoDescarga_CV_datos_adicionales_servicio += string.Format("~|{0}", ValidarDatoEnBsonValue(itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument(), "valor", 30));
                                sTextoDescarga_CV_datos_adicionales_servicio = sTextoDescarga_CV_datos_adicionales_servicio.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio Id: " + id_mongo + "," + itemPS_SERVICIO_CLIENTE_datos_adicionales_servicio.ToBsonDocument().ToString());
                                continue;
                            }
                            // TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                            try
                            {
                                if (sTextoDescarga_CV_datos_adicionales_servicio != "")
                                {
                                    Archivo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio.WriteLine(sTextoDescarga_CV_datos_adicionales_servicio);
                                    Console.WriteLine(sTextoDescarga_CV_datos_adicionales_servicio);
                                    Conteo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio++;
                                }
                                //Console.WriteLine("PS_SERVICIO_CLIENTE_datos_adicionales_servicio ACTUALIZADA: " + itemPS_APROVISIONAMIENTO.GetValue("_id").ToString() + "Numero de PS_SERVICIO_CLIENTE_datos_adicionales_servicio actializadas: " + Conteo_PS_APROVISIONAMIENTO_Comunicaciones);
                            }
                            catch (Exception ex)
                            {
                                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio en mongo Id: " + id_mongo);
                                continue;
                            }
                        }
                        catch (Exception ex)
                        {
                            string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Error en validacion de la bandera de actualizacion PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio para el procesamiento de registros de mongo Id: " + id_mongo);
                            continue;
                        }
                    }
                    Console.WriteLine("PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio ACTUALIZADA: " + id_control_versiones + "Numero de PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio actializadas: " + Conteo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio);
                }
                if (Conteo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio > 0)
                {
                    Archivo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio.Close();
                }
                return Conteo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio;
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString());
                //throw ex;
            }
            finally
            {
                Archivo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio.Close();
            }
            return Conteo_PS_SERVICIO_CLIENTE_CV_datos_adicionales_servicio;
        } //Se ejecuta con Extractor_PS_SERVICIO_CLIENTE()

        internal static int Extractor_PS_LISTA(string tipo = "")
        {
            DateTime fechaEjecucion = DateTime.Now;
            string path = ValidarRutaArchivos("PS_LISTA");
            string archivo_SC = string.Format("{0}PS_LISTA_{1}.txt", path, Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            string id_mongo = string.Empty;
            string sTextoDescarga_SC = string.Empty;

            int Conteo_PS_LISTA = 0;
            int ElementosLista = 0;
            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_LISTA = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

            try
            {
                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_LISTA = db.GetCollection<BsonDocument>("PS_LISTA");
                FilterDefinitionBuilder<BsonDocument> builderPS_LISTA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_LISTA = builderPS_LISTA.Empty;

                if (tipo == "")
                {
                    filterPS_LISTA = builderPS_LISTA.Or(builderPS_LISTA.Eq("Actualizacion_Extractor", "1"), !builderPS_LISTA.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_LISTA = builderPS_LISTA.And(builderPS_LISTA.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_LISTA.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_LISTA = Col_PS_LISTA.Find(filterPS_LISTA).ToList();

                if (consulta_PS_LISTA?.Count > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_LISTA encontrados " + consulta_PS_LISTA.Count.ToString());
                    try
                    {
                        foreach (BsonDocument RegistroLista in consulta_PS_LISTA)
                        {
                            id_mongo = RegistroLista.GetValue("_id").ToString();
                            sTextoDescarga_SC = string.Empty;
                            if (!string.IsNullOrEmpty(id_mongo) && (!RegistroLista.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || RegistroLista.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || (RegistroLista.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull)))
                            {
                                try
                                {
                                    sTextoDescarga_SC = ValidarDatoEnBsonValue(RegistroLista, "_id", 30);
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "fecha_creacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "usuario_creacion", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "fecha_actualizacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "usuario_modificacion", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "nombre", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "es_activo", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "id_lista_dependiente", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "descripcion", 300));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroLista, "modulo", 30));
                                    sTextoDescarga_SC = sTextoDescarga_SC.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");


                                    if (RegistroLista.Contains("elementos_lista") && !RegistroLista.GetValue("elementos_lista").IsBsonNull && RegistroLista.GetElement("elementos_lista").Value.AsBsonArray.AsQueryable().ToList().Count() > 0)
                                    {
                                        ElementosLista += Extractor_PS_LISTA_CV(id_mongo);
                                    }
                                }
                                catch (Exception ex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_LISTA Id: " + id_mongo);
                                    continue;
                                }
                                /// TERMINA DE REALIZAR LA CADENA DEL REGISTRO Y LO INCLUYE DENTRO DEL ARCHIVO, ACTUALIZA EL REGISTRO EN LA BANDERA Y ESCRIBE EN CONSOLA LO QUE SE ESTA CORRIENDO 
                                try
                                {
                                    Conteo_PS_LISTA++;
                                    Archivo_PS_LISTA.WriteLine(sTextoDescarga_SC);
                                    Col_PS_LISTA.UpdateOne(Builders<BsonDocument>.Filter.Eq("_id", ObjectId.Parse(id_mongo).ToString()), Builders<BsonDocument>.Update.Set("Actualizacion_Extractor", "0")
                                                                                                                                           .Set("Fecha_extraccion", fechaEjecucion.ToLocalTime()));
                                    Console.WriteLine("PS_LISTA ACTUALIZADA: " + RegistroLista.GetValue("_id").ToString() + "Numero de PS_LISTA actializadas: " + Conteo_PS_LISTA);
                                }
                                catch (Exception ex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error en la actualizacion de la bandera en PS_LISTA en mongo Id: " + id_mongo);
                                    continue;
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_LISTA entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                    if (Conteo_PS_LISTA > 0)
                    {
                        Archivo_PS_LISTA.Close();
                        ///PublicarArchivo.PublicarArchivoExtractores("PS_SERVICIO_CLIENTE_" + Convert.ToDateTime(fechatemp.ToLocalTime()).ToString("ddMMyyyy") + ".txt");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString());
            }
            finally
            {
                Archivo_PS_LISTA.Close();
            }
            return Conteo_PS_LISTA;
        }

        internal static int Extractor_PS_LISTA_CV(string idmongo)
        {

            string path = ValidarRutaArchivos("PS_LISTA_CV");

            int Conteo__PS_LISTA_CV = 0;
            string sTextoDescarga_cv = "";
            string id_mongo = "";
            DateTime fechaEjecucion = DateTime.Now;

            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_LISTA_CV", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));

            ///Se abren los archivos para poder escribirlos
            StreamWriter Archivo_PS_LISTA_CV = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_LISTA_CV = db.GetCollection<BsonDocument>("PS_LISTA");
            FilterDefinitionBuilder<BsonDocument> builderPS_LISTA_CV = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_LISTA_CV = builderPS_LISTA_CV.Empty;
            filterPS_LISTA_CV = builderPS_LISTA_CV.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            List<BsonDocument> Consulta_PS_LISTA_CV = Col_PS_LISTA_CV.Find(filterPS_LISTA_CV).ToList();


            if (Consulta_PS_LISTA_CV?.Count > 0)
            {
                Console.WriteLine("Registros en la coleccion de PS_LISTA_CV encontrados " + Consulta_PS_LISTA_CV.Count.ToString());
                try
                {
                    foreach (BsonDocument BsonRegistroLista in Consulta_PS_LISTA_CV)
                    {
                        id_mongo = BsonRegistroLista.GetValue("_id").ToString();
                        sTextoDescarga_cv = "";

                        List<BsonValue> ElementosLista = BsonRegistroLista.GetElement("elementos_lista").Value.AsBsonArray.ToList();
                        if (ElementosLista?.Count > 0)
                        {
                            Console.WriteLine("Registros en la coleccion de PS_LISTA_CV encontrados " + ElementosLista.Count.ToString());

                            foreach (BsonValue elementoLista in ElementosLista)
                            {
                                sTextoDescarga_cv = string.Format("{0}", id_mongo);
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(elementoLista.ToBsonDocument(), "_id", 30));
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(elementoLista.ToBsonDocument(), "valor", 30));
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(elementoLista.ToBsonDocument(), "texto", 30));
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(elementoLista.ToBsonDocument(), "valor_relacion", 30));
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(elementoLista.ToBsonDocument(), "es_activo", 30));
                                sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                                Conteo__PS_LISTA_CV++;

                                Archivo_PS_LISTA_CV.WriteLine(sTextoDescarga_cv);
                                Console.WriteLine("Registros en la coleccion de PS_LISTA_CV Registro Actualizado " + elementoLista.ToBsonDocument().GetValue("_id").ToString());
                            }
                        }

                    }
                    Archivo_PS_LISTA_CV.Close();
                }
                catch (Exception ex)
                {
                    string sNombreArchivoError = "ErrorBatch_Cargue_DWH";
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, sNombreArchivoError, ex.Message.ToString() + "Inconsistencia en PS_LISTA_CV entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                }
            }



            return Conteo__PS_LISTA_CV;
        }

        internal static int Extractor_PS_TAREA(string tipo = "")
        {
            int Conteo_PS_TAREA = 0;
            int Conteo_PS_TAREA_CV_ValidacionesParametros = 0;
            int Conteo_PS_TAREA_CV_TareasPredecesoras = 0;
            int Conteo_PS_TAREA_CV_TareasDependientes = 0;
            int Conteo_PS_TAREA_CV_CamposDinamicos = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string path = ValidarRutaArchivos("PS_TAREA");
            string archivo_SC = string.Format("{0}PS_TAREA_{1}.txt", path, Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            string id_mongo = string.Empty;
            string sTextoDescarga_SC = string.Empty;

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_TAREA = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

            try
            {
                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_TAREA = db.GetCollection<BsonDocument>("PS_TAREA");
                FilterDefinitionBuilder<BsonDocument> builderPS_TAREA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_TAREA = builderPS_TAREA.Empty;

                if (tipo == "")
                {
                    filterPS_TAREA = builderPS_TAREA.Or(builderPS_TAREA.Eq("Actualizacion_Extractor", "1"), !builderPS_TAREA.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_TAREA = builderPS_TAREA.And(builderPS_TAREA.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_TAREA.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_TAREA = Col_PS_TAREA.Find(filterPS_TAREA).ToList();

                if (consulta_PS_TAREA?.Count > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_TAREA encontrados " + consulta_PS_TAREA.Count.ToString());
                    try
                    {
                        foreach (BsonDocument RegistroTarea in consulta_PS_TAREA)
                        {
                            id_mongo = RegistroTarea.GetValue("_id").ToString();
                            sTextoDescarga_SC = string.Empty;
                            if (!string.IsNullOrEmpty(id_mongo) && (!RegistroTarea.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || RegistroTarea.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || (RegistroTarea.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull)))
                            {
                                try
                                {
                                    sTextoDescarga_SC = ValidarDatoEnBsonValue(RegistroTarea, "_id", 30);
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "fecha_creacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "usuario_creacion", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "fecha_actualizacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "usuario_modificacion", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "id_tarea", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "nombre_tarea", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "id_grupo_asignado", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "grupo_asignado", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "es_creacion_automatica", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "es_activo", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "observaciones", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "ans", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "cambia_fase", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "cambia_estado", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "elementos_cfg_servicio", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "id_cambia_fase", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTarea, "id_cambia_estado", 30));
                                    sTextoDescarga_SC = sTextoDescarga_SC.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");


                                    if (RegistroTarea.Contains("validaciones_parametros") && !RegistroTarea.GetElement("validaciones_parametros").Value.IsBsonNull)
                                    {
                                        Conteo_PS_TAREA_CV_ValidacionesParametros += Extractor_PS_TAREA_CV_Validaciones_parametros(id_mongo);
                                    }
                                    if (RegistroTarea.Contains("tareas_predecesoras") && !RegistroTarea.GetElement("tareas_predecesoras").Value.IsBsonNull)
                                    {
                                        Conteo_PS_TAREA_CV_TareasPredecesoras += Extractor_PS_TAREA_CV_TareasPredecesoras(id_mongo);
                                    }
                                    if (RegistroTarea.Contains("tareas_dependientes") && !RegistroTarea.GetElement("tareas_dependientes").Value.IsBsonNull)
                                    {
                                        Conteo_PS_TAREA_CV_TareasDependientes = Extractor_PS_TAREA_CV_TareasDependientes(id_mongo);
                                    }
                                    if (RegistroTarea.Contains("campos_dinamicos") && !RegistroTarea.GetElement("campos_dinamicos").Value.IsBsonNull)
                                    {
                                        Conteo_PS_TAREA_CV_CamposDinamicos += Extractor_PS_TAREA_CV_Campos_dinamicos(id_mongo);
                                    }

                                    Archivo_PS_TAREA.WriteLine(sTextoDescarga_SC);
                                }
                                catch (IOException Iex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(Iex, "ErrorBatch_Cargue_DWH", Iex.Message.ToString() + "Error tratando de escribir el archivo PS_TAREA Id: " + id_mongo);
                                    continue;
                                }
                                catch (Exception ex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_TAREA Id: " + id_mongo);
                                    continue;
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }

                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString());
            }
            finally
            {
                Archivo_PS_TAREA.Close();
            }


            return Conteo_PS_TAREA;
        }

        internal static int Extractor_PS_TAREA_CV_Validaciones_parametros(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_TAREA_CV_Validaciones_parametros");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_CV_validaciones_parametros = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_TAREA_CV_Validaciones_parametros", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter PS_TAREA_CV_validaciones_parametros = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_TAREA_CV_ValidacionesParametros = db.GetCollection<BsonDocument>("PS_TAREA");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_CV_ValidacionesParametros = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_CV_ValidacionesParametros = builderPS_TAREA_CV_ValidacionesParametros.Empty;
            filterPS_TAREA_CV_ValidacionesParametros = builderPS_TAREA_CV_ValidacionesParametros.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_LISTA_CV = Col_PS_TAREA_CV_ValidacionesParametros.Find(filterPS_TAREA_CV_ValidacionesParametros).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_LISTA_CV != null)
            {
                try
                {
                    List<BsonValue> ValidacionesParametros = ((Consulta_PS_LISTA_CV.Contains("validaciones_parametros") && !Consulta_PS_LISTA_CV.GetElement("validaciones_parametros").Value.IsBsonNull) ? Consulta_PS_LISTA_CV.GetElement("validaciones_parametros").Value.AsBsonArray.ToList() : null);
                    if (ValidacionesParametros?.Count > 0)
                    {
                        foreach (BsonValue ValidacionParametro in ValidacionesParametros)
                        {
                            sTextoDescarga_cv = string.Empty;
                            List<BsonValue> Valores_validacion = ((ValidacionParametro.ToBsonDocument().Contains("valor_validacion") && !ValidacionParametro.ToBsonDocument().GetElement("valor_validacion").Value.IsBsonNull) ? ValidacionParametro.ToBsonDocument().GetElement("valor_validacion").Value.AsBsonArray.ToList() : null);

                            if (Valores_validacion?.Count > 0)
                            {
                                foreach (BsonValue valor in Valores_validacion)
                                {
                                    sTextoDescarga_cv = string.Format("{0}", idmongo);
                                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(ValidacionParametro.ToBsonDocument(), "campo_validacion", 30));
                                    sTextoDescarga_cv += string.Format("~|{0}", (valor.AsString.Length > 30 ? valor.AsString.Substring(0, 29) : valor.AsString));
                                    sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    PS_TAREA_CV_validaciones_parametros.WriteLine(sTextoDescarga_cv);
                                }
                            }
                        }
                        PS_TAREA_CV_validaciones_parametros.Close();
                    }
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_CV_Validaciones_parametros entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_CV_validaciones_parametros;

        }

        internal static int Extractor_PS_TAREA_CV_TareasPredecesoras(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_TAREA_CV_TareasPredecesoras");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_CV_TareasPredecesoras = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_TAREA_CV_TareasPredecesoras", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter PS_TAREA_CV_TareasPredecesoras = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_TAREA_CV_TareasPredecesoras = db.GetCollection<BsonDocument>("PS_TAREA");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_CV_TareasPredecesoras = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_CV_TareasPredecesoras = builderPS_TAREA_CV_TareasPredecesoras.Empty;
            filterPS_TAREA_CV_TareasPredecesoras = builderPS_TAREA_CV_TareasPredecesoras.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_LISTA_CV_tareasPredecesoras = Col_PS_TAREA_CV_TareasPredecesoras.Find(filterPS_TAREA_CV_TareasPredecesoras).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_LISTA_CV_tareasPredecesoras != null)
            {
                try
                {
                    List<BsonValue> IdsTareasPredecesoras = ((Consulta_PS_LISTA_CV_tareasPredecesoras.Contains("tareas_predecesoras") && !Consulta_PS_LISTA_CV_tareasPredecesoras.GetElement("tareas_predecesoras").Value.IsBsonNull) ? Consulta_PS_LISTA_CV_tareasPredecesoras.GetElement("tareas_predecesoras").Value.AsBsonArray.ToList() : null);

                    if (IdsTareasPredecesoras != null)
                    {
                        sTextoDescarga_cv = string.Empty;
                        foreach (BsonValue idTareaPredecesora in IdsTareasPredecesoras)
                        {
                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", (idTareaPredecesora.AsString.Length > 30 ? idTareaPredecesora.AsString.Substring(0, 29) : idTareaPredecesora.AsString));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_TAREA_CV_TareasPredecesoras++;
                            PS_TAREA_CV_TareasPredecesoras.WriteLine(sTextoDescarga_cv);
                        }
                    }

                    PS_TAREA_CV_TareasPredecesoras.Close();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_CV_TareasPredecesoras entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }

            return Conteo_PS_TAREA_CV_TareasPredecesoras;
        }

        internal static int Extractor_PS_TAREA_CV_TareasDependientes(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_TAREA_CV_TareasDependientes");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_CV_TareasPredecesoras = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_TAREA_CV_TareasDependientes", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter PS_TAREA_CV_TareasPredecesoras = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_TAREA_CV_TareasPredecesoras = db.GetCollection<BsonDocument>("PS_TAREA");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_CV_TareasPredecesoras = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_CV_TareasPredecesoras = builderPS_TAREA_CV_TareasPredecesoras.Empty;
            filterPS_TAREA_CV_TareasPredecesoras = builderPS_TAREA_CV_TareasPredecesoras.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_LISTA_CV_tareasPredecesoras = Col_PS_TAREA_CV_TareasPredecesoras.Find(filterPS_TAREA_CV_TareasPredecesoras).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_LISTA_CV_tareasPredecesoras != null)
            {
                try
                {
                    List<BsonValue> IdsTareasPredecesoras = ((Consulta_PS_LISTA_CV_tareasPredecesoras.Contains("tareas_dependientes") && !Consulta_PS_LISTA_CV_tareasPredecesoras.GetElement("tareas_dependientes").Value.IsBsonNull) ? Consulta_PS_LISTA_CV_tareasPredecesoras.GetElement("tareas_dependientes").Value.AsBsonArray.ToList() : null);

                    if (IdsTareasPredecesoras != null)
                    {
                        sTextoDescarga_cv = string.Empty;
                        foreach (BsonValue idTareaPredecesora in IdsTareasPredecesoras)
                        {
                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", (idTareaPredecesora.AsString.Length > 30 ? idTareaPredecesora.AsString.Substring(0, 29) : idTareaPredecesora.AsString));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_TAREA_CV_TareasPredecesoras++;
                            PS_TAREA_CV_TareasPredecesoras.WriteLine(sTextoDescarga_cv);
                        }
                    }

                    PS_TAREA_CV_TareasPredecesoras.Close();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_CV_TareasDependientes entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_CV_TareasPredecesoras;

        }

        internal static int Extractor_PS_TAREA_CV_Campos_dinamicos(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_TAREA_CV_Campos_dinamicos");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_CV_Campos_dinamicos = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_TAREA_CV_Campos_dinamicos", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter PS_TAREA_CV_Campos_dinamicos = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_TAREA_CV_Campos_dinamicos = db.GetCollection<BsonDocument>("PS_TAREA");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_CV_Campos_dinamicos = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_CV_Campos_dinamicos = builderPS_TAREA_CV_Campos_dinamicos.Empty;
            filterPS_TAREA_CV_Campos_dinamicos = builderPS_TAREA_CV_Campos_dinamicos.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_LISTA_CV_tareasPredecesoras = Col_PS_TAREA_CV_Campos_dinamicos.Find(filterPS_TAREA_CV_Campos_dinamicos).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_LISTA_CV_tareasPredecesoras != null)
            {
                try
                {
                    List<BsonValue> CamposDinamicos = ((Consulta_PS_LISTA_CV_tareasPredecesoras.Contains("campos_dinamicos") && !Consulta_PS_LISTA_CV_tareasPredecesoras.GetElement("campos_dinamicos").Value.IsBsonNull) ? Consulta_PS_LISTA_CV_tareasPredecesoras.GetElement("campos_dinamicos").Value.AsBsonArray.ToList() : null);
                    if (CamposDinamicos != null)
                    {
                        sTextoDescarga_cv = string.Empty;
                        foreach (BsonValue campoDinamico in CamposDinamicos)
                        {
                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(campoDinamico.ToBsonDocument(), "id_campoDinamico", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(campoDinamico.ToBsonDocument(), "orden", 30));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_TAREA_CV_Campos_dinamicos++;
                            PS_TAREA_CV_Campos_dinamicos.WriteLine(sTextoDescarga_cv);
                        }
                    }
                    PS_TAREA_CV_Campos_dinamicos.Close();
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_CV_Campos_dinamicos entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_CV_Campos_dinamicos;

        }

        internal static int Extractor_PS_TAREA_SOLICITUD(string tipo = "")
        {

            int Conteo_PS_TAREA_SOLICTUD = 0;
            int Conteo_PS_TAREA_SOLICTUD_Valores_campos_dinamicos = 0;
            int Conteo_PS_TAREA_SOLICTUD_Adjuntos = 0;
            int Conteo_PS_TAREA_SOLICTUD_Historico_modificaciones = 0;
            int Conteo_PS_TAREA_SOLICTUD_comunicaciones = 0;

            DateTime fechaEjecucion = DateTime.Now;
            string path = ValidarRutaArchivos("PS_04_00_TAREAS_SOLI_");
            string archivo_SC = string.Format("{0}PS_04_00_TAREAS_SOLI_{1}.txt", path, Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            string id_mongo = string.Empty;
            string sTextoDescarga = string.Empty;

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_TAREA_SOLICTUD = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

            try
            {
                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_TAREA_SOLICTUD = db.GetCollection<BsonDocument>("PS_TAREAS_SOLICITUD");
                FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_SOLICTUD = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_TAREA_SOLICTUD = builderPS_TAREA_SOLICTUD.Empty;

                if (tipo == "")
                {
                    filterPS_TAREA_SOLICTUD = builderPS_TAREA_SOLICTUD.Or(builderPS_TAREA_SOLICTUD.Eq("Actualizacion_Extractor", "1"), !builderPS_TAREA_SOLICTUD.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_TAREA_SOLICTUD = builderPS_TAREA_SOLICTUD.And(builderPS_TAREA_SOLICTUD.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_TAREA_SOLICTUD.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_TAREA_SOLICTUD = Col_PS_TAREA_SOLICTUD.Find(filterPS_TAREA_SOLICTUD).ToList();

                if (consulta_PS_TAREA_SOLICTUD?.Count > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_TAREAS_SOLICITUD encontrados " + consulta_PS_TAREA_SOLICTUD.Count.ToString());
                    foreach (BsonDocument RegistroTareaSolicitud in consulta_PS_TAREA_SOLICTUD)
                    {
                        id_mongo = RegistroTareaSolicitud.GetValue("_id").ToString();
                        sTextoDescarga = string.Empty;
                        if (!string.IsNullOrEmpty(id_mongo) && (!RegistroTareaSolicitud.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                            || RegistroTareaSolicitud.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                            || (RegistroTareaSolicitud.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull)))
                        {
                            try
                            {
                                sTextoDescarga = string.Format("{0}", id_mongo);
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "fecha_creacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "usuario_creacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "fecha_actualizacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "usuario_modificacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "id_solicitud", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "tipo_solicitud", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "numero_solicitud", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "id_tarea", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "id_grupo_asignado", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "grupo_asignado", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "id_usuario_asignado", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "usuario_asignado", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "estado", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "id_estado", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "fecha_asignacion", 30));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "observaciones", 200));
                                sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroTareaSolicitud, "fecha_finalizacion", 30));

                                if (RegistroTareaSolicitud.Contains("valores_campos_dinamicos") && !RegistroTareaSolicitud.GetElement("valores_campos_dinamicos").Value.IsBsonNull)
                                {
                                    Conteo_PS_TAREA_SOLICTUD_Valores_campos_dinamicos = Extractor_PS_TAREA_SOLICITUD_CV_Valores_campos_dinamicos(id_mongo);
                                }
                                if (RegistroTareaSolicitud.Contains("adjuntos") && !RegistroTareaSolicitud.GetElement("adjuntos").Value.IsBsonNull)
                                {
                                    Conteo_PS_TAREA_SOLICTUD_Adjuntos = Extractor_PS_TAREA_SOLICITUD_CV_Adjuntos(id_mongo);
                                }
                                if (RegistroTareaSolicitud.Contains("historico_modificaciones") && !RegistroTareaSolicitud.GetElement("historico_modificaciones").Value.IsBsonNull)
                                {
                                    Conteo_PS_TAREA_SOLICTUD_Historico_modificaciones = Extractor_PS_TAREA_SOLICITUD_CV_Historico_modificaciones(id_mongo);
                                }
                                if (RegistroTareaSolicitud.Contains("comunicaciones") && !RegistroTareaSolicitud.GetElement("comunicaciones").Value.IsBsonNull)
                                {
                                    Conteo_PS_TAREA_SOLICTUD_comunicaciones = Extractor_PS_TAREA_SOLICITUD_CV_Comunicaciones(id_mongo);
                                }
                                sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                Archivo_PS_TAREA_SOLICTUD.WriteLine(sTextoDescarga);
                                Console.WriteLine(string.Format("Registro escrito {0} valores_campos_dinamicos :{1}, adjuntos {2},historico_modificaciones{3},comunicaciones {4}",
                                                                 id_mongo,
                                                                 Conteo_PS_TAREA_SOLICTUD_Valores_campos_dinamicos,
                                                                 Conteo_PS_TAREA_SOLICTUD_Adjuntos,
                                                                 Conteo_PS_TAREA_SOLICTUD_Historico_modificaciones,
                                                                 Conteo_PS_TAREA_SOLICTUD_comunicaciones));

                            }
                            catch (Exception ex)
                            {
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_TAREA_SOLICITUD Id: " + id_mongo);
                                continue;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString());
            }
            finally
            {
                Archivo_PS_TAREA_SOLICTUD.Close();
            }


            return Conteo_PS_TAREA_SOLICTUD;
        }

        internal static int Extractor_PS_TAREA_SOLICITUD_CV_Valores_campos_dinamicos(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_04_01_TS_VALOR_CD_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_SOLICITUD_CV_VCD = 0;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_04_01_TS_VALOR_CD_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_TAREA_SOLICITUD_CV_VCD = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            IMongoCollection<BsonDocument> Col_PS_TAREA_SOLICITUD_CV_VCD = db.GetCollection<BsonDocument>("PS_TAREAS_SOLICITUD");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_SOLICITUD_CV_VCD = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_SOLICITUD_CV_VCD = builderPS_TAREA_SOLICITUD_CV_VCD.Empty;
            filterPS_TAREA_SOLICITUD_CV_VCD = builderPS_TAREA_SOLICITUD_CV_VCD.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_TAREA_SOLICITUD_CV_VCD = Col_PS_TAREA_SOLICITUD_CV_VCD.Find(filterPS_TAREA_SOLICITUD_CV_VCD).FirstOrDefault<BsonDocument>();

            if (Consulta_PS_TAREA_SOLICITUD_CV_VCD != null)
            {
                try
                {
                    List<BsonValue> valores_campos_dinamicos = ((Consulta_PS_TAREA_SOLICITUD_CV_VCD.Contains("valores_campos_dinamicos") && !Consulta_PS_TAREA_SOLICITUD_CV_VCD.GetElement("valores_campos_dinamicos").Value.IsBsonNull) ? Consulta_PS_TAREA_SOLICITUD_CV_VCD.GetElement("valores_campos_dinamicos").Value.AsBsonArray.ToList() : null);

                    foreach (BsonValue valor_campo in valores_campos_dinamicos)
                    {

                        sTextoDescarga_cv = string.Empty;
                        sTextoDescarga_cv = string.Format("{0}", idmongo);
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "_id", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "nombre", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "tipo", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "es_respuesta", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "es_activo", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "es_inventario", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "id_lista", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "apiname", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "agrupador", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "valor", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "ValorMultiple", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(valor_campo.ToBsonDocument(), "order_visualizacion", 30));
                        sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                        Archivo_PS_TAREA_SOLICITUD_CV_VCD.WriteLine(sTextoDescarga_cv);
                        Conteo_PS_TAREA_SOLICITUD_CV_VCD++;
                    }

                    Archivo_PS_TAREA_SOLICITUD_CV_VCD.Close();
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_SOLICITUD_CV_VCD entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_SOLICITUD_CV_VCD;
        }

        internal static int Extractor_PS_TAREA_SOLICITUD_CV_Adjuntos(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_04_02_TARSO_ADJUN_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_SOLICITUD_CV_ADJUNTOS = 0;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_04_02_TARSO_ADJUN_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_TAREA_SOLICITUD_CV_ADJUNTOS = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            IMongoCollection<BsonDocument> Col_PS_TAREA_SOLICITUD_CV_ADJUNTOS = db.GetCollection<BsonDocument>("PS_TAREAS_SOLICITUD");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_SOLICITUD_CV_ADJUNTOS = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_SOLICITUD_CV_ADJUNTOS = builderPS_TAREA_SOLICITUD_CV_ADJUNTOS.Empty;
            filterPS_TAREA_SOLICITUD_CV_ADJUNTOS = builderPS_TAREA_SOLICITUD_CV_ADJUNTOS.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_TAREA_SOLICITUD_CV_ADJUNTOS = Col_PS_TAREA_SOLICITUD_CV_ADJUNTOS.Find(filterPS_TAREA_SOLICITUD_CV_ADJUNTOS).FirstOrDefault<BsonDocument>();

            if (Consulta_PS_TAREA_SOLICITUD_CV_ADJUNTOS != null)
            {
                try
                {
                    List<BsonValue> adjuntos = ((Consulta_PS_TAREA_SOLICITUD_CV_ADJUNTOS.Contains("adjuntos") && !Consulta_PS_TAREA_SOLICITUD_CV_ADJUNTOS.GetElement("adjuntos").Value.IsBsonNull) ? Consulta_PS_TAREA_SOLICITUD_CV_ADJUNTOS.GetElement("adjuntos").Value.AsBsonArray.ToList() : null);

                    foreach (BsonValue adjunto in adjuntos)
                    {
                        sTextoDescarga_cv = string.Empty;

                        sTextoDescarga_cv = string.Format("{0}", idmongo);
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "_id", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "ruta", 500));
                        //sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "tipo", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "fecha_creacion", 50));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "usuario_creacion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "id_tarea_relacionada", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "tarea_relacionada", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "es_publico", 8));
                        sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                        Archivo_PS_TAREA_SOLICITUD_CV_ADJUNTOS.WriteLine(sTextoDescarga_cv);
                        Conteo_PS_TAREA_SOLICITUD_CV_ADJUNTOS++;
                    }

                    Archivo_PS_TAREA_SOLICITUD_CV_ADJUNTOS.Close();
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_SOLICITUD_CV_ADJUNTOS entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_SOLICITUD_CV_ADJUNTOS;
        }

        internal static int Extractor_PS_TAREA_SOLICITUD_CV_Historico_modificaciones(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_04_03_HIST_MODIFI_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_SOLICITUD_CV_HM = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_04_03_HIST_MODIFI_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_TAREA_SOLICITUD_CV_HM = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_TAREA_SOLICITUD_CV_HM = db.GetCollection<BsonDocument>("PS_TAREAS_SOLICITUD");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_SOLICITUD_CV_HM = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_SOLICITUD_CV_HM = builderPS_TAREA_SOLICITUD_CV_HM.Empty;
            filterPS_TAREA_SOLICITUD_CV_HM = builderPS_TAREA_SOLICITUD_CV_HM.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_TAREA_SOLICITUD_CV_HM = Col_PS_TAREA_SOLICITUD_CV_HM.Find(filterPS_TAREA_SOLICITUD_CV_HM).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_TAREA_SOLICITUD_CV_HM != null)
            {
                try
                {
                    List<BsonValue> IdsModificaciones = ((Consulta_PS_TAREA_SOLICITUD_CV_HM.Contains("historico_modificaciones") && !Consulta_PS_TAREA_SOLICITUD_CV_HM.GetElement("historico_modificaciones").Value.IsBsonNull) ? Consulta_PS_TAREA_SOLICITUD_CV_HM.GetElement("historico_modificaciones").Value.AsBsonArray.ToList() : null);

                    if (IdsModificaciones != null)
                    {
                        foreach (BsonValue idModificacion in IdsModificaciones)
                        {
                            sTextoDescarga_cv = string.Empty;

                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", (idModificacion.AsString.Length > 30 ? idModificacion.AsString.Substring(0, 29) : idModificacion.AsString));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_TAREA_SOLICITUD_CV_HM++;
                            Archivo_PS_TAREA_SOLICITUD_CV_HM.WriteLine(sTextoDescarga_cv);
                        }
                    }

                    Archivo_PS_TAREA_SOLICITUD_CV_HM.Close();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREAS_SOLICITUD_CV_ entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_SOLICITUD_CV_HM;

        }

        internal static int Extractor_PS_TAREA_SOLICITUD_CV_Comunicaciones(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_04_04_TARSO_COMUN_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_TAREA_SOLICITUD_CV_Comunicaciones = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_04_04_TARSO_COMUN_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_TAREA_SOLICITUD_CV_Comunicaciones = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_TAREA_SOLICITUD_CV_Comunicaciones = db.GetCollection<BsonDocument>("PS_TAREAS_SOLICITUD");
            FilterDefinitionBuilder<BsonDocument> builderPS_TAREA_SOLICITUD_CV_Comunicaciones = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_TAREA_SOLICITUD_CV_Comunicaciones = builderPS_TAREA_SOLICITUD_CV_Comunicaciones.Empty;
            filterPS_TAREA_SOLICITUD_CV_Comunicaciones = builderPS_TAREA_SOLICITUD_CV_Comunicaciones.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_TAREA_SOLICITUD_CV_HM = Col_PS_TAREA_SOLICITUD_CV_Comunicaciones.Find(filterPS_TAREA_SOLICITUD_CV_Comunicaciones).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_TAREA_SOLICITUD_CV_HM != null)
            {
                try
                {
                    List<BsonValue> IdsComunicaciones = ((Consulta_PS_TAREA_SOLICITUD_CV_HM.Contains("comunicaciones") && !Consulta_PS_TAREA_SOLICITUD_CV_HM.GetElement("comunicaciones").Value.IsBsonNull) ? Consulta_PS_TAREA_SOLICITUD_CV_HM.GetElement("comunicaciones").Value.AsBsonArray.ToList() : null);

                    if (IdsComunicaciones != null)
                    {
                        sTextoDescarga_cv = string.Empty;
                        foreach (BsonValue idIdsComunicacion in IdsComunicaciones)
                        {
                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", (idIdsComunicacion.AsString.Length > 30 ? idIdsComunicacion.AsString.Substring(0, 29) : idIdsComunicacion.AsString));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_TAREA_SOLICITUD_CV_Comunicaciones++;
                            Archivo_PS_TAREA_SOLICITUD_CV_Comunicaciones.WriteLine(sTextoDescarga_cv);
                        }
                    }

                    Archivo_PS_TAREA_SOLICITUD_CV_Comunicaciones.Close();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREAS_SOLICITUD_CV_HistoricoModificaciones entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_TAREA_SOLICITUD_CV_Comunicaciones;

        }

        internal static int Extractor_PS_UNIDAD_MEDIDA(string tipo = "")
        {
            DateTime fechaEjecucion = DateTime.Now;
            string path = ValidarRutaArchivos("PS_UNIDAD_MEDIDA");
            string archivo_SC = string.Format("{0}PS_UNIDAD_MEDIDA{1}.txt", path, Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            string id_mongo = string.Empty;
            string sTextoDescarga_SC = string.Empty;

            int Conteo_PS_UNIDAD_MEDIDA = 0;

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_UNIDAD_MEDIDA = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

            try
            {
                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_UNIDAD_MEDIDA = db.GetCollection<BsonDocument>("PS_UNIDAD_MEDIDA");
                FilterDefinitionBuilder<BsonDocument> builderPS_UNIDAD_MEDIDA = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_UNIDAD_MEDIDA = builderPS_UNIDAD_MEDIDA.Empty;

                if (tipo == "")
                {
                    filterPS_UNIDAD_MEDIDA = builderPS_UNIDAD_MEDIDA.Or(builderPS_UNIDAD_MEDIDA.Eq("Actualizacion_Extractor", "1"), !builderPS_UNIDAD_MEDIDA.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_UNIDAD_MEDIDA = builderPS_UNIDAD_MEDIDA.And(builderPS_UNIDAD_MEDIDA.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_UNIDAD_MEDIDA.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_UNIDAD_MEDIDA = Col_PS_UNIDAD_MEDIDA.Find(filterPS_UNIDAD_MEDIDA).ToList();

                if (consulta_PS_UNIDAD_MEDIDA?.Count > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_UNIDAD_MEDIDA encontrados " + consulta_PS_UNIDAD_MEDIDA.Count.ToString());
                    try
                    {
                        foreach (BsonDocument RegistroUnidad in consulta_PS_UNIDAD_MEDIDA)
                        {
                            id_mongo = RegistroUnidad.GetValue("_id").ToString();
                            sTextoDescarga_SC = string.Empty;
                            if (!string.IsNullOrEmpty(id_mongo) && (!RegistroUnidad.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || RegistroUnidad.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || (RegistroUnidad.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull)))
                            {
                                try
                                {
                                    sTextoDescarga_SC = ValidarDatoEnBsonValue(RegistroUnidad, "_id", 30);
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "nombre", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "sigla", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "tipo", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "id_unidad_medida", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "factor", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "es_activo", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "fecha_creacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "usuario_creacion", 300));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "fecha_actualizacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "usuario_modificacion", 30));
                                    sTextoDescarga_SC = sTextoDescarga_SC.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    Conteo_PS_UNIDAD_MEDIDA++;
                                    Archivo_PS_UNIDAD_MEDIDA.WriteLine(sTextoDescarga_SC);
                                }
                                catch (IOException Iex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(Iex, "ErrorBatch_Cargue_DWH", Iex.Message.ToString() + "Error en la actualizacion de la bandera en PS_UNIDAD_MEDIDA en mongo Id: " + id_mongo);
                                    continue;
                                }
                                catch (Exception ex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_UNIDAD_MEDIDA Id: " + id_mongo);
                                    continue;
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_UNIDAD_MEDIDA entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString());
            }
            finally
            {
                Archivo_PS_UNIDAD_MEDIDA.Close();
            }
            return Conteo_PS_UNIDAD_MEDIDA;
        }

        internal static int Extractor_PS_USUARIO(string tipo = "")
        {
            DateTime fechaEjecucion = DateTime.Now;
            string path = ValidarRutaArchivos("PS_USUARIO");
            string archivo_SC = string.Format("{0}PS_USUARIO{1}.txt", path, Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            string id_mongo = string.Empty;
            string sTextoDescarga_SC = string.Empty;

            int Conteo_PS_USUARIO = 0;
            int Conteo_PS_USUARIO_Grupos_Lider = 0;

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_USUARIO = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

            try
            {
                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_USUARIO = db.GetCollection<BsonDocument>("PS_USUARIO");
                FilterDefinitionBuilder<BsonDocument> builderPS_USUARIO = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_USUARIO = builderPS_USUARIO.Empty;

                if (tipo == "")
                {
                    filterPS_USUARIO = builderPS_USUARIO.Or(builderPS_USUARIO.Eq("Actualizacion_Extractor", "1"), !builderPS_USUARIO.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_USUARIO = builderPS_USUARIO.And(builderPS_USUARIO.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_USUARIO.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_UNIDAD_MEDIDA = Col_PS_USUARIO.Find(filterPS_USUARIO).ToList();

                if (consulta_PS_UNIDAD_MEDIDA?.Count > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_USUARIO encontrados " + consulta_PS_UNIDAD_MEDIDA.Count.ToString());
                    try
                    {
                        foreach (BsonDocument RegistroUnidad in consulta_PS_UNIDAD_MEDIDA)
                        {
                            id_mongo = RegistroUnidad.GetValue("_id").ToString();
                            sTextoDescarga_SC = string.Empty;
                            if (!string.IsNullOrEmpty(id_mongo) && (!RegistroUnidad.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || RegistroUnidad.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || (RegistroUnidad.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull)))
                            {
                                try
                                {
                                    sTextoDescarga_SC = ValidarDatoEnBsonValue(RegistroUnidad, "_id", 30);
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "fecha_creacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "usuario_creacion", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "fecha_actualizacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "usuario_modificacion", 50));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "username", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "id_rol", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "rol", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "id_tipo_identificacion", 300));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "tipo_identificacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "identificacion", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "nombres", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "apellidos", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "id_division", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "division", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "correo_electronico", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "telefono_fijo", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "telefono_celular", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "es_activo", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "id_tipo_contrato", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "tipo_contrato", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "id_empresa", 30));
                                    sTextoDescarga_SC += string.Format("~|{0}", ValidarDatoEnBsonValue(RegistroUnidad, "empresa", 30));
                                    if (RegistroUnidad.Contains("grupos_lider") && !RegistroUnidad.GetElement("grupos_lider").Value.IsBsonNull)
                                    {
                                        Conteo_PS_USUARIO_Grupos_Lider = Extractor_PS_USUARIO_CV_Grupos_lider(id_mongo);
                                    }

                                    sTextoDescarga_SC = sTextoDescarga_SC.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    Conteo_PS_USUARIO++;
                                    Archivo_PS_USUARIO.WriteLine(sTextoDescarga_SC);
                                    Console.WriteLine(string.Format("ID Registro escrito {0} , Grupos Lider {1}", id_mongo, Conteo_PS_USUARIO_Grupos_Lider));

                                }
                                catch (IOException Iex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(Iex, "ErrorBatch_Cargue_DWH", Iex.Message.ToString() + "Error en la actualizacion de la bandera en PS_USUARIO en mongo Id: " + id_mongo);
                                    continue;
                                }
                                catch (Exception ex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_USUARIO Id: " + id_mongo);
                                    continue;
                                }
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_USUARIO entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString());
            }
            finally
            {
                Archivo_PS_USUARIO.Close();
            }
            return Conteo_PS_USUARIO;
        }

        internal static int Extractor_PS_USUARIO_CV_Grupos_lider(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_USUARIO_CV_Grupos_lider");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_USUARIO_CV_Grupos_lider = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_USUARIO_CV_Grupos_lider", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_USUARIO_CV_Grupos_lider = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_USUARIO_CV_Grupos_lider = db.GetCollection<BsonDocument>("PS_USUARIO");
            FilterDefinitionBuilder<BsonDocument> builderPS_USUARIO_CV_Grupos_lider = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_USUARIO_CV_Grupos_lider = builderPS_USUARIO_CV_Grupos_lider.Empty;
            filterPS_USUARIO_CV_Grupos_lider = builderPS_USUARIO_CV_Grupos_lider.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_TAREA_SOLICITUD_CV_HM = Col_PS_USUARIO_CV_Grupos_lider.Find(filterPS_USUARIO_CV_Grupos_lider).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_TAREA_SOLICITUD_CV_HM != null)
            {
                try
                {
                    List<BsonValue> IdsGrupos = ((Consulta_PS_TAREA_SOLICITUD_CV_HM.Contains("grupos_lider") && !Consulta_PS_TAREA_SOLICITUD_CV_HM.GetElement("grupos_lider").Value.IsBsonNull) ? Consulta_PS_TAREA_SOLICITUD_CV_HM.GetElement("grupos_lider").Value.AsBsonArray.ToList() : null);

                    if (IdsGrupos?.Count > 0)
                    {
                        foreach (BsonValue idGrupo in IdsGrupos)
                        {
                            sTextoDescarga_cv = string.Empty;

                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", (idGrupo.AsString.Length > 30 ? idGrupo.AsString.Substring(0, 29) : idGrupo.AsString));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_USUARIO_CV_Grupos_lider++;
                            Archivo_PS_USUARIO_CV_Grupos_lider.WriteLine(sTextoDescarga_cv);
                        }
                    }

                    Archivo_PS_USUARIO_CV_Grupos_lider.Close();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREAS_SOLICITUD_CV_ entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_USUARIO_CV_Grupos_lider;

        }

        internal static int Extractor_PS_VIABILIDAD(string tipo = "")
        {
            int Conteo_PS_VIABILIDAD = 0;
            int Conteo_PS_VIABILIDAD_CV_contactos = 0;
            int Conteo_PS_VIABILIDAD_CV_servicios_adicionales = 0;
            int Conteo_PS_VIABILIDAD_CV_datos_adicionales = 0;
            int Conteo_PS_VIABILIDAD_CV_comunicaciones = 0;
            int Conteo_PS_VIABILIDAD_CV_adjuntos = 0;
            int Conteo_PS_VIABILIDAD_CV_historico_estados = 0;
            int Conteo_PS_VIABILIDAD_CV_tiempos_solicitud = 0;
            int Conteo_PS_VIABILIDAD_CV_respuesta = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string path = ValidarRutaArchivos("PPS_03_00_VIABILIDAD_");
            string archivo_SC = string.Format("{0}PPS_03_00_VIABILIDAD_{1}.txt", path, Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            string id_mongo = string.Empty;
            string sTextoDescarga = string.Empty;

            //Conexion a DB
            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            StreamWriter Archivo_PS_VIABILIDAD = new StreamWriter(archivo_SC, false, System.Text.Encoding.GetEncoding("iso-8859-1"));

            try
            {
                // FILTRO PARA LAS COLECCION
                IMongoCollection<BsonDocument> Col_PS_VIABILIDAD = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
                FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD = Builders<BsonDocument>.Filter;
                FilterDefinition<BsonDocument> filterPS_VIABILIDAD = builderPS_VIABILIDAD.Empty;

                if (tipo == "")
                {
                    filterPS_VIABILIDAD = builderPS_VIABILIDAD.Or(builderPS_VIABILIDAD.Eq("Actualizacion_Extractor", "1"), !builderPS_VIABILIDAD.Exists("Actualizacion_Extractor"));
                }
                else if (tipo != "full")
                {
                    DateTime fechaconsulta = DateTime.Parse(tipo);

                    filterPS_VIABILIDAD = builderPS_VIABILIDAD.And(builderPS_VIABILIDAD.Gte("Fecha_extraccion", fechaconsulta.Date), builderPS_VIABILIDAD.Lt("Fecha_extraccion", fechaconsulta.Date.AddDays(1).AddSeconds(-1)));
                }

                List<BsonDocument> consulta_PS_VIABILIDAD = Col_PS_VIABILIDAD.Find(filterPS_VIABILIDAD).ToList();

                if (consulta_PS_VIABILIDAD?.Count > 0)
                {
                    Console.WriteLine("Registros en la coleccion de PS_VIABILIDAD encontrados " + consulta_PS_VIABILIDAD.Count.ToString());
                    try
                    {
                        foreach (BsonDocument Registro in consulta_PS_VIABILIDAD)
                        {
                            id_mongo = Registro.GetValue("_id").ToString();
                            sTextoDescarga = string.Empty;
                            if (!string.IsNullOrEmpty(id_mongo) && (!Registro.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || Registro.ToBsonDocument().Contains("Actualizacion_Extractor")
                                                                || (Registro.ToBsonDocument().GetValue("Actualizacion_Extractor").IsBsonNull)))
                            {
                                try
                                {
                                    sTextoDescarga = ValidarDatoEnBsonValue(Registro, "_id", 30);
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "fecha_creacion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "usuario_creacion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "fecha_actualizacion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "usuario_modificacion", 50));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "id_viabilidad", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "usuariocreacionsalesforce", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tipo_solicitud", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tipo_oportunidad", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "numero_oportunidad", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "nombre_oportunidad", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "numero_caso", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "indicador_agrupacion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "nombre_operacion_comercial", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "segmento", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "cuenta_cliente", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "nit", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "cliente_valor", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "asesor_comercial", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "ejecutivo_experiencia", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tipo_operacion_plan", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "nombre_producto", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "codigo_producto", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "sucursal_instalcion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "direccion_principal", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "ciudad_instalacion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tipologia_venta", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "comentarios", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "duracion_servicio_meses", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "duracion_servicio_dias", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tipo_instalacion", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "viabilidad_relacionada", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "id_usuario_asignado", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "usuario_asignado", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "id_grupo_asignado", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "grupo_asignado", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "id_fase", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "fase_actual", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "id_estado", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "estado", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "fecha_respuesta", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tiempo_ans", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "id_tipo_proceso", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "tipo_proceso", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "es_visible", 30));
                                    sTextoDescarga += string.Format("~|{0}", ValidarDatoEnBsonValue(Registro, "fecha_finalizacion", 30));
                                    sTextoDescarga = sTextoDescarga.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                    Archivo_PS_VIABILIDAD.WriteLine(sTextoDescarga);
                                    Conteo_PS_VIABILIDAD++;

                                    if (Registro.Contains("contactos") && !Registro.GetElement("contactos").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_contactos = Extractor_PS_VIABILIDAD_CV_contactos(id_mongo);
                                    }
                                    if (Registro.Contains("servicios_adicionales") && !Registro.GetElement("servicios_adicionales").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_servicios_adicionales = Extractor_PS_VIABILIDAD_CV_servicios_adicionales(id_mongo);
                                    }
                                    if (Registro.Contains("datos_adicionales_viabilidad") && !Registro.GetElement("datos_adicionales_viabilidad").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_datos_adicionales = Extractor_PS_VIABILIDAD_CV_datos_adicionales_viabilidad(id_mongo);
                                    }
                                    if (Registro.Contains("comunicaciones") && !Registro.GetElement("comunicaciones").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_comunicaciones = Extractor_PS_VIABILIDAD_CV_comunicaciones(id_mongo);
                                    }
                                    if (Registro.Contains("adjuntos") && !Registro.GetElement("adjuntos").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_adjuntos = Extractor_PS_VIABILIDAD_CV_Adjuntos(id_mongo);
                                    }
                                    if (Registro.Contains("historico_estados") && !Registro.GetElement("historico_estados").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_historico_estados = Extractor_PS_VIABILIDAD_CV_historico_estados(id_mongo);
                                    }
                                    if (Registro.Contains("tiempos_solicitud") && !Registro.GetElement("tiempos_solicitud").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_tiempos_solicitud = Extractor_PS_VIABILIDAD_CV_tiempos_solicitud(id_mongo);
                                    }
                                    if (Registro.Contains("respuesta") && !Registro.GetElement("respuesta").Value.IsBsonNull)
                                    {
                                        Conteo_PS_VIABILIDAD_CV_respuesta = Extractor_PS_VIABILIDAD_CV_respuesta(id_mongo);
                                    }

                                }
                                catch (IOException Iex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(Iex, "ErrorBatch_Cargue_DWH", Iex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD Id: " + id_mongo);
                                    continue;
                                }
                                catch (Exception ex)
                                {
                                    prcManejoErrores objError = new prcManejoErrores();
                                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia entre la validacion y el tipo de datos de PS_VIABILIDAD Id: " + id_mongo);
                                    continue;
                                }
                            }
                        }
                        Archivo_PS_VIABILIDAD.Flush();
                        Archivo_PS_VIABILIDAD.Close();
                        Archivo_PS_VIABILIDAD.Dispose();
                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD entre el modelo de datos y de registros de mongo Id: " + id_mongo);
                    }

                }

            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message.ToString());
                Console.WriteLine(ex.StackTrace.ToString());
                //Enviar a Archivo de Log Errores
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString());
            }

            Console.WriteLine("Registros en la coleccion de PS_VIABILIDAD procesados " + Conteo_PS_VIABILIDAD);
            return Conteo_PS_VIABILIDAD;
        }

        internal static int Extractor_PS_VIABILIDAD_CV_contactos(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_01_VIAB_CONTAC_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_contactos = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_01_VIAB_CONTAC_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter PS_VIABILIDAD_CV_contactos = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_contactos = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_contactos = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_contactos = builderPS_VIABILIDAD_CV_contactos.Empty;
            filterPS_VIABILIDAD_CV_contactos = builderPS_VIABILIDAD_CV_contactos.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_LISTA_CV = Col_PS_VIABILIDAD_CV_contactos.Find(filterPS_VIABILIDAD_CV_contactos).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_LISTA_CV != null)
            {
                try
                {
                    List<BsonValue> contactos = ((Consulta_PS_LISTA_CV.Contains("contactos") && !Consulta_PS_LISTA_CV.GetElement("contactos").Value.IsBsonNull) ? Consulta_PS_LISTA_CV.GetElement("contactos").Value.AsBsonArray.ToList() : null);
                    if (contactos?.Count > 0)
                    {
                        foreach (BsonValue contacto in contactos)
                        {
                            sTextoDescarga_cv = string.Empty;
                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(contacto.ToBsonDocument(), "tipo_contacto", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(contacto.ToBsonDocument(), "nombres", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(contacto.ToBsonDocument(), "apellidos", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(contacto.ToBsonDocument(), "telefono", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(contacto.ToBsonDocument(), "movil", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(contacto.ToBsonDocument(), "correo", 30));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");
                            Conteo_PS_VIABILIDAD_CV_contactos++;
                            PS_VIABILIDAD_CV_contactos.WriteLine(sTextoDescarga_cv);

                        }
                        PS_VIABILIDAD_CV_contactos.Close();
                    }
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_TAREA_CV_Validaciones_parametros entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_VIABILIDAD_CV_contactos;

        }

        internal static int Extractor_PS_VIABILIDAD_CV_servicios_adicionales(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_02_SERV_ADICIO_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_servicios_adicionales = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_02_SERV_ADICIO_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_servicios_adicionales = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_servicios_adicionales = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_servicios_adicionales = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_servicios_adicionales = builderPS_VIABILIDAD_CV_servicios_adicionales.Empty;
            filterPS_VIABILIDAD_CV_servicios_adicionales = builderPS_VIABILIDAD_CV_servicios_adicionales.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_servicios_adicionales = Col_PS_VIABILIDAD_CV_servicios_adicionales.Find(filterPS_VIABILIDAD_CV_servicios_adicionales).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_VIABILIDAD_CV_servicios_adicionales != null)
            {
                try
                {
                    List<BsonValue> servicios_adicionales = ((Consulta_PS_VIABILIDAD_CV_servicios_adicionales.Contains("servicios_adicionales") && !Consulta_PS_VIABILIDAD_CV_servicios_adicionales.GetElement("servicios_adicionales").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_servicios_adicionales.GetElement("servicios_adicionales").Value.AsBsonArray.ToList() : null);

                    if (servicios_adicionales?.Count > 0)
                    {
                        foreach (BsonValue servicio in servicios_adicionales)
                        {
                            try
                            {
                                sTextoDescarga_cv = string.Empty;

                                sTextoDescarga_cv = string.Format("{0}", idmongo);
                                sTextoDescarga_cv += string.Format("~|{0}", (servicio.AsString.Length > 30 ? servicio.AsString.Substring(0, 29) : servicio.AsString));
                                sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                Conteo_PS_VIABILIDAD_CV_servicios_adicionales++;
                                Archivo_PS_VIABILIDAD_CV_servicios_adicionales.WriteLine(sTextoDescarga_cv);
                            }
                            catch (Exception ex)
                            {
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_servicios_adicionales Id: " + idmongo);
                                continue;
                            }
                        }
                    }
                    Archivo_PS_VIABILIDAD_CV_servicios_adicionales.Flush();
                    Archivo_PS_VIABILIDAD_CV_servicios_adicionales.Close();
                    Archivo_PS_VIABILIDAD_CV_servicios_adicionales.Dispose();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_servicios_adicionales entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_VIABILIDAD_CV_servicios_adicionales;

        }

        internal static int Extractor_PS_VIABILIDAD_CV_datos_adicionales_viabilidad(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_03_DAT_ADI_VIA_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_03_DAT_ADI_VIA_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_datos_adicionales_viabilidad = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_datos_adicionales_viabilidad = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_datos_adicionales_viabilidad = builderPS_VIABILIDAD_CV_datos_adicionales_viabilidad.Empty;
            filterPS_VIABILIDAD_CV_datos_adicionales_viabilidad = builderPS_VIABILIDAD_CV_datos_adicionales_viabilidad.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_datos_adicionales_viabilidad = Col_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.Find(filterPS_VIABILIDAD_CV_datos_adicionales_viabilidad).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_VIABILIDAD_CV_datos_adicionales_viabilidad != null)
            {
                try
                {
                    List<BsonValue> datos_adicionales = ((Consulta_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.Contains("datos_adicionales_viabilidad") && !Consulta_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.GetElement("datos_adicionales_viabilidad").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.GetElement("datos_adicionales_viabilidad").Value.AsBsonArray.ToList() : null);

                    if (datos_adicionales?.Count > 0)
                    {
                        foreach (BsonValue dato in datos_adicionales)
                        {
                            try
                            {
                                sTextoDescarga_cv = string.Empty;

                                sTextoDescarga_cv = string.Format("{0}", idmongo);
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(dato.ToBsonDocument(), "identificador", 30));
                                sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(dato.ToBsonDocument(), "valor", 30));
                                sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                Conteo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad++;
                                Archivo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.WriteLine(sTextoDescarga_cv);
                            }
                            catch (Exception ex)
                            {
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_datos_adicionales_viabilidad Id: " + idmongo);
                                continue;
                            }
                        }
                    }

                    Archivo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.Flush();
                    Archivo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.Close();
                    Archivo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad.Dispose();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_servicios_adicionales entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_VIABILIDAD_CV_datos_adicionales_viabilidad;

        }

        internal static int Extractor_PS_VIABILIDAD_CV_comunicaciones(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_04_VIABI_COMUN_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_comunicaciones = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_04_VIABI_COMUN_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_comunicaciones = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_comunicaciones = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_comunicaciones = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_comunicaciones = builderPS_VIABILIDAD_CV_comunicaciones.Empty;
            filterPS_VIABILIDAD_CV_comunicaciones = builderPS_VIABILIDAD_CV_comunicaciones.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_comunicaciones = Col_PS_VIABILIDAD_CV_comunicaciones.Find(filterPS_VIABILIDAD_CV_comunicaciones).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_VIABILIDAD_CV_comunicaciones != null)
            {
                try
                {
                    List<BsonValue> servicios_adicionales = ((Consulta_PS_VIABILIDAD_CV_comunicaciones.Contains("servicios_adicionales") && !Consulta_PS_VIABILIDAD_CV_comunicaciones.GetElement("servicios_adicionales").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_comunicaciones.GetElement("servicios_adicionales").Value.AsBsonArray.ToList() : null);

                    if (servicios_adicionales?.Count > 0)
                    {
                        foreach (BsonValue servicio in servicios_adicionales)
                        {
                            try
                            {
                                sTextoDescarga_cv = string.Empty;

                                sTextoDescarga_cv = string.Format("{0}", idmongo);
                                sTextoDescarga_cv += string.Format("~|{0}", (servicio.AsString.Length > 30 ? servicio.AsString.Substring(0, 29) : servicio.AsString));
                                sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                Conteo_PS_VIABILIDAD_CV_comunicaciones++;
                                Archivo_PS_VIABILIDAD_CV_comunicaciones.WriteLine(sTextoDescarga_cv);
                            }
                            catch (Exception ex)
                            {
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_comunicaciones Id: " + idmongo);
                                continue;
                            }
                        }
                    }
                    Archivo_PS_VIABILIDAD_CV_comunicaciones.Flush();
                    Archivo_PS_VIABILIDAD_CV_comunicaciones.Close();
                    Archivo_PS_VIABILIDAD_CV_comunicaciones.Dispose();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_servicios_adicionales entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_VIABILIDAD_CV_comunicaciones;

        }

        internal static int Extractor_PS_VIABILIDAD_CV_Adjuntos(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_05_VIABI_ADJUN_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_Adjuntos = 0;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_05_VIABI_ADJUN_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_Adjuntos = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_Adjuntos = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_Adjuntos = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_Adjuntos = builderPS_VIABILIDAD_CV_Adjuntos.Empty;
            filterPS_VIABILIDAD_CV_Adjuntos = builderPS_VIABILIDAD_CV_Adjuntos.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_Adjuntos = Col_PS_VIABILIDAD_CV_Adjuntos.Find(filterPS_VIABILIDAD_CV_Adjuntos).FirstOrDefault<BsonDocument>();

            if (Consulta_PS_VIABILIDAD_CV_Adjuntos != null)
            {
                try
                {
                    List<BsonValue> adjuntos = ((Consulta_PS_VIABILIDAD_CV_Adjuntos.Contains("adjuntos") && !Consulta_PS_VIABILIDAD_CV_Adjuntos.GetElement("adjuntos").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_Adjuntos.GetElement("adjuntos").Value.AsBsonArray.ToList() : null);

                    foreach (BsonValue adjunto in adjuntos)
                    {
                        try
                        {
                            sTextoDescarga_cv = string.Empty;

                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "_id", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "ruta", 500));
                            //sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "tipo", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "fecha_creacion", 50));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "usuario_creacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "id_tarea_relacionada", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "tarea_relacionada", 100));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(adjunto.ToBsonDocument(), "es_publico", 8));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_VIABILIDAD_CV_Adjuntos++;
                            Archivo_PS_VIABILIDAD_CV_Adjuntos.WriteLine(sTextoDescarga_cv);
                        }
                        catch (Exception ex)
                        {
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_comunicaciones Id: " + idmongo);
                            continue;
                        }

                    }

                    Archivo_PS_VIABILIDAD_CV_Adjuntos.Flush();
                    Archivo_PS_VIABILIDAD_CV_Adjuntos.Close();
                    Archivo_PS_VIABILIDAD_CV_Adjuntos.Dispose();
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_Adjuntos entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }

            return Conteo_PS_VIABILIDAD_CV_Adjuntos;
        }

        internal static int Extractor_PS_VIABILIDAD_CV_historico_estados(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_06_HIST_ESTADO_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_historico_estados = 0;
            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_06_HIST_ESTADO_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_historico_estados = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            /// FILTRO PARA LAS COLECCION
            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_historico_estados = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_historico_estados = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_comunicaciones = builderPS_VIABILIDAD_CV_historico_estados.Empty;
            filterPS_VIABILIDAD_CV_comunicaciones = builderPS_VIABILIDAD_CV_historico_estados.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_comunicaciones = Col_PS_VIABILIDAD_CV_historico_estados.Find(filterPS_VIABILIDAD_CV_comunicaciones).FirstOrDefault<BsonDocument>();
            if (Consulta_PS_VIABILIDAD_CV_comunicaciones != null)
            {
                try
                {
                    List<BsonValue> servicios_adicionales = ((Consulta_PS_VIABILIDAD_CV_comunicaciones.Contains("historico_estados") && !Consulta_PS_VIABILIDAD_CV_comunicaciones.GetElement("historico_estados").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_comunicaciones.GetElement("historico_estados").Value.AsBsonArray.ToList() : null);

                    if (servicios_adicionales?.Count > 0)
                    {
                        foreach (BsonValue servicio in servicios_adicionales)
                        {
                            try
                            {
                                sTextoDescarga_cv = string.Empty;

                                sTextoDescarga_cv = string.Format("{0}", idmongo);
                                sTextoDescarga_cv += string.Format("~|{0}", (servicio.AsString.Length > 30 ? servicio.AsString.Substring(0, 29) : servicio.AsString));
                                sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                                Conteo_PS_VIABILIDAD_CV_historico_estados++;
                                Archivo_PS_VIABILIDAD_CV_historico_estados.WriteLine(sTextoDescarga_cv);
                            }
                            catch (Exception ex)
                            {
                                prcManejoErrores objError = new prcManejoErrores();
                                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_historico_estados Id: " + idmongo);
                                continue;
                            }
                        }
                    }
                    Archivo_PS_VIABILIDAD_CV_historico_estados.Flush();
                    Archivo_PS_VIABILIDAD_CV_historico_estados.Close();
                    Archivo_PS_VIABILIDAD_CV_historico_estados.Dispose();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_historico_estados entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }


            return Conteo_PS_VIABILIDAD_CV_historico_estados;

        }

        internal static int Extractor_PS_VIABILIDAD_CV_tiempos_solicitud(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_07_VIABI_TIEMS_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_tiempos_solicitud = 0;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_07_VIABI_TIEMS_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_tiempos_solicitud = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_tiempos_solicitud = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_tiempos_solicitud = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_tiempos_solicitud = builderPS_VIABILIDAD_CV_tiempos_solicitud.Empty;
            filterPS_VIABILIDAD_CV_tiempos_solicitud = builderPS_VIABILIDAD_CV_tiempos_solicitud.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_Adjuntos = Col_PS_VIABILIDAD_CV_tiempos_solicitud.Find(filterPS_VIABILIDAD_CV_tiempos_solicitud).FirstOrDefault<BsonDocument>();

            if (Consulta_PS_VIABILIDAD_CV_Adjuntos != null)
            {
                try
                {
                    List<BsonValue> tiempos = ((Consulta_PS_VIABILIDAD_CV_Adjuntos.Contains("tiempos_solicitud") && !Consulta_PS_VIABILIDAD_CV_Adjuntos.GetElement("tiempos_solicitud").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_Adjuntos.GetElement("tiempos_solicitud").Value.AsBsonArray.ToList() : null);

                    foreach (BsonValue tiempo in tiempos)
                    {
                        try
                        {
                            sTextoDescarga_cv = string.Empty;

                            sTextoDescarga_cv = string.Format("{0}", idmongo);
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "_id", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "fecha_creacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "usuario_creacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "fecha_actualizacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "usuario_modificacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "nombre", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "descripcion", 80));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "es_activo", 8));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "color", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "fechainicio", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "Fechafin", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "tiempoTranscurrido", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(tiempo.ToBsonDocument(), "en_ejecucion", 8));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Conteo_PS_VIABILIDAD_CV_tiempos_solicitud++;
                            Archivo_PS_VIABILIDAD_CV_tiempos_solicitud.WriteLine(sTextoDescarga_cv);
                        }
                        catch (Exception ex)
                        {
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_tiempos_solicitud Id: " + idmongo);
                            continue;
                        }

                    }
                    Archivo_PS_VIABILIDAD_CV_tiempos_solicitud.Flush();
                    Archivo_PS_VIABILIDAD_CV_tiempos_solicitud.Close();
                    Archivo_PS_VIABILIDAD_CV_tiempos_solicitud.Dispose();

                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_tiempos_solicitud entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }

            return Conteo_PS_VIABILIDAD_CV_tiempos_solicitud;
        }

        internal static int Extractor_PS_VIABILIDAD_CV_respuesta(string idmongo)
        {
            string path = ValidarRutaArchivos("PS_03_08_VIABIL_RESP_");
            string sTextoDescarga_cv = string.Empty;
            int Conteo_PS_VIABILIDAD_CV_respuesta = 0;
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones = 0;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_08_VIABIL_RESP_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_respuesta = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            MongoClient client = new MongoClient(ConfigurationManager.ConnectionStrings["ConexionMongo"].ToString());
            IMongoDatabase db = client.GetDatabase(ConfigurationManager.AppSettings["BaseDatosMongo"].ToString());

            IMongoCollection<BsonDocument> Col_PS_VIABILIDAD_CV_respuesta = db.GetCollection<BsonDocument>("PS_VIABILIDAD");
            FilterDefinitionBuilder<BsonDocument> builderPS_VIABILIDAD_CV_respuesta = Builders<BsonDocument>.Filter;
            FilterDefinition<BsonDocument> filterPS_VIABILIDAD_CV_respuesta = builderPS_VIABILIDAD_CV_respuesta.Empty;
            filterPS_VIABILIDAD_CV_respuesta = builderPS_VIABILIDAD_CV_respuesta.Eq("_id", MongoDB.Bson.ObjectId.Parse(idmongo));

            BsonDocument Consulta_PS_VIABILIDAD_CV_respuesta = Col_PS_VIABILIDAD_CV_respuesta.Find(filterPS_VIABILIDAD_CV_respuesta).FirstOrDefault<BsonDocument>();

            if (Consulta_PS_VIABILIDAD_CV_respuesta != null)
            {
                try
                {
                    BsonDocument respuesta = ((Consulta_PS_VIABILIDAD_CV_respuesta.Contains("respuesta") && !Consulta_PS_VIABILIDAD_CV_respuesta.GetElement("respuesta").Value.IsBsonNull) ? Consulta_PS_VIABILIDAD_CV_respuesta.GetElement("respuesta").Value.AsBsonDocument : null);


                    sTextoDescarga_cv = string.Empty;

                    sTextoDescarga_cv = string.Format("{0}", idmongo);
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "fecha_creacion", 30));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "usuario_creacion", 30));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "fecha_actualizacion", 30));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "usuario_modificacion", 30));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "id_respuesta_viabilidad", 30));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "respuesta_viabilidad", 80));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "id_causal_respuesta_viabilidad", 30));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "causal_respuesta_viabilidad", 200));
                    sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(respuesta, "respuesta_comercial", 200));

                    if (respuesta.ToBsonDocument().Contains("opciones") && respuesta.GetElement("opciones").Value.AsBsonArray.Count > 0)
                    {
                        Conteo_PS_VIABILIDAD_CV_respuesta_opciones = Extractor_PS_VIABILIDAD_CV_respuesta_opciones(idmongo, respuesta.GetElement("opciones").Value.AsBsonArray.ToList());
                    }

                    sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                    Conteo_PS_VIABILIDAD_CV_respuesta++;
                    Archivo_PS_VIABILIDAD_CV_respuesta.WriteLine(sTextoDescarga_cv);

                    Archivo_PS_VIABILIDAD_CV_respuesta.Flush();
                    Archivo_PS_VIABILIDAD_CV_respuesta.Close();
                }
                catch (Exception ex)
                {
                    prcManejoErrores objError = new prcManejoErrores();
                    objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Inconsistencia en PS_VIABILIDAD_CV_respuesta entre el modelo de datos y de registros de mongo Id: " + idmongo);
                }
            }

            return Conteo_PS_VIABILIDAD_CV_respuesta;
        }

        internal static int Extractor_PS_VIABILIDAD_CV_respuesta_opciones(string idmongo, List<BsonValue> listaOpciones)
        {
            string path = ValidarRutaArchivos("PS_03_08_01_VIAB_ROP_");
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones = 0;
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones_detalle = 0;
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones_configuracion_servicio = 0;
            string sTextoDescarga_cv = string.Empty;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_08_01_VIAB_ROP_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_respuesta_opciones = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            if (listaOpciones?.Count > 0)
            {
                Console.WriteLine(string.Format("ID Registro {0} Cantidad de registros encontrados en respuesta_opciones {1}", idmongo, listaOpciones.Count));
                foreach (BsonValue opcion in listaOpciones)
                {
                    try
                    {
                        sTextoDescarga_cv = string.Empty;
                        sTextoDescarga_cv += string.Format("{0}", idmongo);
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "_id", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "fecha_creacion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "usuario_creacion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "fecha_actualizacion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "usuario_modificacion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "nombre_opcion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "observaciones", 200));
                        sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                        Archivo_PS_VIABILIDAD_CV_respuesta_opciones.WriteLine(sTextoDescarga_cv);
                        Conteo_PS_VIABILIDAD_CV_respuesta_opciones++;
                        if (opcion.ToBsonDocument().Contains("configuracion_servicio") && !opcion.ToBsonDocument().GetElement("configuracion_servicio").Value.IsBsonNull)
                        {
                            Conteo_PS_VIABILIDAD_CV_respuesta_opciones_configuracion_servicio = Extractor_PS_VIABILIDAD_CV_respuesta_opciones_CS(idmongo, ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "_id", 30), opcion.ToBsonDocument().GetElement("configuracion_servicio").Value.AsBsonArray.ToList());
                        }
                        if (opcion.ToBsonDocument().Contains("detalle_opcion") && !opcion.ToBsonDocument().GetElement("detalle_opcion").Value.IsBsonNull)
                        {
                            Conteo_PS_VIABILIDAD_CV_respuesta_opciones_detalle = Extractor_PS_VIABILIDAD_CV_respuesta_opciones_detalles(ValidarDatoEnBsonValue(opcion.ToBsonDocument(), "_id", 30), opcion.ToBsonDocument().GetElement("detalle_opcion").Value.AsBsonArray.ToList());
                        }

                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_respuesta_opciones Id: " + idmongo);
                        continue;
                    }

                }
                Archivo_PS_VIABILIDAD_CV_respuesta_opciones.Flush();
                Archivo_PS_VIABILIDAD_CV_respuesta_opciones.Close();
            }


            return Conteo_PS_VIABILIDAD_CV_respuesta_opciones;
        }

        internal static int Extractor_PS_VIABILIDAD_CV_respuesta_opciones_CS(string idmonogoRegistro, string idmongoOpcion, List<BsonValue> listaConfiguracionServicios)
        {
            string path = ValidarRutaArchivos("PS_03_08_01_01_CFGSE_");
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS = 0;
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC = 0;

            string sTextoDescarga_cv = string.Empty;

            try
            {
                DateTime fechaEjecucion = DateTime.Now;
                string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_08_01_01_CFGSE_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
                StreamWriter Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

                if (listaConfiguracionServicios?.Count > 0)
                {
                    Console.WriteLine(string.Format("ID {0} Registro respuesta {1} Cantidad de registros encontrados en respuesta_opciones_consiguracion_servicio {2}", idmonogoRegistro, idmongoOpcion, listaConfiguracionServicios.Count));
                    foreach (BsonDocument servicio in listaConfiguracionServicios)
                    {
                        try
                        {

                            sTextoDescarga_cv = string.Empty;
                            sTextoDescarga_cv += string.Format("{0}", idmongoOpcion);
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "_id", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "fecha_creacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "usuario_creacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "fecha_actualizacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "usuario_modificacion", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "id_agrupador", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "nombre_agrupador", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "nombre_elemento", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "cantidad", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "tipo_elemento", 30));
                            sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(servicio, "inventario_etb", 8));
                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS.WriteLine(sTextoDescarga_cv);
                            Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS++;

                            if (servicio.Contains("valores_elementos_configuracion") && !servicio.GetElement("valores_elementos_configuracion").Value.IsBsonNull)
                            {
                                Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC = Extractor_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC(idmonogoRegistro, idmongoOpcion, ValidarDatoEnBsonValue(servicio, "_id", 30), servicio.GetElement("valores_elementos_configuracion").Value.AsBsonArray.ToList());
                            }
                        }
                        catch (Exception ex)
                        {
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_respuesta_opciones_CS Id: " + idmonogoRegistro);
                            continue;
                        }
                        
                    }
                    
                }
                
                Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS.Flush();
                Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS.Close();
            }
            catch (Exception ex)
            {
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_respuesta_opciones_CS Id: " + idmonogoRegistro + "Opcion :" + idmongoOpcion);
            }
            

            return Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS;
        }

        internal static int Extractor_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC(string idmonogoRegistro, string idmongoOpcion, string idmongoCS, List<BsonValue> listaConfiguracionServicios_VEC)
        {

            string path = ValidarRutaArchivos("PS_03_08_01_01_01_VE_");
            int Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC = 0;

            string sTextoDescarga_cv = string.Empty;

            try
            {
                DateTime fechaEjecucion = DateTime.Now;
                string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_08_01_01_01_VE_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
                StreamWriter Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

                if (listaConfiguracionServicios_VEC?.Count > 0)
                {
                    Console.WriteLine(string.Format("ID Registro respuesta {0} Cantidad de registros encontrados en respuesta_opciones_consiguracion_servicio_VEC {1}", idmongoOpcion, listaConfiguracionServicios_VEC.Count));
                    foreach (BsonDocument servicio_VEC in listaConfiguracionServicios_VEC)
                    {
                        try
                        {
                            sTextoDescarga_cv = string.Empty;
                            sTextoDescarga_cv = string.Format("{0}", idmonogoRegistro);
                            sTextoDescarga_cv = string.Format("~|{0}", idmongoOpcion);
                            sTextoDescarga_cv = string.Format("~|{0}", idmongoCS);
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "_id", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "fecha_creacion", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "usuario_creacion", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "fecha_actualizacion", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "usuario_modificacion", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "id_Inventario", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "marca", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "referencia", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "valor_asignacion", 30));
                            sTextoDescarga_cv = string.Format("~|{0}", ValidarDatoEnBsonValue(servicio_VEC, "en_aprovacion", 8));

                            sTextoDescarga_cv = sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");

                            Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC.WriteLine(sTextoDescarga_cv);
                            Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC++;
                        }
                        catch (Exception ex)
                        {
                            prcManejoErrores objError = new prcManejoErrores();
                            objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC Id Registro :" + idmonogoRegistro + "ID Opcion : " + idmongoOpcion + " ID CS : " + idmongoCS);
                            continue;
                        }
                        finally
                        {
                            Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC.Flush();
                            Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC.Close();
                        }
                    }
                    Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC.Flush();
                    Archivo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC.Close();
                }

            }
            catch (Exception ex)
            {

                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC Id: " + idmonogoRegistro);
            }
            
            return Conteo_PS_VIABILIDAD_CV_respuesta_opciones_CS_VEC;

        }

        internal static int Extractor_PS_VIABILIDAD_CV_respuesta_opciones_detalles(string idmongoOpcion, List<BsonValue> listaDetalles)
        {
            string path = ValidarRutaArchivos("PS_03_08_02_DET_OPCI_");
            int Conteo_PS_VIABILIDAD_CV_respuesta_OD = 0;

            string sTextoDescarga_cv = string.Empty;

            DateTime fechaEjecucion = DateTime.Now;
            string archivo_CV = string.Format("{0}{1}{2}.txt", path, "PS_03_08_02_DET_OPCI_", Convert.ToDateTime(fechaEjecucion.ToLocalTime()).ToString("ddMMyyyy"));
            StreamWriter Archivo_PS_VIABILIDAD_CV_respuesta_opciones = new StreamWriter(archivo_CV, true, Encoding.GetEncoding("iso-8859-1"));

            if (listaDetalles?.Count > 0)
            {
                Console.WriteLine(string.Format("ID Registro respuesta {0} Cantidad de registros encontrados en respuesta_detalles {1}", idmongoOpcion, listaDetalles.Count));
                foreach (BsonValue detalle in listaDetalles)
                {
                    try
                    {
                        sTextoDescarga_cv = string.Empty;
                        sTextoDescarga_cv += string.Format("{0}", idmongoOpcion);
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "_id", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "nombre", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "tipo", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "es_respuesta", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "es_activo", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "es_inventario", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "id_lista", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "apiname", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "agrupador", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "valor", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "ValorMultiple", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "orden_visualizacion", 30));
                        sTextoDescarga_cv += string.Format("~|{0}", ValidarDatoEnBsonValue(detalle.ToBsonDocument(), "fila_registro", 30));
                        sTextoDescarga_cv += sTextoDescarga_cv.Replace("\n", " ").Replace("\r", " ").Replace("\t", " ").Replace("\v", " ").Replace("\tCL", " ");


                        Archivo_PS_VIABILIDAD_CV_respuesta_opciones.WriteLine(sTextoDescarga_cv);
                        Conteo_PS_VIABILIDAD_CV_respuesta_OD++;
                    }
                    catch (Exception ex)
                    {
                        prcManejoErrores objError = new prcManejoErrores();
                        objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + "Error tratando de escribir el archivo PS_VIABILIDAD_CV_respuesta_OD Id opcion: " + idmongoOpcion);
                        continue;
                    }

                }
                Archivo_PS_VIABILIDAD_CV_respuesta_opciones.Flush();
                Archivo_PS_VIABILIDAD_CV_respuesta_opciones.Close();
            }


            return Conteo_PS_VIABILIDAD_CV_respuesta_OD;
        }

        private static string ValidarDatoEnBsonValue(BsonDocument Objeto, string nombreCampo, int logitudCampo)
        {
            if (Objeto.Contains(nombreCampo))
            {

                if (!Objeto.GetValue(nombreCampo).IsBsonNull && Objeto.GetValue(nombreCampo).IsValidDateTime)
                {
                    DateTime fecha = Objeto.GetValue(nombreCampo).ToUniversalTime();
                    return fecha.ToLocalTime().ToString("dd/MM/yyyy hh:mm:ss tt", new System.Globalization.CultureInfo("en-US"));
                }

                return (Objeto.GetValue(nombreCampo).IsBsonNull) ? string.Empty : (Objeto.GetValue(nombreCampo).ToString().Length > logitudCampo ? Objeto.GetValue(nombreCampo).ToString().Substring(0, (logitudCampo - 1)) : Objeto.GetValue(nombreCampo).ToString());
            }
            else
            {
                return "";
            }

        }

        private static string ValidarRutaArchivos(string Archivo)
        {
            string path = ConfigurationManager.AppSettings["RutaArchivosExtractores"];
            try
            {
                if (!Directory.Exists(path))
                    System.IO.Directory.CreateDirectory(path);
            }
            catch (Exception ex)
            {
                prcManejoErrores objError = new prcManejoErrores();
                objError.ErroresGeneral(ex, "ErrorBatch_Cargue_DWH", ex.Message.ToString() + string.Format("Error en creacion del directorio del archivo {0}", Archivo));
            }

            return path;
        }
    }
}
